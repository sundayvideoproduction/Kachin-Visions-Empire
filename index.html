<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ff9900">
    <title>K VE - Kachin Visions Empire</title>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- CryptoJS for Encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        /* Input fields ·Äô·Äª·Ä¨·Ä∏·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ user-select ·Äï·Äº·Äî·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫ */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        body {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow-x: hidden;
            background: linear-gradient(135deg, #050510, #0a0a1a, #1a0f0a);
            color: #f0f8ff;
            font-size: 12px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            touch-action: pan-y pan-x;
            overscroll-behavior: none;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Android ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ scroll ·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ */
        .scrollable {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
            touch-action: pan-y;
            overscroll-behavior: contain;
            will-change: transform;
            height: 100%;
            /* Scroll ·Äî·Ä≤·Ä∑ tap ·ÄÄ·Ä≠·ÄØ ·ÄÅ·ÄΩ·Ä≤·ÄÅ·Äº·Ä¨·Ä∏·Äõ·Äî·Ä∫ */
            scroll-behavior: smooth;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            padding-bottom: 60px;
            min-height: 100vh;
            overflow-y: visible;
        }

        .screen {
            display: none;
            min-height: 100vh;
            animation: fadeIn 0.3s ease;
            overflow-y: visible;
            position: relative;
        }

        .active {
            display: block;
        }

        /* Password Status Indicator */
        .password-indicator {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 10px;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid rgba(0, 255, 0, 0.3);
            backdrop-filter: blur(5px);
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            touch-action: manipulation;
            pointer-events: auto;
        }

        .password-indicator.locked {
            background: rgba(255, 0, 0, 0.2);
            color: #ff3e3e;
            border-color: rgba(255, 0, 0, 0.3);
        }

        /* Stories Menu */
        .stories-menu-container {
            position: fixed;
            top: 15px;
            left: 160px;
            z-index: 1000;
        }

        .stories-toggle-btn {
            background: rgba(255, 153, 0, 0.2);
            border: 1px solid rgba(255, 153, 0, 0.3);
            color: #ff9900;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .stories-toggle-btn:active {
            transform: scale(0.95);
            background: rgba(255, 153, 0, 0.3);
        }

        .stories-menu {
            position: absolute;
            top: 50px;
            left: 0;
            background: rgba(15, 20, 40, 0.95);
            border: 1px solid rgba(255, 153, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            min-width: 150px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            backdrop-filter: blur(10px);
            z-index: 1000;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
        }

        .stories-menu.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .story-item {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .story-item:active {
            transform: scale(0.98);
            background: rgba(255, 153, 0, 0.2);
        }

        .story-item.active {
            background: rgba(255, 153, 0, 0.3);
            color: #ff9900;
        }

        /* Logo Container */
        .logo-container {
            text-align: center;
            margin-bottom: 15px;
            padding-top: 70px;
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            color: #ff9900;
            text-shadow: 0 0 10px rgba(255, 153, 0, 0.5);
            margin-bottom: 5px;
        }

        .logo-sub {
            font-size: 9px;
            color: #8a93a7;
        }

        /* Password Section */
        .password-section {
            background: rgba(15, 20, 40, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid rgba(255, 153, 0, 0.3);
            padding: 15px;
            max-width: 350px;
            margin: 0 auto 20px;
            text-align: center;
            overflow: hidden;
            transition: all 0.3s ease;
            width: 12px;
            height: 8px;
            position: relative;
            cursor: pointer;
            touch-action: manipulation;
        }

        .password-section.expanded {
            width: 100%;
            height: auto;
            min-height: 200px;
        }

        .password-section-title {
            font-size: 12px;
            color: #ff9900;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .password-section.expanded .password-section-title,
        .password-section:hover .password-section-title {
            opacity: 1;
        }

        .password-input-group {
            position: relative;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .password-section.expanded .password-input-group,
        .password-section:hover .password-input-group {
            opacity: 1;
        }

        .password-input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 153, 0, 0.3);
            background: rgba(10, 10, 26, 0.8);
            color: #f0f8ff;
            font-size: 11px;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
            outline: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            touch-action: manipulation;
        }

        .password-input:focus {
            border-color: #ff9900;
            box-shadow: 0 0 0 2px rgba(255, 153, 0, 0.2);
        }

        .password-toggle-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #8a93a7;
            cursor: pointer;
            font-size: 12px;
            padding: 5px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .unlock-btn {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: #ff9900;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            opacity: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .password-section.expanded .unlock-btn,
        .password-section:hover .unlock-btn {
            opacity: 1;
        }

        .unlock-btn:active {
            transform: scale(0.98);
            background: #e68900;
        }

        .password-status {
            font-size: 10px;
            text-align: center;
            color: #8a93a7;
            min-height: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .password-section.expanded .password-status,
        .password-section:hover .password-status {
            opacity: 1;
        }

        .device-info {
            font-size: 9px;
            color: #ff9900;
            margin-top: 10px;
            padding: 6px;
            background: rgba(255, 153, 0, 0.1);
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .password-section.expanded .device-info,
        .password-section:hover .device-info {
            opacity: 1;
        }

        /* Lock Icon for collapsed state */
        .password-section::before {
            content: 'üîí';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .password-section.expanded::before,
        .password-section:hover::before {
            opacity: 0;
        }

        /* Video Section */
        .video-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        @media (min-width: 768px) {
            .video-section {
                flex-direction: row;
            }
        }

        /* Video Player Container */
        .video-player-container {
            flex: 2;
            background: rgba(15, 20, 40, 0.9);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 153, 0, 0.3);
            aspect-ratio: 16/9;
            position: relative;
            touch-action: manipulation;
        }

        .video-player {
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .video-player video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        .fullscreen-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            font-size: 18px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .fullscreen-btn:active {
            transform: scale(0.9);
            background: rgba(0, 0, 0, 0.9);
        }

        .default-image {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            overflow: hidden;
            touch-action: manipulation;
        }

        .default-image img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 5px;
            pointer-events: none;
        }

        /* Video List Container */
        .video-list-container {
            flex: 1;
            background: rgba(15, 20, 40, 0.9);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 153, 0, 0.3);
            max-height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .video-list-title {
            font-size: 12px;
            margin-bottom: 10px;
            color: #ff9900;
            text-align: center;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            touch-action: manipulation;
        }

        .video-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-right: 5px;
            touch-action: pan-y;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
            will-change: transform;
            height: 100%;
            /* Scroll ·Äî·Ä≤·Ä∑ tap ·ÄÄ·Ä≠·ÄØ ·ÄÅ·ÄΩ·Ä≤·ÄÅ·Äº·Ä¨·Ä∏·Äõ·Äî·Ä∫ */
            position: relative;
        }

        /* Android ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ scroll ·Äï·Ä≠·ÄØ·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ */
        .video-list::-webkit-scrollbar {
            width: 6px;
        }

        .video-list::-webkit-scrollbar-thumb {
            background: #ff9900;
            border-radius: 10px;
        }

        .video-list::-webkit-scrollbar-track {
            background: rgba(255, 153, 0, 0.1);
            border-radius: 10px;
        }

        /* Video Item Styles - Scroll ·Äî·Ä≤·Ä∑ Tap ·ÄÅ·ÄΩ·Ä≤·ÄÅ·Äº·Ä¨·Ä∏·Äõ·Äî·Ä∫ */
        .video-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            /* Scroll ·Äú·ÄØ·Äï·Ä∫·Äî·Ä±·ÄÖ·Äâ·Ä∫ tap ·ÄÄ·Ä≠·ÄØ ·ÄÄ·Ä¨·ÄÄ·ÄΩ·Äö·Ä∫·Äõ·Äî·Ä∫ */
            pointer-events: auto;
            position: relative;
        }

        /* Scroll ·Äú·ÄØ·Äï·Ä∫·Äî·Ä±·ÄÖ·Äâ·Ä∫ video item ·ÄÄ·Ä≠·ÄØ disable ·Äú·ÄØ·Äï·Ä∫·Äõ·Äî·Ä∫ */
        .video-list.scrolling .video-item {
            pointer-events: none;
        }

        .video-list.scrolling .video-item .video-actions button {
            pointer-events: none;
        }

        .video-item:active {
            transform: scale(0.98);
            background: rgba(255, 153, 0, 0.1);
        }

        /* Locked video - red color */
        .video-item.locked {
            background: rgba(255, 0, 0, 0.1);
            border-left-color: #ff3e3e;
            opacity: 0.7;
        }

        /* Unlocked video - bright green color */
        .video-item.unlocked {
            background: rgba(0, 255, 0, 0.15) !important;
            border-left-color: #00ff00 !important;
            border: 1px solid rgba(0, 255, 0, 0.3) !important;
        }

        .video-item.unlocked .video-name {
            color: #00ff00 !important;
            font-weight: bold;
        }

        .video-item.unlocked .video-meta {
            color: #90ff90 !important;
        }

        .video-item.free {
            background: rgba(0, 204, 136, 0.1);
            border-left-color: #00cc88;
        }

        .video-item.playing {
            background: rgba(255, 153, 0, 0.2);
            border-left-color: #ff9900;
        }

        .video-info {
            flex: 1;
            min-width: 0;
        }

        .video-name {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 3px;
            color: #f0f8ff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-meta {
            font-size: 9px;
            color: #8a93a7;
        }

        .video-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .action-btn:active {
            transform: scale(0.9);
        }

        .action-btn.play {
            background: #ff9900;
            color: white;
        }

        .free-badge {
            background: #00cc88;
            color: #000;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 8px;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            background: rgba(15, 20, 40, 0.9);
            color: #f0f8ff;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 153, 0, 0.2);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 36px;
        }

        .nav-btn:active {
            transform: scale(0.95);
            background: rgba(255, 153, 0, 0.1);
        }

        /* Back Button */
        .back-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: rgba(255, 62, 62, 0.2);
            color: #ff3e3e;
            border: 1px solid rgba(255, 62, 62, 0.3);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .back-btn:active {
            transform: scale(0.95);
            background: rgba(255, 62, 62, 0.3);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 15px;
            right: 15px;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 9px;
            background: rgba(0, 204, 136, 0.2);
            color: #00cc88;
            border: 1px solid rgba(0, 204, 136, 0.3);
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 1000;
        }

        .connection-status.offline {
            background: rgba(255, 62, 62, 0.2);
            color: #ff3e3e;
            border-color: rgba(255, 62, 62, 0.3);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 153, 0, 0.3);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            max-width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
            animation: slideUp 0.3s ease;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            gap: 15px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 153, 0, 0.3);
            border-radius: 50%;
            border-top-color: #ff9900;
            animation: spin 1s linear infinite;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 4000;
            justify-content: center;
            align-items: center;
            padding: 15px;
            backdrop-filter: blur(5px);
            touch-action: manipulation;
        }

        .modal-content {
            background: #0a0a1a;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 153, 0, 0.3);
            max-width: 350px;
            width: 100%;
            animation: modalSlideIn 0.3s ease;
        }

        .modal-title {
            font-size: 12px;
            margin-bottom: 12px;
            color: #ff9900;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .modal-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: none;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .modal-btn:active {
            transform: scale(0.98);
        }

        .modal-btn.primary {
            background: #ff9900;
            color: white;
        }

        .modal-btn.secondary {
            background: rgba(255, 153, 0, 0.2);
            color: #ff9900;
            border: 1px solid rgba(255, 153, 0, 0.3);
        }

        .modal-btn.danger {
            background: #ff3e3e;
            color: white;
        }

        /* Device Info Display */
        .device-info-display {
            position: fixed;
            top: 15px;
            right: 170px;
            background: rgba(255, 153, 0, 0.1);
            color: #ff9900;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 9px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid rgba(255, 153, 0, 0.2);
            backdrop-filter: blur(5px);
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Preloading Progress */
        .preload-progress-container {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 20, 40, 0.95);
            border: 1px solid rgba(255, 153, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            min-width: 250px;
            max-width: 90%;
            z-index: 2000;
            display: none;
            backdrop-filter: blur(10px);
        }

        .preload-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 11px;
            color: #ff9900;
        }

        .preload-progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 153, 0, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .preload-progress-fill {
            height: 100%;
            background: #ff9900;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .preload-progress-text {
            font-size: 10px;
            color: #8a93a7;
            text-align: center;
        }

        .preload-progress-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .preload-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 153, 0, 0.1);
            font-size: 10px;
        }

        .preload-item:last-child {
            border-bottom: none;
        }

        .preload-item-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }

        .preload-item-progress {
            width: 60px;
            height: 3px;
            background: rgba(255, 153, 0, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .preload-item-progress-fill {
            height: 100%;
            background: #ff9900;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .preload-item-percent {
            min-width: 30px;
            text-align: right;
            font-size: 9px;
            color: #ff9900;
        }

        /* Video Quality Selector */
        .quality-selector {
            position: absolute;
            bottom: 60px;
            left: 10px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            display: none;
            flex-direction: column;
            gap: 3px;
        }
        
        .quality-btn {
            background: rgba(255, 153, 0, 0.2);
            color: white;
            border: 1px solid rgba(255, 153, 0, 0.3);
            padding: 4px 8px;
            margin: 0;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            text-align: center;
        }
        
        .quality-btn.active {
            background: #ff9900;
        }
        
        /* Buffering Indicator */
        .buffering-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            color: white;
            font-size: 12px;
            display: none;
            z-index: 50;
            align-items: center;
            gap: 8px;
        }

        /* Storage Info */
        .storage-info {
            position: fixed;
            bottom: 15px;
            left: 15px;
            background: rgba(255, 153, 0, 0.1);
            color: #ff9900;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 9px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid rgba(255, 153, 0, 0.2);
            backdrop-filter: blur(5px);
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Storage Location Display */
        .storage-location {
            position: fixed;
            bottom: 50px;
            left: 15px;
            right: 15px;
            background: rgba(255, 153, 0, 0.1);
            color: #ff9900;
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 9px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid rgba(255, 153, 0, 0.2);
            backdrop-filter: blur(5px);
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            max-width: calc(100% - 30px);
        }

        /* Storage Selection Modal */
        .storage-selection {
            position: absolute;
            bottom: 60px;
            left: 15px;
            background: rgba(15, 20, 40, 0.95);
            border: 1px solid rgba(255, 153, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            min-width: 200px;
            max-width: 300px;
            display: none;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .storage-selection.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .storage-option {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .storage-option:hover {
            background: rgba(255, 153, 0, 0.2);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translateY(-10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Android ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ extra styles */
        @media (max-width: 768px) {
            body {
                font-size: 11px;
            }
            
            .password-section {
                max-width: 100%;
            }
            
            .video-section {
                flex-direction: column;
            }
            
            .video-list-container {
                max-height: 60vh;
                min-height: 300px;
            }
            
            .video-list {
                height: 100%;
                flex-grow: 1;
            }
            
            .stories-menu-container {
                left: 130px;
            }
            
            .device-info-display {
                right: 130px;
            }
            
            .storage-location {
                font-size: 8px;
                padding: 5px 8px;
            }
        }

        /* For very small screens */
        @media (max-width: 480px) {
            .password-section.expanded {
                min-height: 180px;
            }
            
            .video-list-container {
                max-height: 50vh;
                min-height: 250px;
            }
            
            .nav-buttons {
                gap: 5px;
            }
            
            .nav-btn {
                padding: 6px 10px;
                font-size: 10px;
                min-height: 32px;
            }
            
            .stories-menu-container {
                left: 100px;
            }
            
            .device-info-display {
                right: 100px;
                max-width: 120px;
            }
        }

        /* Prevent video auto-play on scroll */
        .video-player video:not([playing]) {
            pointer-events: none;
        }

        /* Improve button feedback */
        button:active {
            opacity: 0.8;
        }

        /* Sorting dropdown styles */
        .sort-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(15, 20, 40, 0.95);
            border: 1px solid rgba(255, 153, 0, 0.3);
            border-radius: 6px;
            padding: 8px;
            z-index: 1000;
            min-width: 180px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .sort-option {
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .sort-option:hover {
            background: rgba(255, 153, 0, 0.1);
        }

        /* Android touch scroll improvements */
        .android-optimized .video-list {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            scrollbar-width: thin;
        }

        /* Prevent iOS bounce */
        .no-bounce {
            overscroll-behavior: none;
        }

        /* Scroll detection indicator */
        .scroll-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
    </style>
</head>
<body>
    <!-- Password Status Indicator -->
    <div class="password-indicator locked" id="passwordIndicator">
        <i class="fas fa-lock"></i> <span>Locked</span>
    </div>

    <!-- Device Info Display -->
    <div class="device-info-display" id="deviceInfoDisplay" style="display: none;">
        <i class="fas fa-mobile-alt"></i> <span id="deviceIdShort">Device</span>
    </div>

    <!-- Storage Info -->
    <div class="storage-info" id="storageInfo" style="display: none;">
        <i class="fas fa-hdd"></i> <span id="storageText">0 MB used</span>
    </div>

    <!-- Storage Location Display -->
    <div class="storage-location" id="storageLocation" style="display: none;">
        <i class="fas fa-folder"></i> <span id="locationPath">Select storage location</span>
    </div>

    <!-- Stories Menu -->
    <div class="stories-menu-container">
        <div class="stories-toggle-btn" id="storiesToggle">
            <i class="fas fa-film"></i>
        </div>
        <div class="stories-menu" id="storiesMenu">
            <div class="story-list" id="storyList"></div>
        </div>
    </div>

    <!-- Storage Selection -->
    <div class="storage-selection" id="storageSelection">
        <div class="storage-option" data-storage="default">
            <i class="fas fa-database"></i> Default App Storage
        </div>
        <div class="storage-option" data-storage="local">
            <i class="fas fa-mobile-alt"></i> Local Device Storage
        </div>
        <div class="storage-option" data-storage="sd">
            <i class="fas fa-sd-card"></i> SD Card (if available)
        </div>
        <div class="storage-option" data-storage="custom">
            <i class="fas fa-folder-open"></i> Select Custom Location
        </div>
    </div>

    <!-- Preloading Progress -->
    <div class="preload-progress-container" id="preloadProgress">
        <div class="preload-progress-header">
            <span>Preloading Videos</span>
            <button class="action-btn" id="closePreloadProgress" style="width: 20px; height: 20px; background: transparent; color: #ff9900;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="preload-progress-bar">
            <div class="preload-progress-fill" id="preloadProgressFill" style="width: 0%;"></div>
        </div>
        <div class="preload-progress-text" id="preloadProgressText">Starting...</div>
        <div class="preload-progress-list" id="preloadProgressList"></div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText" style="font-size: 12px;">Loading...</div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-wifi"></i> Online
    </div>

    <!-- Main Screen -->
    <div id="screen1" class="screen active">
        <div class="container">
            <!-- Back Button -->
            <button class="back-btn" id="backButton" style="display: none;">
                <i class="fas fa-arrow-left"></i> Back
            </button>

            <!-- Logo -->
            <div class="logo-container">
                <div class="logo">K VE</div>
                <div class="logo-sub">Kachin Visions Empire - Secure Video Platform</div>
            </div>

            <!-- Password Section -->
            <div class="password-section" id="passwordSection">
                <div class="password-section-title">
                    <i class="fas fa-lock"></i> Device-Locked Access
                </div>
                <div class="password-input-group">
                    <input type="password" class="password-input" id="passwordInput" 
                           placeholder="Enter your access password" autocomplete="off">
                    <button class="password-toggle-btn" id="passwordToggle">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <button class="unlock-btn" id="unlockBtn">
                    <i class="fas fa-unlock"></i> Unlock Videos
                </button>
                <div class="password-status" id="passwordStatus">
                    Each password works on one device only
                </div>
                <div class="device-info" id="deviceInfo">
                    <i class="fas fa-fingerprint"></i> Device ID: Loading...
                </div>
            </div>

            <!-- Video Section -->
            <div class="video-section">
                <div class="video-player-container">
                    <div class="video-player">
                        <!-- Buffering Indicator -->
                        <div class="buffering-indicator" id="bufferingIndicator">
                            <i class="fas fa-spinner fa-spin"></i> Buffering...
                        </div>
                        
                        <!-- Quality Selector -->
                        <div class="quality-selector" id="qualitySelector">
                            <button class="quality-btn" data-quality="auto">Auto</button>
                            <button class="quality-btn" data-quality="360p">360p</button>
                            <button class="quality-btn" data-quality="480p">480p</button>
                        </div>
                        
                        <button class="fullscreen-btn" id="fullscreenBtn" style="display: none;">
                            <i class="fas fa-expand"></i>
                        </button>
                        <div class="default-image" id="defaultImage">
                            <img src="https://res.cloudinary.com/zaumaran/image/upload/v1764932924/Kachin_Vision_Empire_For_Logo_zpkdbg.png" 
                                 alt="K VE" id="appImage" style="display: none;">
                            <div style="text-align: center; color: #ff9900; padding: 20px;">
                                <i class="fas fa-play-circle" style="font-size: 40px; margin-bottom: 10px;"></i>
                                <div style="font-size: 12px;">Enter password to unlock videos</div>
                            </div>
                        </div>
                        <video id="videoPlayer" controls playsinline 
                               controlsList="nodownload noremoteplayback" preload="metadata"
                               style="display: none;"></video>
                    </div>
                </div>

                <div class="video-list-container">
                    <div class="video-list-title">
                        <i class="fas fa-film"></i> Video Library
                    </div>
                    <div class="video-list scrollable" id="videoList"></div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <button class="nav-btn" id="contactBtn">
                    <i class="fas fa-link"></i> Contact Links
                </button>
                <button class="nav-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="nav-btn" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <button class="nav-btn" id="preloadBtn">
                    <i class="fas fa-download"></i> Preload
                </button>
                <button class="nav-btn" id="optimizeBtn">
                    <i class="fas fa-tools"></i> Optimize
                </button>
                <button class="nav-btn" id="storageBtn">
                    <i class="fas fa-hdd"></i> Storage
                </button>
            </div>
        </div>
    </div>

    <!-- Contact Links Screen -->
    <div id="screen2" class="screen">
        <div class="container">
            <button class="back-btn" id="backToMain">
                <i class="fas fa-arrow-left"></i> Back
            </button>

            <div class="logo-container">
                <div class="logo">Contact Links</div>
                <div class="logo-sub">Available Links</div>
            </div>

            <div class="video-list-container">
                <div class="video-list-title">
                    <i class="fas fa-link"></i> Available Links
                </div>
                <div class="video-list scrollable" id="contactList"></div>
            </div>
        </div>
    </div>

    <!-- Video Password Modal -->
    <div class="modal" id="videoPasswordModal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-lock"></i> Video Password Required
            </div>
            <div style="margin-bottom: 15px; font-size: 11px; text-align: center;">
                This video requires a password to access.
            </div>
            <div class="password-input-group" style="margin-bottom: 15px;">
                <input type="password" class="password-input" id="videoPassword" 
                       placeholder="Enter video password">
                <button class="password-toggle-btn" id="videoPasswordToggle">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div id="videoPasswordStatus" style="font-size: 10px; text-align: center; margin: 10px 0; color: #ff3e3e; min-height: 14px;"></div>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="submitVideoPassword">
                    <i class="fas fa-unlock"></i> Unlock
                </button>
                <button class="modal-btn secondary" id="cancelVideoPassword">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- No Internet Modal -->
    <div class="modal" id="noInternetModal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-wifi-slash"></i> No Internet Connection
            </div>
            <div style="margin-bottom: 15px; font-size: 11px; text-align: center;">
                Internet connection is required to use this application.
                Please check your connection and try again.
            </div>
            <button class="modal-btn primary" id="retryConnectionBtn">
                <i class="fas fa-redo"></i> Retry
            </button>
        </div>
    </div>

    <!-- Password Reset Confirmation Modal -->
    <div class="modal" id="passwordResetModal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-exclamation-triangle"></i> Password Reset Required
            </div>
            <div style="margin-bottom: 15px; font-size: 11px; text-align: center;">
                This password has been reset by admin or is being used on another device.
                Please enter a new password to continue.
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="confirmPasswordReset">
                    <i class="fas fa-key"></i> Enter New Password
                </button>
            </div>
        </div>
    </div>

    <!-- Storage Selection Modal -->
    <div class="modal" id="storageModal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-hdd"></i> Select Storage Location
            </div>
            <div style="margin-bottom: 15px; font-size: 11px; text-align: center;">
                Choose where to save preloaded videos:
            </div>
            <div class="modal-buttons" style="flex-direction: column;">
                <button class="modal-btn secondary" id="selectDefaultStorage">
                    <i class="fas fa-database"></i> Default App Storage
                </button>
                <button class="modal-btn secondary" id="selectLocalStorage">
                    <i class="fas fa-mobile-alt"></i> Local Device Storage
                </button>
                <button class="modal-btn secondary" id="selectSDCard" style="display: none;">
                    <i class="fas fa-sd-card"></i> SD Card Storage
                </button>
                <button class="modal-btn secondary" id="selectCustomStorage">
                    <i class="fas fa-folder-open"></i> Choose Custom Folder
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            APP_ID: 'kve_video_platform_v5.0',
            ENCRYPTION_KEY: 'KVE_Secure_Device_Locked_Password_System_2024',
            DEVICE_ID_KEY: 'kve_secure_device_id',
            PASSWORD_STORAGE_KEY: 'kve_device_password_data',
            VIDEO_CACHE_KEY: 'kve_video_cache',
            STORAGE_LOCATION_KEY: 'kve_storage_location',
            CACHE_EXPIRY_DAYS: 3,
            CUSTOM_IMAGE_URL: 'https://res.cloudinary.com/zaumaran/image/upload/v1764932924/Kachin_Vision_Empire_For_Logo_zpkdbg.png'
        };

        const firebaseConfig = {
            apiKey: "AIzaSyCJGR8dXeawpg6RNpF1iUC7TD65RWm-oxE",
            authDomain: "sun-day-video-production-298c8.firebaseapp.com",
            projectId: "sun-day-video-production-298c8",
            storageBucket: "sun-day-video-production-298c8.firebasestorage.app",
            messagingSenderId: "927333523323",
            appId: "1:927333523323:web:16375e95732c5acb4767de",
            measurementId: "G-ZY2Y2Y749H"
        };

        // ==================== APP STATE ====================
        let videos = [];
        let stories = [];
        let contactLinks = [];
        let passwords = [];
        let unlockedVideos = new Set();
        let currentStory = null;
        let isOnline = true;
        let currentVideoToUnlock = null;
        let deviceId = null;
        let devicePasswordData = null;
        let isPasswordVisible = false;
        let isVideoPasswordVisible = false;
        let passwordSectionHoverTimer = null;
        let passwordSectionExpanded = false;
        
        // Video optimization state
        let networkQuality = 'good';
        let currentQuality = 'auto';
        let videoBufferSize = 0;
        let isBuffering = false;
        let bufferingTimeout = null;
        let lastPlayTime = 0;
        
        // Preloading state
        let isPreloading = false;
        let preloadedVideos = new Set();
        let preloadQueue = [];
        let preloadProgress = {};
        let cachedVideos = {};
        
        // Storage state
        let storageLocation = 'default';
        let storagePath = '';
        let storageFolder = 'KVE_Videos';
        let isStorageInitialized = false;

        // Sorting state
        let currentSortMode = 'name_asc'; // Default: Sort by name A-Z

        // Scroll and touch state (·Ä°·Äõ·Ä±·Ä∏·ÄÄ·Äº·ÄÆ·Ä∏: Scroll ·Äî·Ä≤·Ä∑ Tap ·ÄÄ·Ä≠·ÄØ ·ÄÅ·ÄΩ·Ä≤·ÄÅ·Äº·Ä¨·Ä∏·Äõ·Äî·Ä∫)
        let isScrolling = false;
        let scrollTimeout = null;
        let touchStartTime = 0;
        let touchStartY = 0;
        let touchStartX = 0;
        let isTouchMove = false;
        const SCROLL_THRESHOLD = 10; // pixels
        const TAP_THRESHOLD = 200; // milliseconds

        // ==================== DOM ELEMENTS ====================
        const screens = document.querySelectorAll('.screen');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const connectionStatus = document.getElementById('connectionStatus');
        const toast = document.getElementById('toast');
        const passwordIndicator = document.getElementById('passwordIndicator');
        const deviceInfoDisplay = document.getElementById('deviceInfoDisplay');
        const deviceIdShort = document.getElementById('deviceIdShort');
        const deviceInfo = document.getElementById('deviceInfo');
        const storageInfo = document.getElementById('storageInfo');
        const storageText = document.getElementById('storageText');
        const storageLocationEl = document.getElementById('storageLocation');
        const locationPath = document.getElementById('locationPath');
        const storageSelection = document.getElementById('storageSelection');
        
        // Stories menu
        const storiesToggle = document.getElementById('storiesToggle');
        const storiesMenu = document.getElementById('storiesMenu');
        const storyList = document.getElementById('storyList');
        
        // Password section
        const passwordSection = document.getElementById('passwordSection');
        const passwordInput = document.getElementById('passwordInput');
        const passwordToggle = document.getElementById('passwordToggle');
        const unlockBtn = document.getElementById('unlockBtn');
        const passwordStatus = document.getElementById('passwordStatus');
        
        // Video elements
        const videoPlayer = document.getElementById('videoPlayer');
        const defaultImage = document.getElementById('defaultImage');
        const appImage = document.getElementById('appImage');
        const videoList = document.getElementById('videoList');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const bufferingIndicator = document.getElementById('bufferingIndicator');
        const qualitySelector = document.getElementById('qualitySelector');
        const qualityButtons = document.querySelectorAll('.quality-btn');
        
        // Preloading elements
        const preloadProgressEl = document.getElementById('preloadProgress');
        const preloadProgressFill = document.getElementById('preloadProgressFill');
        const preloadProgressText = document.getElementById('preloadProgressText');
        const preloadProgressList = document.getElementById('preloadProgressList');
        const closePreloadProgress = document.getElementById('closePreloadProgress');
        const preloadBtn = document.getElementById('preloadBtn');
        
        // Navigation
        const contactBtn = document.getElementById('contactBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const optimizeBtn = document.getElementById('optimizeBtn');
        const storageBtn = document.getElementById('storageBtn');
        const backButton = document.getElementById('backButton');
        const backToMain = document.getElementById('backToMain');
        
        // Modals
        const videoPasswordModal = document.getElementById('videoPasswordModal');
        const videoPassword = document.getElementById('videoPassword');
        const videoPasswordToggle = document.getElementById('videoPasswordToggle');
        const submitVideoPassword = document.getElementById('submitVideoPassword');
        const cancelVideoPassword = document.getElementById('cancelVideoPassword');
        const videoPasswordStatus = document.getElementById('videoPasswordStatus');
        const noInternetModal = document.getElementById('noInternetModal');
        const retryConnectionBtn = document.getElementById('retryConnectionBtn');
        const passwordResetModal = document.getElementById('passwordResetModal');
        const confirmPasswordReset = document.getElementById('confirmPasswordReset');
        const storageModal = document.getElementById('storageModal');
        
        // Storage buttons
        const selectDefaultStorage = document.getElementById('selectDefaultStorage');
        const selectLocalStorage = document.getElementById('selectLocalStorage');
        const selectSDCard = document.getElementById('selectSDCard');
        const selectCustomStorage = document.getElementById('selectCustomStorage');
        
        // Lists
        const contactList = document.getElementById('contactList');

        // ==================== SCROLL AND TOUCH HANDLING ====================
        // ·Ä°·Äõ·Ä±·Ä∏·ÄÄ·Äº·ÄÆ·Ä∏: Scroll ·Äî·Ä≤·Ä∑ Tap ·ÄÄ·Ä≠·ÄØ ·ÄÅ·ÄΩ·Ä≤·ÄÅ·Äº·Ä¨·Ä∏·Äõ·Äî·Ä∫ Function
        function setupScrollAndTouchHandling() {
            if (!videoList) return;
            
            // Touch start event - ·Äò·Äö·Ä∫·Äî·Ä±·Äõ·Ä¨·ÄÄ·Ä≠·ÄØ ·ÄÖ·Äî·Äæ·Ä≠·Äï·Ä∫·Äû·Äú·Ä≤
            videoList.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                touchStartY = e.touches[0].clientY;
                touchStartX = e.touches[0].clientX;
                isTouchMove = false;
                
                // Scroll ·Äú·ÄØ·Äï·Ä∫·Äî·Ä±·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏ ·Ä°·Äô·Äæ·Äê·Ä∫·Ä°·Äû·Ä¨·Ä∏·Äï·Äº·ÄØ
                this.classList.add('scrolling');
                isScrolling = true;
                
                // Scroll timeout ·ÄÄ·Ä≠·ÄØ ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                
                // Scroll ·Äõ·Äï·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äõ·ÄÑ·Ä∫ ·Äï·Äº·Äî·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äõ·Äî·Ä∫
                scrollTimeout = setTimeout(function() {
                    videoList.classList.remove('scrolling');
                    isScrolling = false;
                }, 100);
            }, { passive: true });
            
            // Touch move event - ·Äõ·ÄΩ·Ä±·Ä∑·Äú·Äª·Ä¨·Ä∏·Äî·Ä±·Äú·Ä¨·Ä∏
            videoList.addEventListener('touchmove', function(e) {
                const currentY = e.touches[0].clientY;
                const currentX = e.touches[0].clientX;
                
                // Scroll ·Äú·ÄØ·Äï·Ä∫·Äî·Ä±·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏ ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏
                const deltaY = Math.abs(currentY - touchStartY);
                const deltaX = Math.abs(currentX - touchStartX);
                
                if (deltaY > SCROLL_THRESHOLD || deltaX > SCROLL_THRESHOLD) {
                    isTouchMove = true;
                    isScrolling = true;
                    this.classList.add('scrolling');
                    
                    // Scroll timeout ·ÄÄ·Ä≠·ÄØ ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏
                    if (scrollTimeout) {
                        clearTimeout(scrollTimeout);
                    }
                    
                    // Scroll ·Äõ·Äï·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äõ·ÄÑ·Ä∫ ·Äï·Äº·Äî·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äõ·Äî·Ä∫
                    scrollTimeout = setTimeout(function() {
                        videoList.classList.remove('scrolling');
                        isScrolling = false;
                    }, 150);
                }
            }, { passive: true });
            
            // Touch end event - Tap ·Äú·Ä¨·Ä∏ Scroll ·Äú·Ä¨·Ä∏
            videoList.addEventListener('touchend', function(e) {
                const touchEndTime = Date.now();
                const touchDuration = touchEndTime - touchStartTime;
                
                // Scroll timeout ·ÄÄ·Ä≠·ÄØ ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                
                // Scroll ·Äõ·Äï·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äõ·ÄÑ·Ä∫ ·Äï·Äº·Äî·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äõ·Äî·Ä∫
                scrollTimeout = setTimeout(function() {
                    videoList.classList.remove('scrolling');
                    isScrolling = false;
                }, 100);
                
                // Scroll ·Äú·ÄØ·Äï·Ä∫·Äî·Ä±·Äõ·ÄÑ·Ä∫ tap ·ÄÄ·Ä≠·ÄØ ignore ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
                if (isTouchMove || isScrolling) {
                    e.preventDefault();
                    return;
                }
                
                // Tap duration ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏
                if (touchDuration > TAP_THRESHOLD) {
                    return; // Long press, ignore
                }
                
                // ·Äò·Äö·Ä∫ video item ·ÄÄ·Ä≠·ÄØ ·Äî·Äæ·Ä≠·Äï·Ä∫·Äû·Äú·Ä≤ ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏
                const target = e.target;
                const videoItem = target.closest('.video-item');
                
                if (videoItem && !videoItem.classList.contains('scrolling')) {
                    // ·Äî·Äæ·Ä≠·Äï·Ä∫·Äê·Ä≤·Ä∑ element ·ÄÄ play button ·Äú·Ä¨·Ä∏ ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏
                    const playButton = target.closest('.action-btn.play');
                    
                    if (playButton) {
                        // Play button ·ÄÄ·Ä≠·ÄØ ·Äû·ÄÆ·Ä∏·Äû·Äî·Ä∑·Ä∫·Äî·Äæ·Ä≠·Äï·Ä∫·Äê·Ä¨
                        e.preventDefault();
                        e.stopPropagation();
                        handlePlayButtonClick(videoItem, playButton);
                    } else {
                        // Video item ·ÄÄ·Ä≠·ÄØ ·Äî·Äæ·Ä≠·Äï·Ä∫·Äê·Ä¨
                        e.preventDefault();
                        e.stopPropagation();
                        handleVideoItemClick(videoItem);
                    }
                }
            }, { passive: false });
            
            // Click event ·ÄÄ·Ä≠·ÄØ·Äú·Ää·Ä∫·Ä∏ handle ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
            videoList.addEventListener('click', function(e) {
                if (isScrolling) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                
                const target = e.target;
                const videoItem = target.closest('.video-item');
                
                if (videoItem) {
                    const playButton = target.closest('.action-btn.play');
                    
                    if (playButton) {
                        e.preventDefault();
                        e.stopPropagation();
                        handlePlayButtonClick(videoItem, playButton);
                    } else if (!target.closest('.video-actions')) {
                        e.preventDefault();
                        e.stopPropagation();
                        handleVideoItemClick(videoItem);
                    }
                }
            });
            
            // Scroll event listener
            videoList.addEventListener('scroll', function() {
                isScrolling = true;
                this.classList.add('scrolling');
                
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                
                scrollTimeout = setTimeout(function() {
                    videoList.classList.remove('scrolling');
                    isScrolling = false;
                }, 150);
            });
        }

        // Play button click handler
        function handlePlayButtonClick(videoItem, playButton) {
            if (isScrolling) return;
            
            const videoId = playButton.getAttribute('data-id');
            const video = videos.find(v => v.id === videoId);
            
            if (!video) return;
            
            const isFree = video.passwordType === 'free';
            const isUnlocked = isFree || unlockedVideos.has(video.id) || 
                             (video.storyName && unlockedVideos.has(video.storyName));
            
            if (!isUnlocked) {
                if (video.passwordType === 'password') {
                    currentVideoToUnlock = video;
                    showVideoPasswordModal();
                } else {
                    showToast('Password required', 'error');
                }
            } else {
                playVideo(video);
            }
        }

        // Video item click handler
        function handleVideoItemClick(videoItem) {
            if (isScrolling) return;
            
            // Video item ·Äë·Ä≤·Äô·Äæ·Ä¨ play button ·ÄÄ·Ä≠·ÄØ ·Äõ·Äæ·Ä¨·Äô·Äö·Ä∫
            const playButton = videoItem.querySelector('.action-btn.play');
            if (playButton) {
                handlePlayButtonClick(videoItem, playButton);
            }
        }

        // ==================== SORTING FUNCTIONS ====================
        function sortVideosByNameAsc(a, b) {
            return a.name.localeCompare(b.name);
        }

        function sortVideosByNameDesc(a, b) {
            return b.name.localeCompare(a.name);
        }

        function sortVideosByStoryAsc(a, b) {
            if (a.storyName && b.storyName) {
                return a.storyName.localeCompare(b.storyName);
            }
            return a.name.localeCompare(b.name);
        }

        function sortVideosByStoryDesc(a, b) {
            if (a.storyName && b.storyName) {
                return b.storyName.localeCompare(a.storyName);
            }
            return b.name.localeCompare(a.name);
        }

        function extractStoryNumber(storyName) {
            if (!storyName) return 0;
            const match = storyName.match(/\d+/);
            return match ? parseInt(match[0]) : 0;
        }

        function sortVideosByStoryNumberAsc(a, b) {
            const numA = extractStoryNumber(a.storyName);
            const numB = extractStoryNumber(b.storyName);
            return numA - numB;
        }

        function sortVideosByStoryNumberDesc(a, b) {
            const numA = extractStoryNumber(a.storyName);
            const numB = extractStoryNumber(b.storyName);
            return numB - numA;
        }

        function applySorting(videosArray) {
            const sortedVideos = [...videosArray];
            
            switch(currentSortMode) {
                case 'name_asc':
                    sortedVideos.sort(sortVideosByNameAsc);
                    break;
                case 'name_desc':
                    sortedVideos.sort(sortVideosByNameDesc);
                    break;
                case 'story_asc':
                    sortedVideos.sort(sortVideosByStoryAsc);
                    break;
                case 'story_desc':
                    sortedVideos.sort(sortVideosByStoryDesc);
                    break;
                case 'story_number_asc':
                    sortedVideos.sort(sortVideosByStoryNumberAsc);
                    break;
                case 'story_number_desc':
                    sortedVideos.sort(sortVideosByStoryNumberDesc);
                    break;
                default:
                    sortedVideos.sort(sortVideosByNameAsc);
            }
            
            return sortedVideos;
        }

        function addSortingUI() {
            const videoListTitle = document.querySelector('.video-list-title');
            
            // Create sorting dropdown
            const sortContainer = document.createElement('div');
            sortContainer.className = 'sort-container';
            sortContainer.style.position = 'relative';
            sortContainer.style.display = 'inline-block';
            sortContainer.style.marginLeft = '10px';
            
            // Sort button
            const sortButton = document.createElement('button');
            sortButton.className = 'sort-button';
            sortButton.innerHTML = '<i class="fas fa-sort"></i> Sort';
            sortButton.style.background = 'rgba(255, 153, 0, 0.2)';
            sortButton.style.color = '#ff9900';
            sortButton.style.border = '1px solid rgba(255, 153, 0, 0.3)';
            sortButton.style.padding = '4px 8px';
            sortButton.style.borderRadius = '4px';
            sortButton.style.fontSize = '10px';
            sortButton.style.cursor = 'pointer';
            sortButton.style.display = 'flex';
            sortButton.style.alignItems = 'center';
            sortButton.style.gap = '5px';
            
            // Sort dropdown menu
            const sortDropdown = document.createElement('div');
            sortDropdown.className = 'sort-dropdown';
            sortDropdown.style.display = 'none';
            sortDropdown.style.position = 'absolute';
            sortDropdown.style.top = '100%';
            sortDropdown.style.left = '0';
            sortDropdown.style.background = 'rgba(15, 20, 40, 0.95)';
            sortDropdown.style.border = '1px solid rgba(255, 153, 0, 0.3)';
            sortDropdown.style.borderRadius = '6px';
            sortDropdown.style.padding = '8px';
            sortDropdown.style.zIndex = '1000';
            sortDropdown.style.minWidth = '180px';
            sortDropdown.style.backdropFilter = 'blur(10px)';
            sortDropdown.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
            
            // Sort options
            const sortOptions = [
                { id: 'name_asc', label: 'Sort by Name (A-Z)', icon: 'fa-sort-alpha-down' },
                { id: 'name_desc', label: 'Sort by Name (Z-A)', icon: 'fa-sort-alpha-down-alt' },
                { id: 'story_asc', label: 'Sort by Story (A-Z)', icon: 'fa-book' },
                { id: 'story_desc', label: 'Sort by Story (Z-A)', icon: 'fa-book' },
                { id: 'story_number_asc', label: 'Sort by Story (1-100)', icon: 'fa-sort-numeric-down' },
                { id: 'story_number_desc', label: 'Sort by Story (100-1)', icon: 'fa-sort-numeric-down-alt' }
            ];
            
            sortOptions.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'sort-option';
                optionElement.dataset.sort = option.id;
                optionElement.innerHTML = `
                    <i class="fas ${option.icon}"></i>
                    <span>${option.label}</span>
                `;
                optionElement.style.padding = '6px 8px';
                optionElement.style.borderRadius = '4px';
                optionElement.style.cursor = 'pointer';
                optionElement.style.display = 'flex';
                optionElement.style.alignItems = 'center';
                optionElement.style.gap = '8px';
                optionElement.style.fontSize = '11px';
                optionElement.style.transition = 'all 0.2s ease';
                
                // Active state
                if (option.id === currentSortMode) {
                    optionElement.style.background = 'rgba(255, 153, 0, 0.2)';
                    optionElement.style.color = '#ff9900';
                } else {
                    optionElement.style.background = 'transparent';
                    optionElement.style.color = '#f0f8ff';
                }
                
                // Hover effect
                optionElement.addEventListener('mouseenter', () => {
                    if (option.id !== currentSortMode) {
                        optionElement.style.background = 'rgba(255, 153, 0, 0.1)';
                    }
                });
                
                optionElement.addEventListener('mouseleave', () => {
                    if (option.id !== currentSortMode) {
                        optionElement.style.background = 'transparent';
                    }
                });
                
                // Click event
                optionElement.addEventListener('click', () => {
                    currentSortMode = option.id;
                    renderVideoList();
                    sortDropdown.style.display = 'none';
                    sortButton.innerHTML = `<i class="fas ${option.icon}"></i> ${option.label.split(' ')[0]}`;
                });
                
                // Touch event for mobile
                optionElement.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    currentSortMode = option.id;
                    renderVideoList();
                    sortDropdown.style.display = 'none';
                    sortButton.innerHTML = `<i class="fas ${option.icon}"></i> ${option.label.split(' ')[0]}`;
                });
                
                sortDropdown.appendChild(optionElement);
            });
            
            // Toggle dropdown
            sortButton.addEventListener('click', (e) => {
                e.stopPropagation();
                sortDropdown.style.display = sortDropdown.style.display === 'none' ? 'block' : 'none';
            });
            
            sortButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                sortDropdown.style.display = sortDropdown.style.display === 'none' ? 'block' : 'none';
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!sortContainer.contains(e.target)) {
                    sortDropdown.style.display = 'none';
                }
            });
            
            document.addEventListener('touchstart', (e) => {
                if (!sortContainer.contains(e.target)) {
                    sortDropdown.style.display = 'none';
                }
            });
            
            // Assemble UI
            sortContainer.appendChild(sortButton);
            sortContainer.appendChild(sortDropdown);
            videoListTitle.appendChild(sortContainer);
        }

        // ==================== INITIALIZATION ====================
        async function initApp() {
            showLoading('Initializing Secure Video Platform...');
            
            try {
                // Check internet connection first
                if (!navigator.onLine) {
                    hideLoading();
                    noInternetModal.style.display = 'flex';
                    return;
                }
                
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                
                // Generate or get secure device ID
                deviceId = getSecureDeviceId();
                updateDeviceInfoDisplay();
                
                // Load custom image
                loadCustomImage();
                
                // Setup storage system
                await setupStorageSystem();
                
                // Load cached videos
                loadCachedVideos();
                
                // Setup event listeners
                setupEventListeners();
                
                // Setup video optimization
                optimizeVideoPlayback();
                
                // Check connection
                updateConnectionStatus();
                
                // Monitor network quality
                monitorNetworkQuality();
                
                // Load all data
                await Promise.all([
                    loadVideos(),
                    loadPasswords(),
                    loadContactLinks()
                ]);
                
                // Check for existing device password
                checkDevicePassword();
                
                // Render UI
                renderStoryList();
                renderVideoList();
                renderContactList();
                
                // Setup password section hover behavior
                setupPasswordSectionHover();
                
                // Add sorting UI
                addSortingUI();
                
                // Setup scroll and touch handling (·Ä°·Äõ·Ä±·Ä∏·ÄÄ·Äº·ÄÆ·Ä∏)
                setupScrollAndTouchHandling();
                
                // Start auto-preloading
                startAutoPreloading();
                
                // Hide loading
                setTimeout(() => {
                    hideLoading();
                    showToast('Secure Video Platform Ready', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                hideLoading();
                showToast('Initialization failed. Please check your connection.', 'error');
            }
        }

        // ==================== STORAGE SYSTEM ====================
        async function setupStorageSystem() {
            // Load saved storage location
            const savedLocation = localStorage.getItem(CONFIG.STORAGE_LOCATION_KEY);
            if (savedLocation) {
                storageLocation = savedLocation;
            }
            
            // Setup storage path based on location
            await setupStoragePath();
            
            // Update UI
            updateStorageLocationDisplay();
        }

        async function setupStoragePath() {
            try {
                switch(storageLocation) {
                    case 'default':
                        storagePath = '';
                        locationPath.textContent = 'Default App Storage';
                        break;
                        
                    case 'local':
                        // Try to use local storage
                        if (typeof window.requestFileSystem === 'undefined' && 
                            typeof window.webkitRequestFileSystem === 'undefined') {
                            // Fallback to default
                            storageLocation = 'default';
                            storagePath = '';
                            localStorage.setItem(CONFIG.STORAGE_LOCATION_KEY, 'default');
                            showToast('Local storage not available, using default', 'info');
                        } else {
                            try {
                                // Request local file system
                                const requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
                                storagePath = 'local://KVE_Videos/';
                                locationPath.textContent = 'Local Device Storage';
                            } catch (error) {
                                console.error('Local storage error:', error);
                                storageLocation = 'default';
                                storagePath = '';
                                localStorage.setItem(CONFIG.STORAGE_LOCATION_KEY, 'default');
                            }
                        }
                        break;
                        
                    case 'sd':
                        // Check for SD card support
                        if (typeof window.requestFileSystem === 'undefined' && 
                            typeof window.webkitRequestFileSystem === 'undefined') {
                            storageLocation = 'default';
                            storagePath = '';
                            localStorage.setItem(CONFIG.STORAGE_LOCATION_KEY, 'default');
                            showToast('SD card storage not available', 'info');
                        } else {
                            try {
                                // Try to access external storage
                                storagePath = 'external://KVE_Videos/';
                                locationPath.textContent = 'SD Card Storage';
                            } catch (error) {
                                console.error('SD card error:', error);
                                storageLocation = 'local';
                                await setupStoragePath(); // Fallback to local
                            }
                        }
                        break;
                        
                    case 'custom':
                        // Custom path will be set by user
                        const customPath = localStorage.getItem('kve_custom_storage_path');
                        if (customPath) {
                            storagePath = customPath;
                            locationPath.textContent = `Custom: ${customPath}`;
                        } else {
                            storageLocation = 'default';
                            storagePath = '';
                            localStorage.setItem(CONFIG.STORAGE_LOCATION_KEY, 'default');
                        }
                        break;
                }
                
                isStorageInitialized = true;
                
            } catch (error) {
                console.error('Storage setup error:', error);
                storageLocation = 'default';
                storagePath = '';
                localStorage.setItem(CONFIG.STORAGE_LOCATION_KEY, 'default');
                locationPath.textContent = 'Default App Storage';
                isStorageInitialized = true;
            }
        }

        function updateStorageLocationDisplay() {
            if (isStorageInitialized) {
                storageLocationEl.style.display = 'flex';
                
                // Update path display
                let displayPath = '';
                switch(storageLocation) {
                    case 'default': displayPath = 'Default App Storage'; break;
                    case 'local': displayPath = 'Local Device Storage'; break;
                    case 'sd': displayPath = 'SD Card Storage'; break;
                    case 'custom': 
                        const customPath = localStorage.getItem('kve_custom_storage_path') || 'Custom Folder';
                        displayPath = `Custom: ${customPath}`;
                        break;
                }
                
                locationPath.textContent = displayPath;
            }
        }

        function showStorageSelection() {
            storageSelection.classList.toggle('active');
        }

        async function selectStorage(type) {
            storageLocation = type;
            localStorage.setItem(CONFIG.STORAGE_LOCATION_KEY, type);
            
            // Setup new storage path
            await setupStoragePath();
            
            // Update display
            updateStorageLocationDisplay();
            
            // Close selection
            storageSelection.classList.remove('active');
            
            showToast(`Storage location set to ${type}`, 'success');
        }

        async function selectCustomStorageLocation() {
            try {
                // For Android, we can use file picker API
                if (window.showOpenFilePicker) {
                    const handle = await window.showDirectoryPicker();
                    const path = handle.name;
                    
                    localStorage.setItem('kve_custom_storage_path', path);
                    await selectStorage('custom');
                    
                } else {
                    // Fallback for browsers without file picker API
                    const path = prompt('Enter custom storage path:', 'KVE_Videos');
                    if (path) {
                        localStorage.setItem('kve_custom_storage_path', path);
                        await selectStorage('custom');
                    }
                }
            } catch (error) {
                console.error('Custom storage selection error:', error);
                showToast('Cannot access custom storage location', 'error');
            }
        }

        // ==================== PRELOADING SYSTEM ====================
        function startAutoPreloading() {
            if (!navigator.onLine || videos.length === 0) return;
            
            // Start preloading after a short delay
            setTimeout(() => {
                startPreloading();
            }, 3000);
        }

        function startPreloading() {
            if (isPreloading) return;
            
            isPreloading = true;
            preloadProgressEl.style.display = 'block';
            preloadQueue = [...videos];
            preloadProgress = {};
            
            // Initialize progress for each video
            videos.forEach(video => {
                preloadProgress[video.id] = {
                    name: video.name,
                    progress: 0,
                    isCached: preloadedVideos.has(video.id)
                };
            });
            
            updatePreloadProgressDisplay();
            showToast('Started preloading videos', 'info');
            
            // Start preloading in batches (3 at a time)
            preloadBatch(0, 3);
        }

        function preloadBatch(startIndex, batchSize) {
            const endIndex = Math.min(startIndex + batchSize, preloadQueue.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const video = preloadQueue[i];
                if (!preloadedVideos.has(video.id)) {
                    preloadVideo(video);
                }
            }
            
            // Continue with next batch if needed
            if (endIndex < preloadQueue.length) {
                setTimeout(() => {
                    preloadBatch(endIndex, batchSize);
                }, 2000);
            }
        }

        async function preloadVideo(video) {
            if (preloadedVideos.has(video.id)) return;
            
            try {
                // Create video element for preloading
                const preloadVideo = document.createElement('video');
                preloadVideo.preload = 'auto';
                preloadVideo.crossOrigin = 'anonymous';
                
                // Track progress
                let loaded = 0;
                let total = 0;
                
                preloadVideo.addEventListener('progress', () => {
                    if (preloadVideo.buffered.length > 0) {
                        loaded = preloadVideo.buffered.end(0);
                        total = preloadVideo.duration || 1;
                        
                        const progress = Math.min((loaded / total) * 100, 99);
                        preloadProgress[video.id].progress = progress;
                        updatePreloadProgressDisplay();
                    }
                });
                
                preloadVideo.addEventListener('canplaythrough', () => {
                    preloadProgress[video.id].progress = 100;
                    preloadedVideos.add(video.id);
                    cacheVideo(video, preloadVideo);
                    updatePreloadProgressDisplay();
                    updateStorageInfo();
                    
                    if (isPreloadingComplete()) {
                        finishPreloading();
                    }
                });
                
                preloadVideo.addEventListener('error', () => {
                    preloadProgress[video.id].progress = -1; // Error
                    updatePreloadProgressDisplay();
                });
                
                // Start loading
                preloadVideo.src = video.url;
                preloadVideo.load();
                
            } catch (error) {
                console.error('Preloading error:', error);
                preloadProgress[video.id].progress = -1;
                updatePreloadProgressDisplay();
            }
        }

        function cacheVideo(video, videoElement) {
            const cacheKey = `video_cache_${video.id}`;
            const cacheData = {
                id: video.id,
                name: video.name,
                url: video.url,
                timestamp: Date.now(),
                duration: videoElement.duration || 0
            };
            
            try {
                localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                cachedVideos[video.id] = cacheData;
                updateStorageInfo();
            } catch (error) {
                console.error('Cache error:', error);
                // Clear old caches if storage is full
                cleanupOldCache();
            }
        }

        function loadCachedVideos() {
            const now = Date.now();
            const expiryTime = CONFIG.CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('video_cache_')) {
                    try {
                        const cacheData = JSON.parse(localStorage.getItem(key));
                        
                        // Check if cache is expired
                        if (now - cacheData.timestamp > expiryTime) {
                            localStorage.removeItem(key);
                            continue;
                        }
                        
                        cachedVideos[cacheData.id] = cacheData;
                        preloadedVideos.add(cacheData.id);
                    } catch (error) {
                        console.error('Cache load error:', error);
                        localStorage.removeItem(key);
                    }
                }
            }
            
            updateStorageInfo();
        }

        function cleanupOldCache() {
            const now = Date.now();
            const expiryTime = CONFIG.CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
            let freedSpace = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('video_cache_')) {
                    try {
                        const cacheData = JSON.parse(localStorage.getItem(key));
                        if (now - cacheData.timestamp > expiryTime) {
                            localStorage.removeItem(key);
                            freedSpace++;
                        }
                    } catch (error) {
                        localStorage.removeItem(key);
                    }
                }
            }
            
            if (freedSpace > 0) {
                showToast(`Cleaned up ${freedSpace} expired caches`, 'info');
            }
            
            updateStorageInfo();
        }

        function isPreloadingComplete() {
            return videos.every(video => 
                preloadedVideos.has(video.id) || preloadProgress[video.id]?.progress === -1
            );
        }

        function finishPreloading() {
            isPreloading = false;
            setTimeout(() => {
                preloadProgressEl.style.display = 'none';
                showToast('All videos preloaded and cached', 'success');
            }, 2000);
        }

        function updatePreloadProgressDisplay() {
            const totalVideos = videos.length;
            const cachedVideosCount = Object.values(preloadProgress).filter(p => p.isCached).length;
            const completedVideos = Object.values(preloadProgress).filter(p => p.progress >= 100).length;
            const totalProgress = ((cachedVideosCount + completedVideos) / (totalVideos * 2)) * 100;
            
            preloadProgressFill.style.width = `${totalProgress}%`;
            preloadProgressText.textContent = `${completedVideos}/${totalVideos} videos preloaded`;
            
            // Update list
            preloadProgressList.innerHTML = '';
            videos.forEach(video => {
                const progress = preloadProgress[video.id] || { progress: 0, isCached: false };
                const item = document.createElement('div');
                item.className = 'preload-item';
                
                let statusIcon = '‚è≥';
                let statusText = '';
                
                if (progress.progress === -1) {
                    statusIcon = '‚ùå';
                    statusText = 'Failed';
                } else if (progress.progress >= 100) {
                    statusIcon = '‚úÖ';
                    statusText = 'Ready';
                } else if (progress.isCached) {
                    statusIcon = 'üíæ';
                    statusText = 'Cached';
                }
                
                item.innerHTML = `
                    <div class="preload-item-name">${video.name}</div>
                    <div class="preload-item-progress">
                        <div class="preload-item-progress-fill" style="width: ${Math.max(0, progress.progress)}%;"></div>
                    </div>
                    <div class="preload-item-percent">
                        ${progress.progress >= 0 ? `${Math.round(progress.progress)}%` : statusText} ${statusIcon}
                    </div>
                `;
                
                preloadProgressList.appendChild(item);
            });
        }

        function updateStorageInfo() {
            const totalVideos = videos.length;
            const cachedCount = preloadedVideos.size;
            const cachePercentage = totalVideos > 0 ? Math.round((cachedCount / totalVideos) * 100) : 0;
            
            storageText.textContent = `${cachedCount}/${totalVideos} (${cachePercentage}%)`;
            storageInfo.style.display = cachedCount > 0 ? 'flex' : 'none';
        }

        // ==================== VIDEO SECURITY SYSTEM ====================
        function encryptVideoData(data) {
            try {
                const encrypted = CryptoJS.AES.encrypt(
                    JSON.stringify(data),
                    CONFIG.ENCRYPTION_KEY + deviceId
                ).toString();
                return encrypted;
            } catch (error) {
                console.error('Encryption error:', error);
                return null;
            }
        }

        function decryptVideoData(encryptedData) {
            try {
                const decrypted = CryptoJS.AES.decrypt(
                    encryptedData,
                    CONFIG.ENCRYPTION_KEY + deviceId
                ).toString(CryptoJS.enc.Utf8);
                return JSON.parse(decrypted);
            } catch (error) {
                console.error('Decryption error:', error);
                return null;
            }
        }

        function protectVideoFromDownload() {
            // Disable right-click on video
            videoPlayer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });
            
            // Disable video download
            videoPlayer.controlsList = 'nodownload noremoteplayback';
            
            // Disable picture-in-picture
            videoPlayer.disablePictureInPicture = true;
        }

        // ==================== VIDEO PLAYBACK OPTIMIZATION ====================
        function optimizeVideoPlayback() {
            // Android-specific optimizations
            videoPlayer.preload = 'metadata';
            videoPlayer.setAttribute('preload', 'metadata');
            videoPlayer.crossOrigin = 'anonymous';
            videoPlayer.playsInline = true;
            videoPlayer.disableRemotePlayback = true;
            
            // Android Chrome specific settings
            if (navigator.userAgent.toLowerCase().indexOf('android') > -1) {
                videoPlayer.setAttribute('webkit-playsinline', 'true');
                videoPlayer.setAttribute('playsinline', 'true');
                videoPlayer.setAttribute('x5-video-player-type', 'h5');
                videoPlayer.setAttribute('x5-video-player-fullscreen', 'false');
                videoPlayer.setAttribute('x5-video-orientation', 'portrait');
                videoPlayer.setAttribute('t7-video-player-type', 'inline');
            }
            
            // Prevent hardware acceleration issues
            videoPlayer.style.transform = 'translateZ(0)';
            videoPlayer.style.webkitTransform = 'translateZ(0)';
            videoPlayer.style.backfaceVisibility = 'hidden';
            
            // Video event listeners for buffering control
            videoPlayer.addEventListener('waiting', function() {
                showBufferingIndicator();
            });
            
            videoPlayer.addEventListener('playing', function() {
                hideBufferingIndicator();
            });
            
            videoPlayer.addEventListener('canplay', function() {
                hideBufferingIndicator();
            });
            
            videoPlayer.addEventListener('canplaythrough', function() {
                hideBufferingIndicator();
            });
            
            videoPlayer.addEventListener('progress', function() {
                updateBufferInfo();
            });
            
            videoPlayer.addEventListener('error', function(e) {
                console.log('Video error:', e);
                handleVideoError();
            });
            
            // Prevent accidental play on scroll
            videoPlayer.addEventListener('touchstart', function(e) {
                e.stopPropagation();
            });
            
            // Quality selector events
            qualityButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const quality = this.getAttribute('data-quality');
                    setVideoQuality(quality);
                });
                
                btn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const quality = this.getAttribute('data-quality');
                    setVideoQuality(quality);
                });
            });
            
            // Add video security
            protectVideoFromDownload();
        }

        function showBufferingIndicator() {
            if (!isBuffering) {
                isBuffering = true;
                bufferingIndicator.style.display = 'flex';
                
                // Auto-hide after 10 seconds
                bufferingTimeout = setTimeout(() => {
                    hideBufferingIndicator();
                    // If still buffering, try to fix
                    if (videoPlayer.readyState < 3) {
                        retryVideoPlayback();
                    }
                }, 10000);
            }
        }

        function hideBufferingIndicator() {
            isBuffering = false;
            bufferingIndicator.style.display = 'none';
            if (bufferingTimeout) {
                clearTimeout(bufferingTimeout);
                bufferingTimeout = null;
            }
        }

        function updateBufferInfo() {
            if (videoPlayer.buffered.length > 0) {
                const bufferedEnd = videoPlayer.buffered.end(videoPlayer.buffered.length - 1);
                const currentTime = videoPlayer.currentTime;
                videoBufferSize = bufferedEnd - currentTime;
                
                // Show quality selector if buffer is low
                if (videoBufferSize < 5 && networkQuality !== 'good') {
                    qualitySelector.style.display = 'flex';
                } else {
                    qualitySelector.style.display = 'none';
                }
                
                // Auto-optimize based on buffer
                if (videoBufferSize < 2) {
                    autoOptimizePlayback();
                }
            }
        }

        function autoOptimizePlayback() {
            if (networkQuality === 'slow-2g' || networkQuality === '2g') {
                // Slow network - reduce quality
                setVideoQuality('360p');
                showToast('Auto-switched to 360p for better playback', 'info');
            } else if (networkQuality === '3g') {
                // Medium network - use 480p
                setVideoQuality('480p');
            }
        }

        function setVideoQuality(quality) {
            currentQuality = quality;
            
            // Update active button
            qualityButtons.forEach(btn => {
                if (btn.getAttribute('data-quality') === quality) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // If video is playing, we could switch to different quality stream
            // For now, just adjust playback rate for optimization
            switch(quality) {
                case '360p':
                    videoPlayer.playbackRate = 1.0;
                    videoPlayer.defaultPlaybackRate = 1.0;
                    break;
                case '480p':
                    videoPlayer.playbackRate = 1.0;
                    videoPlayer.defaultPlaybackRate = 1.0;
                    break;
                case 'auto':
                    // Auto-detect based on network
                    if (networkQuality === 'slow-2g' || networkQuality === '2g') {
                        videoPlayer.playbackRate = 0.8;
                    } else {
                        videoPlayer.playbackRate = 1.0;
                    }
                    break;
            }
            
            showToast(`Quality set to ${quality}`, 'info');
        }

        function retryVideoPlayback() {
            if (!videoPlayer.src) return;
            
            showToast('Retrying playback...', 'info');
            
            const currentTime = videoPlayer.currentTime;
            const currentSrc = videoPlayer.src;
            
            // Pause and reset
            videoPlayer.pause();
            videoPlayer.src = '';
            
            setTimeout(() => {
                videoPlayer.src = currentSrc;
                videoPlayer.currentTime = currentTime > 5 ? currentTime - 5 : 0;
                videoPlayer.load();
                
                setTimeout(() => {
                    videoPlayer.play().catch(e => {
                        console.log('Retry play failed:', e);
                    });
                }, 500);
            }, 1000);
        }

        function handleVideoError() {
            showToast('Video playback error. Trying to fix...', 'error');
            
            setTimeout(() => {
                if (videoPlayer.error) {
                    // Try to reload the video
                    const src = videoPlayer.src;
                    videoPlayer.src = src;
                    videoPlayer.load();
                    
                    setTimeout(() => {
                        videoPlayer.play().catch(e => {
                            console.log('Error recovery failed:', e);
                        });
                    }, 500);
                }
            }, 1000);
        }

        // ==================== NETWORK OPTIMIZATION ====================
        function monitorNetworkQuality() {
            if ('connection' in navigator) {
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                
                if (connection) {
                    networkQuality = connection.effectiveType || 'unknown';
                    console.log('Network quality:', networkQuality);
                    
                    // Adjust settings based on network
                    adjustForNetworkQuality();
                    
                    // Listen for network changes
                    connection.addEventListener('change', function() {
                        networkQuality = connection.effectiveType;
                        console.log('Network changed to:', networkQuality);
                        adjustForNetworkQuality();
                        showToast(`Network: ${networkQuality}`, 'info');
                    });
                }
            }
        }

        function adjustForNetworkQuality() {
            switch(networkQuality) {
                case 'slow-2g':
                case '2g':
                    // Very slow network - aggressive optimization
                    videoPlayer.preload = 'none';
                    setVideoQuality('360p');
                    break;
                case '3g':
                    // Medium network - moderate optimization
                    videoPlayer.preload = 'metadata';
                    setVideoQuality('480p');
                    break;
                case '4g':
                default:
                    // Good network - normal settings
                    videoPlayer.preload = 'auto';
                    setVideoQuality('auto');
                    break;
            }
        }

        // ==================== PASSWORD SECTION HOVER BEHAVIOR ====================
        function setupPasswordSectionHover() {
            // Mouse enter event
            passwordSection.addEventListener('mouseenter', () => {
                clearTimeout(passwordSectionHoverTimer);
                expandPasswordSection();
            });

            // Mouse leave event
            passwordSection.addEventListener('mouseleave', () => {
                // Wait 6 seconds before collapsing
                passwordSectionHoverTimer = setTimeout(() => {
                    collapsePasswordSection();
                }, 6000);
            });

            // Touch events for mobile
            passwordSection.addEventListener('touchstart', (e) => {
                e.preventDefault();
                clearTimeout(passwordSectionHoverTimer);
                expandPasswordSection();
            });

            // Android ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ improved touch handling
            passwordSection.addEventListener('touchend', (e) => {
                e.preventDefault();
            });

            document.addEventListener('touchstart', (e) => {
                if (!passwordSection.contains(e.target)) {
                    collapsePasswordSection();
                }
            });
        }

        function expandPasswordSection() {
            passwordSectionExpanded = true;
            passwordSection.classList.add('expanded');
            // Android ·Äô·Äæ·Ä¨ input ·ÄÄ·Ä≠·ÄØ focus ·Äú·ÄØ·Äï·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫
            setTimeout(() => {
                passwordInput.focus();
            }, 300);
        }

        function collapsePasswordSection() {
            passwordSectionExpanded = false;
            passwordSection.classList.remove('expanded');
        }

        // ==================== SECURE DEVICE ID SYSTEM ====================
        function getSecureDeviceId() {
            // Try to get existing device ID
            let storedId = localStorage.getItem(CONFIG.DEVICE_ID_KEY);
            
            if (!storedId) {
                // Generate new secure device ID
                const timestamp = Date.now();
                const randomPart = Math.random().toString(36).substr(2, 12);
                const userAgentHash = CryptoJS.SHA256(navigator.userAgent).toString().substr(0, 8);
                const screenHash = CryptoJS.SHA256(`${screen.width}x${screen.height}`).toString().substr(0, 6);
                
                storedId = `kve_dev_${timestamp}_${randomPart}_${userAgentHash}_${screenHash}`;
                localStorage.setItem(CONFIG.DEVICE_ID_KEY, storedId);
                
                // Clear any existing password data (new device)
                clearDevicePassword();
                showToast('New device detected', 'info');
            }
            
            return storedId;
        }

        function updateDeviceInfoDisplay() {
            if (deviceId) {
                const shortId = deviceId.substr(0, 12) + '...';
                deviceIdShort.textContent = shortId;
                deviceInfoDisplay.style.display = 'flex';
                deviceInfo.innerHTML = `<i class="fas fa-fingerprint"></i> Device ID: ${shortId}`;
            }
        }

        // ==================== DEVICE-LOCKED PASSWORD SYSTEM ====================
        function checkDevicePassword() {
            const stored = localStorage.getItem(CONFIG.PASSWORD_STORAGE_KEY);
            
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    
                    // Verify the password is for this device
                    if (data.deviceId === deviceId) {
                        devicePasswordData = data;
                        
                        // Check if password still exists on server and is not used elsewhere
                        checkPasswordValidity(data.password);
                    } else {
                        // Different device trying to use password
                        clearDevicePassword();
                        showToast('This password is locked to another device', 'error');
                    }
                } catch (e) {
                    clearDevicePassword();
                }
            }
        }

        function checkPasswordValidity(password) {
            if (!passwords.length) return;
            
            const matchingPassword = passwords.find(p => p.password === password);
            
            if (matchingPassword) {
                // Check password usage on server
                checkPasswordUsageOnServer(password, matchingPassword);
            } else {
                // Password deleted by admin
                clearDevicePassword();
                passwordResetModal.style.display = 'flex';
            }
        }

        async function checkPasswordUsageOnServer(password, passwordData) {
            try {
                const db = firebase.firestore();
                
                // Check if there's a usage record for this password
                const usageRef = db.collection('passwordUsage').where('password', '==', password);
                const snapshot = await usageRef.get();
                
                if (!snapshot.empty) {
                    const usageDoc = snapshot.docs[0];
                    const usageData = usageDoc.data();
                    
                    if (usageData.deviceId === deviceId) {
                        // This device is authorized to use this password
                        autoUnlockWithDevicePassword(password, passwordData);
                    } else {
                        // Password is being used on another device
                        clearDevicePassword();
                        passwordResetModal.style.display = 'flex';
                        showToast('Password is already in use on another device', 'error');
                    }
                } else {
                    // No usage record found, create one for this device
                    await recordPasswordUsage(password);
                    autoUnlockWithDevicePassword(password, passwordData);
                }
                
            } catch (error) {
                console.error('Error checking password usage:', error);
                // Fallback to local validation
                autoUnlockWithDevicePassword(password, passwordData);
            }
        }

        async function recordPasswordUsage(password) {
            try {
                const db = firebase.firestore();
                
                // Create or update usage record
                await db.collection('passwordUsage').doc(password).set({
                    password: password,
                    deviceId: deviceId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUsed: Date.now()
                });
                
            } catch (error) {
                console.error('Error recording password usage:', error);
            }
        }

        function autoUnlockWithDevicePassword(password, passwordData) {
            if (passwordData.storyName) {
                unlockedVideos.add(passwordData.storyName);
                updatePasswordIndicator(true, passwordData.storyName);
            } else {
                videos.forEach(video => {
                    if (video.passwordType === 'password') {
                        unlockedVideos.add(video.id);
                    }
                });
                updatePasswordIndicator(true, 'All Videos');
            }
            
            renderVideoList();
            logoutBtn.style.display = 'flex';
            showToast('Auto-logged in with device password', 'success');
        }

        function clearDevicePassword() {
            devicePasswordData = null;
            unlockedVideos.clear();
            localStorage.removeItem(CONFIG.PASSWORD_STORAGE_KEY);
            updatePasswordIndicator(false);
            renderVideoList();
            logoutBtn.style.display = 'none';
            
            // Clear password input
            passwordInput.value = '';
        }

        async function logout() {
            if (devicePasswordData) {
                try {
                    // Remove usage record from server
                    const db = firebase.firestore();
                    await db.collection('passwordUsage').doc(devicePasswordData.password).delete();
                } catch (error) {
                    console.error('Error removing usage record:', error);
                }
            }
            
            clearDevicePassword();
            showToast('Logged out successfully', 'success');
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Android ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ improved touch events
            setupTouchEvents();
            
            // Stories menu
            storiesToggle.addEventListener('click', toggleStoriesMenu);
            storiesToggle.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                toggleStoriesMenu(e);
            });
            document.addEventListener('click', closeStoriesMenuOnClickOutside);
            document.addEventListener('touchstart', closeStoriesMenuOnClickOutside);
            
            // Password toggle
            passwordToggle.addEventListener('click', togglePasswordVisibility);
            passwordToggle.addEventListener('touchend', (e) => {
                e.preventDefault();
                togglePasswordVisibility();
            });
            
            videoPasswordToggle.addEventListener('click', toggleVideoPasswordVisibility);
            videoPasswordToggle.addEventListener('touchend', (e) => {
                e.preventDefault();
                toggleVideoPasswordVisibility();
            });
            
            // Password section
            unlockBtn.addEventListener('click', unlockVideos);
            unlockBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                unlockVideos();
            });
            
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') unlockVideos();
            });
            
            // Android ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ input focus ·Äï·Äº·Äø·Äî·Ä¨ ·Äñ·Äº·Ä±·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            passwordInput.addEventListener('touchstart', (e) => {
                e.stopPropagation();
            });
            
            // Storage selection
            storageBtn.addEventListener('click', () => {
                storageModal.style.display = 'flex';
            });
            
            storageBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                storageModal.style.display = 'flex';
            });
            
            // Storage option buttons
            selectDefaultStorage.addEventListener('click', () => {
                selectStorage('default');
                storageModal.style.display = 'none';
            });
            
            selectLocalStorage.addEventListener('click', () => {
                selectStorage('local');
                storageModal.style.display = 'none';
            });
            
            selectSDCard.addEventListener('click', () => {
                selectStorage('sd');
                storageModal.style.display = 'none';
            });
            
            selectCustomStorage.addEventListener('click', async () => {
                storageModal.style.display = 'none';
                await selectCustomStorageLocation();
            });
            
            // Navigation
            contactBtn.addEventListener('click', () => showScreen(2));
            contactBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                showScreen(2);
            });
            
            refreshBtn.addEventListener('click', refreshData);
            refreshBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                refreshData();
            });
            
            logoutBtn.addEventListener('click', logout);
            logoutBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                logout();
            });
            
            preloadBtn.addEventListener('click', startPreloading);
            preloadBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                startPreloading();
            });
            
            closePreloadProgress.addEventListener('click', () => {
                preloadProgressEl.style.display = 'none';
            });
            
            closePreloadProgress.addEventListener('touchend', (e) => {
                e.preventDefault();
                preloadProgressEl.style.display = 'none';
            });
            
            optimizeBtn.addEventListener('click', () => {
                optimizeVideoPlayback();
                showToast('Video playback optimized for Android', 'success');
            });
            optimizeBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                optimizeVideoPlayback();
                showToast('Video playback optimized for Android', 'success');
            });
            
            backButton.addEventListener('click', handleBackButton);
            backButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleBackButton();
            });
            
            backToMain.addEventListener('click', () => showScreen(1));
            backToMain.addEventListener('touchend', (e) => {
                e.preventDefault();
                showScreen(1);
            });
            
            // Video player
            fullscreenBtn.addEventListener('click', toggleFullScreen);
            fullscreenBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                toggleFullScreen();
            });
            
            // Video password modal
            submitVideoPassword.addEventListener('click', unlockCurrentVideo);
            submitVideoPassword.addEventListener('touchend', (e) => {
                e.preventDefault();
                unlockCurrentVideo();
            });
            
            cancelVideoPassword.addEventListener('click', closeVideoPasswordModal);
            cancelVideoPassword.addEventListener('touchend', (e) => {
                e.preventDefault();
                closeVideoPasswordModal();
            });
            
            videoPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') unlockCurrentVideo();
            });
            
            // Android ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ modal touch handling
            videoPasswordModal.addEventListener('touchmove', (e) => {
                e.stopPropagation();
            });
            
            // Close modal when clicking outside
            videoPasswordModal.addEventListener('click', (e) => {
                if (e.target === videoPasswordModal) {
                    closeVideoPasswordModal();
                }
            });
            
            videoPasswordModal.addEventListener('touchstart', (e) => {
                if (e.target === videoPasswordModal) {
                    closeVideoPasswordModal();
                }
            });
            
            passwordResetModal.addEventListener('click', (e) => {
                if (e.target === passwordResetModal) {
                    passwordResetModal.style.display = 'none';
                }
            });
            
            passwordResetModal.addEventListener('touchstart', (e) => {
                if (e.target === passwordResetModal) {
                    passwordResetModal.style.display = 'none';
                }
            });
            
            storageModal.addEventListener('click', (e) => {
                if (e.target === storageModal) {
                    storageModal.style.display = 'none';
                }
            });
            
            storageModal.addEventListener('touchstart', (e) => {
                if (e.target === storageModal) {
                    storageModal.style.display = 'none';
                }
            });
            
            // No internet modal
            retryConnectionBtn.addEventListener('click', () => {
                noInternetModal.style.display = 'none';
                initApp();
            });
            
            retryConnectionBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                noInternetModal.style.display = 'none';
                initApp();
            });
            
            confirmPasswordReset.addEventListener('click', () => {
                passwordResetModal.style.display = 'none';
                passwordInput.focus();
            });
            
            confirmPasswordReset.addEventListener('touchend', (e) => {
                e.preventDefault();
                passwordResetModal.style.display = 'none';
                passwordInput.focus();
            });
            
            // Network events
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            
            // Video player security
            videoPlayer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });
            
            // Fullscreen change
            document.addEventListener('fullscreenchange', handleFullScreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullScreenChange);
            document.addEventListener('mozfullscreenchange', handleFullScreenChange);
            document.addEventListener('MSFullscreenChange', handleFullScreenChange);
            
            // Android ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ pull-to-refresh ·ÄÄ·Ä¨·ÄÄ·ÄΩ·Äö·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            let startY = 0;
            document.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
            }, { passive: true });
            
            document.addEventListener('touchmove', (e) => {
                const currentY = e.touches[0].clientY;
                // ·Äï·Äë·Äô·ÄÜ·ÄØ·Ä∂·Ä∏ scroll position ·Äô·Äæ·Ä¨·ÄÜ·Ä≠·ÄØ·Äõ·ÄÑ·Ä∫ pull-to-refresh ·ÄÄ·Ä¨·ÄÄ·ÄΩ·Äö·Ä∫·Äô·Äö·Ä∫
                if (window.scrollY === 0 && currentY > startY) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Handle app visibility changes
            document.addEventListener('visibilitychange', function() {
                if (document.hidden && !videoPlayer.paused) {
                    videoPlayer.pause();
                }
            });
            
            // Android keyboard ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫
            window.addEventListener('resize', function() {
                // Keyboard ·Äë·ÄΩ·ÄÄ·Ä∫·Äú·Ä¨·Äõ·ÄÑ·Ä∫ ·Äô·Äï·Äª·ÄÄ·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫
                setTimeout(() => {
                    if (document.activeElement && document.activeElement.scrollIntoViewIfNeeded) {
                        document.activeElement.scrollIntoViewIfNeeded();
                    }
                }, 100);
            });
        }

        function setupTouchEvents() {
            // Android ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ button ·Äô·Äª·Ä¨·Ä∏ ·Äî·Äæ·Ä≠·Äï·Ä∫·Äõ·Äú·ÄΩ·Äö·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫
            document.querySelectorAll('button, .video-item, .story-item, .nav-btn, .action-btn').forEach(element => {
                element.addEventListener('touchstart', function() {
                    this.style.opacity = '0.8';
                });
                
                element.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                });
                
                element.addEventListener('touchcancel', function() {
                    this.style.opacity = '1';
                });
            });
        }

        function togglePasswordVisibility() {
            isPasswordVisible = !isPasswordVisible;
            passwordInput.type = isPasswordVisible ? 'text' : 'password';
            passwordToggle.innerHTML = isPasswordVisible ? 
                '<i class="fas fa-eye-slash"></i>' : 
                '<i class="fas fa-eye"></i>';
        }

        function toggleVideoPasswordVisibility() {
            isVideoPasswordVisible = !isVideoPasswordVisible;
            videoPassword.type = isVideoPasswordVisible ? 'text' : 'password';
            videoPasswordToggle.innerHTML = isVideoPasswordVisible ? 
                '<i class="fas fa-eye-slash"></i>' : 
                '<i class="fas fa-eye"></i>';
        }

        // ==================== STORIES MENU ====================
        function toggleStoriesMenu(e) {
            if (e) {
                e.stopPropagation();
                e.preventDefault();
            }
            storiesMenu.classList.toggle('active');
        }

        function closeStoriesMenuOnClickOutside(e) {
            if (!storiesToggle.contains(e.target) && !storiesMenu.contains(e.target)) {
                storiesMenu.classList.remove('active');
            }
        }

        // ==================== DATA LOADING ====================
        async function loadVideos() {
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('videos').get();
                videos = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Extract stories
                const storySet = new Set();
                videos.forEach(video => {
                    if (video.storyName) {
                        storySet.add(video.storyName);
                    }
                });
                stories = Array.from(storySet).sort();
                
                console.log(`${videos.length} videos loaded`);
            } catch (error) {
                console.error('Error loading videos:', error);
                throw error;
            }
        }

        async function loadPasswords() {
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('passwords').get();
                passwords = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading passwords:', error);
                throw error;
            }
        }

        async function loadContactLinks() {
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('contactLinks').get();
                contactLinks = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading contact links:', error);
                throw error;
            }
        }

        async function refreshData() {
            showLoading('Refreshing data...');
            
            try {
                await Promise.all([
                    loadVideos(),
                    loadPasswords(),
                    loadContactLinks()
                ]);
                
                // Re-check password validity after refresh
                if (devicePasswordData) {
                    checkPasswordValidity(devicePasswordData.password);
                }
                
                renderStoryList();
                renderVideoList();
                renderContactList();
                
                hideLoading();
                showToast('Data refreshed successfully', 'success');
            } catch (error) {
                hideLoading();
                showToast('Refresh failed', 'error');
            }
        }

        // ==================== PASSWORD UNLOCK SYSTEM ====================
        async function unlockVideos() {
            const password = passwordInput.value.trim();
            
            if (!password) {
                showToast('Enter password', 'error');
                passwordStatus.textContent = '‚úó Please enter password';
                passwordStatus.style.color = '#ff3e3e';
                return;
            }
            
            // Check for matching password
            const matchingPassword = passwords.find(p => p.password === password);
            
            if (matchingPassword) {
                // Check if password is already in use on another device
                const isAvailable = await checkPasswordAvailability(password);
                
                if (!isAvailable) {
                    showToast('Password already in use on another device', 'error');
                    passwordStatus.textContent = '‚úó Password locked to another device';
                    passwordStatus.style.color = '#ff3e3e';
                    return;
                }
                
                // Save device password data
                devicePasswordData = {
                    password: password,
                    deviceId: deviceId,
                    storyName: matchingPassword.storyName,
                    timestamp: Date.now()
                };
                
                localStorage.setItem(CONFIG.PASSWORD_STORAGE_KEY, JSON.stringify(devicePasswordData));
                
                // Record password usage on server
                await recordPasswordUsage(password);
                
                // Unlock videos
                if (matchingPassword.storyName) {
                    unlockedVideos.add(matchingPassword.storyName);
                    showToast(`Unlocked: ${matchingPassword.storyName}`, 'success');
                    updatePasswordIndicator(true, matchingPassword.storyName);
                } else {
                    videos.forEach(video => {
                        if (video.passwordType === 'password') {
                            unlockedVideos.add(video.id);
                        }
                    });
                    showToast('All videos unlocked', 'success');
                    updatePasswordIndicator(true, 'All Videos');
                }
                
                renderVideoList();
                passwordInput.value = '';
                passwordStatus.textContent = '‚úì Access granted - Password locked to this device';
                passwordStatus.style.color = '#00ff00';
                
                // Show logout button
                logoutBtn.style.display = 'flex';
                
            } else {
                showToast('Invalid password', 'error');
                passwordStatus.textContent = '‚úó Invalid password';
                passwordStatus.style.color = '#ff3e3e';
            }
        }

        async function checkPasswordAvailability(password) {
            try {
                const db = firebase.firestore();
                const usageRef = db.collection('passwordUsage').doc(password);
                const doc = await usageRef.get();
                
                if (doc.exists) {
                    const data = doc.data();
                    // Password is available if it's not used or used by this device
                    return !data.deviceId || data.deviceId === deviceId;
                }
                
                // No usage record found, password is available
                return true;
                
            } catch (error) {
                console.error('Error checking password availability:', error);
                // In case of error, allow local validation
                return true;
            }
        }

        async function unlockCurrentVideo() {
            const password = videoPassword.value.trim();
            
            if (!password) {
                videoPasswordStatus.textContent = 'Enter password';
                videoPasswordStatus.style.color = '#ff3e3e';
                return;
            }
            
            if (!currentVideoToUnlock) {
                closeVideoPasswordModal();
                return;
            }
            
            const matchingPassword = passwords.find(p => 
                p.password === password && 
                (p.storyName === currentVideoToUnlock.storyName || !p.storyName)
            );
            
            if (matchingPassword) {
                // Check if password is already in use on another device
                const isAvailable = await checkPasswordAvailability(password);
                
                if (!isAvailable) {
                    videoPasswordStatus.textContent = 'Password locked to another device';
                    videoPasswordStatus.style.color = '#ff3e3e';
                    videoPassword.value = '';
                    videoPassword.focus();
                    return;
                }
                
                // Save device password data
                devicePasswordData = {
                    password: password,
                    deviceId: deviceId,
                    storyName: matchingPassword.storyName,
                    timestamp: Date.now()
                };
                
                localStorage.setItem(CONFIG.PASSWORD_STORAGE_KEY, JSON.stringify(devicePasswordData));
                
                // Record password usage
                await recordPasswordUsage(password);
                
                unlockedVideos.add(currentVideoToUnlock.id);
                closeVideoPasswordModal();
                playVideo(currentVideoToUnlock);
                renderVideoList();
                showToast('Video unlocked', 'success');
                
                updatePasswordIndicator(true, currentVideoToUnlock.storyName || currentVideoToUnlock.name);
                logoutBtn.style.display = 'flex';
                
            } else {
                videoPasswordStatus.textContent = 'Invalid password for this video';
                videoPasswordStatus.style.color = '#ff3e3e';
                videoPassword.value = '';
                videoPassword.focus();
            }
        }

        function updatePasswordIndicator(isUnlocked, name = '') {
            if (isUnlocked) {
                passwordIndicator.className = 'password-indicator';
                passwordIndicator.innerHTML = `<i class="fas fa-unlock"></i> <span>${name || 'Unlocked'}</span>`;
            } else {
                passwordIndicator.className = 'password-indicator locked';
                passwordIndicator.innerHTML = `<i class="fas fa-lock"></i> <span>Locked</span>`;
            }
        }

        // ==================== RENDER FUNCTIONS ====================
        function renderStoryList() {
            storyList.innerHTML = '';
            
            // Add "All Stories" option
            const allItem = document.createElement('div');
            allItem.className = `story-item ${!currentStory ? 'active' : ''}`;
            allItem.textContent = 'All Stories';
            allItem.addEventListener('click', () => {
                currentStory = null;
                renderVideoList();
                storiesMenu.classList.remove('active');
            });
            allItem.addEventListener('touchend', (e) => {
                e.preventDefault();
                currentStory = null;
                renderVideoList();
                storiesMenu.classList.remove('active');
            });
            storyList.appendChild(allItem);
            
            // Add each story
            stories.forEach(story => {
                const storyItem = document.createElement('div');
                storyItem.className = `story-item ${currentStory === story ? 'active' : ''}`;
                storyItem.textContent = story;
                storyItem.addEventListener('click', () => {
                    currentStory = story;
                    renderVideoList();
                    storiesMenu.classList.remove('active');
                });
                storyItem.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    currentStory = story;
                    renderVideoList();
                    storiesMenu.classList.remove('active');
                });
                storyList.appendChild(storyItem);
            });
        }

        function renderVideoList() {
            videoList.innerHTML = '';
            
            if (videos.length === 0) {
                videoList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #8a93a7;">
                        <i class="fas fa-film" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>No videos available</div>
                    </div>
                `;
                return;
            }
            
            let videosToShow = videos;
            
            // Filter by selected story
            if (currentStory) {
                videosToShow = videos.filter(v => v.storyName === currentStory);
                backButton.style.display = 'flex';
            } else {
                backButton.style.display = 'none';
            }
            
            // Apply sorting
            videosToShow = applySorting(videosToShow);
            
            videosToShow.forEach(video => {
                const isFree = video.passwordType === 'free';
                const isUnlocked = isFree || unlockedVideos.has(video.id) || 
                                 (video.storyName && unlockedVideos.has(video.storyName));
                const isCached = preloadedVideos.has(video.id);
                
                const videoItem = document.createElement('div');
                videoItem.className = `video-item ${!isUnlocked ? 'locked' : 'unlocked'} ${isFree ? 'free' : ''}`;
                
                let cacheIndicator = '';
                if (isCached) {
                    cacheIndicator = '<i class="fas fa-hdd" style="color: #00ff00; margin-left: 5px; font-size: 10px;"></i>';
                }
                
                videoItem.innerHTML = `
                    <div class="video-info">
                        <div class="video-name">${video.name}${cacheIndicator}</div>
                        <div class="video-meta">
                            ${video.type || 'Video'} ${video.storyName ? `‚Ä¢ ${video.storyName}` : ''}
                        </div>
                    </div>
                    <div class="video-actions">
                        ${isFree ? '<span class="free-badge">FREE</span>' : ''}
                        <button class="action-btn play" data-action="play" data-id="${video.id}">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                `;
                
                videoList.appendChild(videoItem);
            });
        }

        function renderContactList() {
            contactList.innerHTML = '';
            
            if (contactLinks.length === 0) {
                contactList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #8a93a7;">
                        <i class="fas fa-link" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>No contact links available</div>
                    </div>
                `;
                return;
            }
            
            contactLinks.forEach(link => {
                const linkItem = document.createElement('div');
                linkItem.className = 'video-item';
                
                let icon = 'fa-link';
                let color = '#ff9900';
                
                switch(link.type) {
                    case 'facebook': icon = 'fa-facebook'; color = '#1877F2'; break;
                    case 'telegram': icon = 'fa-telegram'; color = '#0088cc'; break;
                    case 'viber': icon = 'fa-viber'; color = '#7360F2'; break;
                }
                
                linkItem.innerHTML = `
                    <div class="video-info">
                        <div class="video-name">${link.name}</div>
                        <div class="video-meta">${link.type.charAt(0).toUpperCase() + link.type.slice(1)}</div>
                    </div>
                    <a href="${link.url}" target="_blank" class="action-btn play" 
                       style="text-decoration: none; background: ${color};">
                        <i class="fab ${icon}"></i>
                    </a>
                `;
                
                contactList.appendChild(linkItem);
            });
        }

        // ==================== VIDEO FUNCTIONS ====================
        function playVideo(video) {
            try {
                showLoading('Loading video...');
                
                // Check internet connection before playing
                if (!navigator.onLine && !preloadedVideos.has(video.id)) {
                    hideLoading();
                    noInternetModal.style.display = 'flex';
                    return;
                }
                
                // Reset video player state
                videoPlayer.pause();
                videoPlayer.currentTime = 0;
                
                defaultImage.style.display = 'none';
                videoPlayer.style.display = 'block';
                fullscreenBtn.style.display = 'block';
                
                // Check if video is cached
                if (preloadedVideos.has(video.id)) {
                    videoPlayer.src = video.url;
                    showToast('Playing from cache', 'info');
                } else {
                    videoPlayer.src = video.url;
                }
                
                // Add security attributes
                videoPlayer.setAttribute('controlsList', 'nodownload noremoteplayback');
                videoPlayer.setAttribute('disablepictureinpicture', 'true');
                
                // Android optimization
                videoPlayer.load();
                
                // Set video quality based on network
                adjustVideoQualityForNetwork();
                
                videoPlayer.oncanplay = () => {
                    hideLoading();
                    
                    // Try to play with a small delay for Android
                    setTimeout(() => {
                        videoPlayer.play().catch(e => {
                            console.log('Auto-play prevented:', e);
                            // Android ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ user interaction ·Äô·Äï·Ä´·Äò·Ä≤ play ·Äô·Äú·ÄØ·Äï·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äõ·ÄÑ·Ä∫
                            videoPlayer.controls = true;
                        });
                    }, 300);
                    
                    // Highlight playing video
                    document.querySelectorAll('.video-item').forEach(item => {
                        item.classList.remove('playing');
                    });
                    
                    const currentItem = Array.from(document.querySelectorAll('.video-item')).find(item => {
                        const nameDiv = item.querySelector('.video-name');
                        return nameDiv && nameDiv.textContent.includes(video.name);
                    });
                    
                    if (currentItem) {
                        currentItem.classList.add('playing');
                    }
                };
                
                videoPlayer.onerror = () => {
                    hideLoading();
                    showToast('Error loading video', 'error');
                    defaultImage.style.display = 'flex';
                    videoPlayer.style.display = 'none';
                    fullscreenBtn.style.display = 'none';
                };
                
                // Track play time
                lastPlayTime = Date.now();
                
            } catch (error) {
                hideLoading();
                showToast('Error playing video', 'error');
                console.error('Play video error:', error);
            }
        }

        function adjustVideoQualityForNetwork() {
            if (networkQuality === 'slow-2g' || networkQuality === '2g') {
                // Slow network - reduce buffering
                videoPlayer.preload = 'none';
                videoPlayer.playbackRate = 0.8;
            } else if (networkQuality === '3g') {
                // Medium network - moderate buffering
                videoPlayer.preload = 'metadata';
                videoPlayer.playbackRate = 1.0;
            } else {
                // Good network - normal buffering
                videoPlayer.preload = 'auto';
                videoPlayer.playbackRate = 1.0;
            }
        }

        // ==================== MODAL FUNCTIONS ====================
        function showVideoPasswordModal() {
            videoPasswordModal.style.display = 'flex';
            videoPassword.value = '';
            videoPasswordStatus.textContent = '';
            videoPassword.focus();
            
            // Android keyboard ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫
            setTimeout(() => {
                if (videoPassword.scrollIntoViewIfNeeded) {
                    videoPassword.scrollIntoViewIfNeeded();
                }
            }, 100);
        }

        function closeVideoPasswordModal() {
            videoPasswordModal.style.display = 'none';
            videoPassword.value = '';
            videoPasswordStatus.textContent = '';
            currentVideoToUnlock = null;
        }

        // ==================== SCREEN NAVIGATION ====================
        function showScreen(screenNumber) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(`screen${screenNumber}`).classList.add('active');
            
            // Pause video when switching screens
            if (!videoPlayer.paused) {
                videoPlayer.pause();
            }
            
            // Hide modals when switching screens
            videoPasswordModal.style.display = 'none';
            noInternetModal.style.display = 'none';
            storageModal.style.display = 'none';
            
            // Hide fullscreen button
            fullscreenBtn.style.display = 'none';
            
            // Collapse password section when switching screens
            collapsePasswordSection();
            
            // Scroll to top when changing screens
            window.scrollTo(0, 0);
            
            // Android keyboard ·Äï·Ä≠·Äê·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            if (document.activeElement && document.activeElement.blur) {
                document.activeElement.blur();
            }
        }

        function handleBackButton() {
            if (currentStory) {
                currentStory = null;
                renderVideoList();
            }
        }

        // ==================== FULL SCREEN FUNCTIONS ====================
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                if (videoPlayer.requestFullscreen) {
                    videoPlayer.requestFullscreen();
                } else if (videoPlayer.webkitRequestFullscreen) {
                    videoPlayer.webkitRequestFullscreen();
                } else if (videoPlayer.mozRequestFullScreen) {
                    videoPlayer.mozRequestFullScreen();
                } else if (videoPlayer.msRequestFullscreen) {
                    videoPlayer.msRequestFullscreen();
                }
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
        }

        function handleFullScreenChange() {
            if (!document.fullscreenElement && !document.webkitIsFullScreen && !document.mozFullScreen && !document.msFullscreenElement) {
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
        }

        // ==================== NETWORK FUNCTIONS ====================
        function updateConnectionStatus() {
            isOnline = navigator.onLine;
            
            if (isOnline) {
                connectionStatus.className = 'connection-status';
                connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> Online';
                
            } else {
                connectionStatus.className = 'connection-status offline';
                connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline';
                
                // Show no internet modal
                noInternetModal.style.display = 'flex';
            }
        }

        // ==================== UI FEEDBACK FUNCTIONS ====================
        function showToast(message, type = 'info') {
            const icon = type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        'fa-info-circle';
            
            const color = type === 'success' ? '#00ff00' :
                         type === 'error' ? '#ff3e3e' : '#ff9900';
            
            toast.innerHTML = `<i class="fas ${icon}" style="color: ${color};"></i> ${message}`;
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function showLoading(text = 'Loading...') {
            loadingText.textContent = text;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function loadCustomImage() {
            appImage.onload = function() {
                appImage.style.display = 'block';
                defaultImage.querySelector('div').style.display = 'none';
            };
            appImage.onerror = function() {
                appImage.style.display = 'none';
                defaultImage.querySelector('div').style.display = 'block';
            };
            appImage.src = CONFIG.CUSTOM_IMAGE_URL;
        }

        // ==================== MEMORY MANAGEMENT ====================
        function clearVideoCache() {
            // Clear video src to free memory
            if (videoPlayer.src) {
                videoPlayer.src = '';
                videoPlayer.load();
            }
            
            // Clear any blob URLs
            if (videoPlayer.src && videoPlayer.src.startsWith('blob:')) {
                URL.revokeObjectURL(videoPlayer.src);
            }
        }

        // ==================== CLEANUP OLD CACHE ====================
        function cleanupExpiredCache() {
            const now = Date.now();
            const expiryTime = CONFIG.CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('video_cache_')) {
                    try {
                        const cacheData = JSON.parse(localStorage.getItem(key));
                        if (now - cacheData.timestamp > expiryTime) {
                            localStorage.removeItem(key);
                            preloadedVideos.delete(cacheData.id);
                            delete cachedVideos[cacheData.id];
                        }
                    } catch (error) {
                        localStorage.removeItem(key);
                    }
                }
            }
            
            updateStorageInfo();
        }

        // ==================== INITIALIZE APP ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Android ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ initial setup
            document.body.style.overflow = 'auto';
            document.body.style.height = '100%';
            
            // Set Android-specific optimizations
            if (navigator.userAgent.toLowerCase().indexOf('android') > -1) {
                document.body.classList.add('android-optimized');
                
                // Disable some animations for better performance
                document.querySelectorAll('.video-item, .story-item').forEach(el => {
                    el.style.transition = 'transform 0.1s ease';
                });
                
                // Fix scrolling issues on Android
                document.body.style.overflowScrolling = 'touch';
                document.body.style.webkitOverflowScrolling = 'touch';
                
                // Show SD card option only if available
                try {
                    if (typeof window.requestFileSystem !== 'undefined' || 
                        typeof window.webkitRequestFileSystem !== 'undefined') {
                        selectSDCard.style.display = 'flex';
                    }
                } catch (error) {
                    console.log('SD card not available');
                }
            }
            
            // Clean up old cache
            cleanupExpiredCache();
            
            // Initialize app
            initApp();
            
            // Prevent pull-to-refresh on mobile
            document.body.style.overscrollBehavior = 'none';
            
            // Android keyboard ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    if (document.activeElement && document.activeElement.blur) {
                        document.activeElement.blur();
                    }
                }, 100);
            });
            
            // Clean up on page unload
            window.addEventListener('beforeunload', function() {
                clearVideoCache();
            });
            
            // Handle visibility change
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    clearVideoCache();
                }
            });
        });

        // Android back button ·ÄÄ·Ä≠·ÄØ handle ·Äú·ÄØ·Äï·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        document.addEventListener('backbutton', function(e) {
            e.preventDefault();
            if (currentStory) {
                currentStory = null;
                renderVideoList();
            } else if (videoPasswordModal.style.display === 'flex') {
                closeVideoPasswordModal();
            } else if (noInternetModal.style.display === 'flex') {
                noInternetModal.style.display = 'none';
            } else if (passwordResetModal.style.display === 'flex') {
                passwordResetModal.style.display = 'none';
            } else if (storageModal.style.display === 'flex') {
                storageModal.style.display = 'none';
            } else if (preloadProgressEl.style.display === 'block') {
                preloadProgressEl.style.display = 'none';
            } else {
                // Default back behavior
                if (document.getElementById('screen2').classList.contains('active')) {
                    showScreen(1);
                }
            }
        }, false);
    </script>
</body>
</html>