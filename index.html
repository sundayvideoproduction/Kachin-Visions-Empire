<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>QuickChat Messenger</title>
    
    <!-- Android App Meta Tags -->
    <meta name="theme-color" content="#6a11cb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QuickChat">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons for various devices -->
    <link rel="icon" type="image/png" href="icons/icon-72.png">
    <link rel="apple-touch-icon" href="icons/icon-152.png">
    
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Add these styles to your existing CSS */
        
        /* Android Status Bar Fix */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        /* Prevent text selection */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* Allow selection in message input */
        textarea, input {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* Better touch targets */
        button, .chat-card, .contact-item, .action-item {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Hide scrollbars but keep functionality */
        ::-webkit-scrollbar {
            display: none;
        }
        
        /* Pull to refresh indicator */
        .refresh-indicator {
            position: fixed;
            top: -60px;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10004;
            transition: transform 0.3s;
        }
        
        /* Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10005;
            transition: opacity 0.5s;
        }
        
        .splash-logo {
            font-size: 72px;
            color: white;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Android Back Button Handler */
        .back-button {
            display: none;
        }
        
        /* Fullscreen mode adjustments */
        @media (display-mode: fullscreen) {
            .app-header {
                padding-top: calc(15px + env(safe-area-inset-top));
            }
        }
        
        /* Prevent zoom on mobile */
        input, textarea {
            font-size: 16px !important;
        }
        
        /* Better message input for Android */
        .message-input {
            -webkit-appearance: none;
            border-radius: 25px !important;
            font-size: 16px !important;
        }
        
        /* Keyboard avoidance */
        .message-input-area {
            transition: transform 0.3s;
        }
        
        /* Add to your existing dark mode styles */
        @media (prefers-color-scheme: dark) {
            body:not(.light-mode) {
                background: #121212;
                color: #e0e0e0;
            }
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">
            <i class="fas fa-comment-dots"></i>
        </div>
        <div style="color: white; font-size: 24px; font-weight: bold; margin-top: 20px;">
            QuickChat
        </div>
        <div style="color: rgba(255, 255, 255, 0.8); margin-top: 10px;">
            Loading...
        </div>
    </div>
    
    <!-- Rest of your HTML content remains the same -->
    <!-- Loading Screen, Auth Screen, Main App, etc. -->
    
    <script>
        // =========================================================================
        // ANDROID SPECIFIC ENHANCEMENTS
        // =========================================================================
        
        // Handle Android back button
        let backButtonPressed = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Hide splash screen after load
            setTimeout(() => {
                document.getElementById('splashScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splashScreen').style.display = 'none';
                }, 500);
            }, 1500);
            
            // Initialize Android features
            initAndroidFeatures();
        });
        
        function initAndroidFeatures() {
            // Detect if running in WebView/Android
            const isAndroid = /Android/i.test(navigator.userAgent);
            const isWebView = !(window.chrome && window.chrome.webview);
            
            if (isAndroid) {
                // Add Android-specific classes
                document.body.classList.add('android-app');
                
                // Prevent bounce/overscroll
                document.body.style.overscrollBehavior = 'none';
                
                // Handle back button (for WebView)
                if (isWebView && window.Android) {
                    setupBackButtonHandler();
                }
                
                // Handle keyboard events
                setupKeyboardHandling();
                
                // Setup pull-to-refresh
                setupPullToRefresh();
            }
            
            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            }
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Add to home screen prompt
            setupAddToHomeScreen();
        }
        
        function setupBackButtonHandler() {
            // For Android WebView back button
            document.addEventListener('backbutton', function(e) {
                e.preventDefault();
                
                const activePage = document.querySelector('.page.active');
                if (activePage.id === 'chatPage') {
                    goBackToChats();
                } else if (activePage.id !== 'chatsPage') {
                    showPage('chatsPage');
                } else {
                    // Exit app on double back press
                    if (!backButtonPressed) {
                        backButtonPressed = true;
                        showToast('Press back again to exit', 'info');
                        
                        setTimeout(() => {
                            backButtonPressed = false;
                        }, 2000);
                    } else {
                        if (window.Android && window.Android.exitApp) {
                            window.Android.exitApp();
                        }
                    }
                }
            }, false);
        }
        
        function setupKeyboardHandling() {
            const messageInput = document.getElementById('messageInput');
            const inputArea = document.querySelector('.message-input-area');
            
            if (messageInput && inputArea) {
                messageInput.addEventListener('focus', function() {
                    // Scroll to bottom when keyboard appears
                    setTimeout(() => {
                        const messagesContainer = document.getElementById('chatMessages');
                        if (messagesContainer) {
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                        // Move input area up if needed
                        inputArea.style.transform = 'translateY(-20px)';
                    }, 300);
                });
                
                messageInput.addEventListener('blur', function() {
                    // Reset position
                    inputArea.style.transform = 'translateY(0)';
                });
            }
            
            // Prevent zoom on double-tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }
        
        function setupPullToRefresh() {
            let startY = 0;
            let currentY = 0;
            const refreshIndicator = document.createElement('div');
            refreshIndicator.className = 'refresh-indicator';
            refreshIndicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';
            document.body.appendChild(refreshIndicator);
            
            document.addEventListener('touchstart', function(e) {
                if (window.scrollY === 0) {
                    startY = e.touches[0].pageY;
                }
            });
            
            document.addEventListener('touchmove', function(e) {
                if (startY && window.scrollY === 0) {
                    currentY = e.touches[0].pageY;
                    const diff = currentY - startY;
                    
                    if (diff > 0) {
                        e.preventDefault();
                        refreshIndicator.style.transform = `translateY(${Math.min(diff, 60)}px)`;
                    }
                }
            });
            
            document.addEventListener('touchend', function(e) {
                if (startY && window.scrollY === 0) {
                    const diff = currentY - startY;
                    
                    if (diff > 100) {
                        // Pull to refresh action
                        refreshIndicator.style.transform = 'translateY(60px)';
                        loadUserChats().finally(() => {
                            setTimeout(() => {
                                refreshIndicator.style.transform = 'translateY(-60px)';
                            }, 1000);
                        });
                    } else {
                        refreshIndicator.style.transform = 'translateY(-60px)';
                    }
                    
                    startY = 0;
                    currentY = 0;
                }
            });
        }
        
        function setupAddToHomeScreen() {
            let deferredPrompt;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent Chrome 67 and earlier from automatically showing the prompt
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                
                // Show install button (optional)
                showInstallButton();
            });
            
            function showInstallButton() {
                const installBtn = document.createElement('button');
                installBtn.innerHTML = '<i class="fas fa-download"></i> Install App';
                installBtn.style.cssText = `
                    position: fixed;
                    bottom: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 25px;
                    font-size: 14px;
                    font-weight: bold;
                    z-index: 10006;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    display: flex;
                    align-items: center;
                    gap: 8px;
                `;
                installBtn.onclick = promptInstall;
                document.body.appendChild(installBtn);
                
                // Auto hide after 10 seconds
                setTimeout(() => {
                    installBtn.style.opacity = '0';
                    setTimeout(() => installBtn.remove(), 300);
                }, 10000);
            }
            
            function promptInstall() {
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted install');
                    } else {
                        console.log('User dismissed install');
                    }
                    deferredPrompt = null;
                });
            }
        }
        
        // =========================================================================
        // NOTIFICATION HANDLING
        // =========================================================================
        function showNativeNotification(title, body, icon = 'icons/icon-72.png') {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: icon,
                    badge: 'icons/icon-72.png',
                    tag: 'quickchat-notification',
                    requireInteraction: false
                });
                
                notification.onclick = function() {
                    window.focus();
                    this.close();
                };
                
                return notification;
            }
            return null;
        }
        
        // Modify handleIncomingMessage to show native notifications
        function handleIncomingMessage(message) {
            // ... existing code ...
            
            if (!document.hasFocus()) {
                const sender = appState.users.find(u => u.id === message.sender_id);
                if (sender) {
                    showNativeNotification(
                        sender.display_name || sender.username,
                        message.message.length > 50 
                            ? message.message.substring(0, 50) + '...' 
                            : message.message
                    );
                }
            }
            
            // ... rest of existing code ...
        }
        
        // =========================================================================
        // OFFLINE CAPABILITIES
        // =========================================================================
        function setupOfflineSupport() {
            // Check online status
            window.addEventListener('online', function() {
                updateConnectionStatus(true);
                showToast('Back online. Syncing messages...', 'success');
                // Sync pending messages when back online
                syncPendingMessages();
            });
            
            window.addEventListener('offline', function() {
                updateConnectionStatus(false);
                showToast('You are offline. Messages will be sent when online.', 'warning');
            });
            
            // Cache important assets
            if ('caches' in window) {
                caches.open('quickchat-v1').then(cache => {
                    return cache.addAll([
                        './',
                        './index.html',
                        './manifest.json',
                        './icons/icon-72.png',
                        './icons/icon-152.png',
                        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                        'https://unpkg.com/@supabase/supabase-js@2'
                    ]);
                });
            }
        }
        
        // Call this in initializeApp
        setupOfflineSupport();
    </script>
</body>
</html>