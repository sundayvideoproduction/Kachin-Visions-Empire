<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuickChat Messenger</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6a11cb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Global Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
        }
        
        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Auth Screen */
        #authScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            z-index: 9999;
            padding: 20px;
            overflow-y: auto;
        }
        
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px 0;
        }
        
        .auth-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo-icon {
            font-size: 60px;
            color: #6a11cb;
            margin-bottom: 15px;
        }
        
        .logo-text {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 25px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            box-shadow: 0 2px 10px rgba(106, 17, 203, 0.2);
            color: #6a11cb;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #6a11cb;
        }
        
        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* Main App */
        #mainApp {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            background: #f5f5f5;
        }
        
        /* Header */
        .header {
            background: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            display: flex;
            background: white;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
        }
        
        .nav-item.active {
            color: #6a11cb;
        }
        
        .nav-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }
        
        /* Content Area */
        .content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            display: none;
            padding-bottom: 80px;
        }
        
        .page.active {
            display: block;
        }
        
        /* Chats Page */
        .search-bar {
            padding: 15px;
            background: white;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px;
            background: #f9f9f9;
        }
        
        .chats-list {
            padding: 10px;
        }
        
        .chat-item {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chat-item:active {
            background: #f9f9f9;
            transform: scale(0.99);
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }
        
        /* Chat Page */
        .chat-header {
            background: white;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .back-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: #666;
            cursor: pointer;
            padding: 8px;
        }
        
        .messages-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 10px;
            font-size: 15px;
            line-height: 1.4;
        }
        
        .message.sent {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .message.received {
            background: white;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .message-input-area {
            background: white;
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 25px;
            font-size: 16px;
            resize: none;
            max-height: 120px;
        }
        
        .send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Alerts */
        .alert {
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }
        
        .alert.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        
        .alert.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }
        
        /* Status Bar */
        .status-bar {
            background: #4CAF50;
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 14px;
            display: none;
        }
        
        .status-bar.offline {
            background: #f44336;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            display: none;
            max-width: 80%;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <div style="font-size: 18px; margin-top: 10px;">Loading QuickChat...</div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen">
        <div class="auth-container">
            <div class="auth-card">
                <div class="logo">
                    <div class="logo-icon"><i class="fas fa-comment-dots"></i></div>
                    <div class="logo-text">QuickChat</div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="showTab('login')">Login</div>
                    <div class="tab" onclick="showTab('signup')">Sign Up</div>
                </div>
                
                <!-- Login Form -->
                <div id="loginForm" style="display: block;">
                    <div class="alert error" id="loginError"></div>
                    
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" id="loginUsername" placeholder="Enter username" value="user1">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter password" value="password123">
                    </div>
                    
                    <button class="btn" onclick="login()" id="loginBtn">
                        <span>Sign In</span>
                    </button>
                </div>
                
                <!-- Signup Form -->
                <div id="signupForm" style="display: none;">
                    <div class="alert error" id="signupError"></div>
                    
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" id="signupUsername" placeholder="Choose username">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="signupPassword" placeholder="Choose password">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Display Name</label>
                        <input type="text" class="form-input" id="signupDisplayName" placeholder="Your display name">
                    </div>
                    
                    <button class="btn" onclick="signup()" id="signupBtn">
                        <span>Create Account</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp">
        <!-- Status Bar -->
        <div class="status-bar" id="statusBar">Connected</div>
        
        <!-- Header -->
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div style="font-weight: bold; font-size: 16px;" id="userName">User</div>
                    <div style="font-size: 12px; color: #666;" id="userStatus">Online</div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="toggleTheme()" style="background: none; border: none; font-size: 20px; color: #666; cursor: pointer; padding: 8px;">
                    <i class="fas fa-moon"></i>
                </button>
                <button onclick="logout()" style="background: none; border: none; font-size: 20px; color: #666; cursor: pointer; padding: 8px;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="content">
            <!-- Chats Page -->
            <div class="page active" id="chatsPage">
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Search conversations..." id="searchInput">
                </div>
                <div class="chats-list" id="chatsList">
                    <!-- Chats will be loaded here -->
                </div>
            </div>
            
            <!-- Contacts Page -->
            <div class="page" id="contactsPage">
                <div style="padding: 20px; background: white; text-align: center;">
                    <h2 style="margin-bottom: 10px;">Contacts</h2>
                    <p style="color: #666;">Connect with other users</p>
                </div>
                <div class="chats-list" id="contactsList">
                    <!-- Contacts will be loaded here -->
                </div>
            </div>
            
            <!-- Chat Page -->
            <div class="page" id="chatPage">
                <div class="chat-header">
                    <button class="back-btn" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                        <div class="user-avatar" id="chatAvatar">U</div>
                        <div>
                            <div style="font-weight: bold; font-size: 16px;" id="chatUserName">User</div>
                            <div style="font-size: 12px; color: #4CAF50;" id="chatUserStatus">Online</div>
                        </div>
                    </div>
                </div>
                
                <div class="messages-area" id="messagesArea">
                    <!-- Messages will appear here -->
                </div>
                
                <div class="message-input-area">
                    <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            
            <!-- Profile Page -->
            <div class="page" id="profilePage">
                <div style="padding: 30px 20px; background: white; text-align: center;">
                    <div class="user-avatar" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto 15px;" id="profileAvatar">U</div>
                    <h2 style="margin-bottom: 5px;" id="profileName">User Name</h2>
                    <p style="color: #666;" id="profileUsername">@username</p>
                </div>
                
                <div style="padding: 20px;">
                    <div style="background: white; border-radius: 15px; overflow: hidden;">
                        <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; cursor: pointer;">
                            <div style="width: 40px; height: 40px; background: #f0f0f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #6a11cb;">
                                <i class="fas fa-user-edit"></i>
                            </div>
                            <div style="flex: 1;">Edit Profile</div>
                            <i class="fas fa-chevron-right" style="color: #999;"></i>
                        </div>
                        
                        <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; cursor: pointer;">
                            <div style="width: 40px; height: 40px; background: #f0f0f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #6a11cb;">
                                <i class="fas fa-cog"></i>
                            </div>
                            <div style="flex: 1;">Settings</div>
                            <i class="fas fa-chevron-right" style="color: #999;"></i>
                        </div>
                        
                        <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; cursor: pointer;">
                            <div style="width: 40px; height: 40px; background: #f0f0f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #6a11cb;">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div style="flex: 1;">Help & Support</div>
                            <i class="fas fa-chevron-right" style="color: #999;"></i>
                        </div>
                    </div>
                    
                    <button onclick="logout()" style="width: 100%; padding: 15px; background: #f44336; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; margin-top: 20px; cursor: pointer;">
                        Logout
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showPage('chatsPage')">
                <div class="nav-icon"><i class="fas fa-comments"></i></div>
                <div style="font-size: 12px;">Chats</div>
            </button>
            <button class="nav-item" onclick="showPage('contactsPage')">
                <div class="nav-icon"><i class="fas fa-users"></i></div>
                <div style="font-size: 12px;">Contacts</div>
            </button>
            <button class="nav-item" onclick="showPage('profilePage')">
                <div class="nav-icon"><i class="fas fa-user"></i></div>
                <div style="font-size: 12px;">Profile</div>
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Audio for notifications -->
    <audio id="notificationSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" type="audio/mpeg">
    </audio>

    <script>
        // App Configuration
        const APP_CONFIG = {
            SUPABASE_URL: 'https://apmhwagvmjajitsagruk.supabase.co',
            SUPABASE_KEY: 'sb_publishable_OSovGbln41HG96yLOuxwAA_fIKU73gQ',
            APP_NAME: 'QuickChat',
            VERSION: '1.0.0'
        };

        // App State
        let currentUser = null;
        let activeChat = null;
        let users = [];
        let messages = {};
        let onlineUsers = new Set();
        let isOnline = true;

        // Initialize App
        window.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            console.log('Initializing QuickChat...');
            
            // Hide loading screen after 2 seconds
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                
                // Check for saved user session
                const savedUser = localStorage.getItem('quickchat_user');
                if (savedUser) {
                    try {
                        currentUser = JSON.parse(savedUser);
                        startApp();
                    } catch (e) {
                        showAuthScreen();
                    }
                } else {
                    showAuthScreen();
                }
            }, 2000);
            
            // Setup event listeners
            setupEventListeners();
            
            // Check online status
            checkOnlineStatus();
        }

        function setupEventListeners() {
            // Enter key for message sending
            document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-resize textarea
            document.getElementById('messageInput')?.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // Search functionality
            document.getElementById('searchInput')?.addEventListener('input', function(e) {
                filterChats(e.target.value);
            });
            
            // Online/offline detection
            window.addEventListener('online', () => {
                isOnline = true;
                updateStatusBar(true);
                showToast('Back online');
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateStatusBar(false);
                showToast('You are offline');
            });
        }

        // Authentication Functions
        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            showTab('login');
        }

        function showTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (tabName === 'login') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('signupForm').style.display = 'none';
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'block';
            }
            
            // Clear alerts
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('signupError').style.display = 'none';
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn');
            
            if (!username || !password) {
                showAlert(errorEl, 'Please enter username and password');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
            
            try {
                // For demo purposes - using mock authentication
                // In real app, you would call Supabase here
                await mockLogin(username, password);
                
                // Save user session
                localStorage.setItem('quickchat_user', JSON.stringify(currentUser));
                
                // Start the app
                startApp();
                showToast('Welcome back!');
                
            } catch (error) {
                showAlert(errorEl, error.message);
                btn.disabled = false;
                btn.innerHTML = 'Sign In';
            }
        }

        async function mockLogin(username, password) {
            // Mock authentication for demo
            // Replace this with actual Supabase authentication
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    if (username && password) {
                        // Create mock user data
                        currentUser = {
                            id: 'user_' + Date.now(),
                            username: username,
                            display_name: username.charAt(0).toUpperCase() + username.slice(1),
                            role: 'user',
                            created_at: new Date().toISOString()
                        };
                        resolve(currentUser);
                    } else {
                        reject(new Error('Invalid credentials'));
                    }
                }, 1000);
            });
        }

        async function signup() {
            const username = document.getElementById('signupUsername').value.trim();
            const password = document.getElementById('signupPassword').value;
            const displayName = document.getElementById('signupDisplayName').value.trim() || username;
            const errorEl = document.getElementById('signupError');
            const btn = document.getElementById('signupBtn');
            
            if (!username || !password) {
                showAlert(errorEl, 'Username and password are required');
                return;
            }
            
            if (username.length < 3) {
                showAlert(errorEl, 'Username must be at least 3 characters');
                return;
            }
            
            if (password.length < 6) {
                showAlert(errorEl, 'Password must be at least 6 characters');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
            
            try {
                // Mock signup for demo
                await mockSignup(username, password, displayName);
                
                // Save user session
                localStorage.setItem('quickchat_user', JSON.stringify(currentUser));
                
                // Start the app
                startApp();
                showToast('Account created successfully!');
                
            } catch (error) {
                showAlert(errorEl, error.message);
                btn.disabled = false;
                btn.innerHTML = 'Create Account';
            }
        }

        async function mockSignup(username, password, displayName) {
            // Mock signup for demo
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    if (username && password) {
                        // Check if username exists in localStorage
                        const existingUsers = JSON.parse(localStorage.getItem('quickchat_users') || '[]');
                        const userExists = existingUsers.some(u => u.username === username);
                        
                        if (userExists) {
                            reject(new Error('Username already taken'));
                            return;
                        }
                        
                        // Create new user
                        currentUser = {
                            id: 'user_' + Date.now(),
                            username: username,
                            display_name: displayName,
                            password: password, // Note: In real app, hash this password!
                            role: 'user',
                            created_at: new Date().toISOString()
                        };
                        
                        // Save to mock database
                        existingUsers.push(currentUser);
                        localStorage.setItem('quickchat_users', JSON.stringify(existingUsers));
                        
                        resolve(currentUser);
                    } else {
                        reject(new Error('Please fill all required fields'));
                    }
                }, 1500);
            });
        }

        // Main App Functions
        function startApp() {
            console.log('Starting app for user:', currentUser.username);
            
            // Hide auth screen, show main app
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            // Update user interface
            updateUserInterface();
            
            // Load initial data
            loadInitialData();
            
            // Start polling for updates
            startPolling();
        }

        function updateUserInterface() {
            if (!currentUser) return;
            
            const firstLetter = currentUser.display_name?.charAt(0).toUpperCase() || 
                              currentUser.username.charAt(0).toUpperCase();
            
            // Update user avatar and name
            document.getElementById('userAvatar').textContent = firstLetter;
            document.getElementById('userName').textContent = currentUser.display_name || currentUser.username;
            
            document.getElementById('profileAvatar').textContent = firstLetter;
            document.getElementById('profileName').textContent = currentUser.display_name || currentUser.username;
            document.getElementById('profileUsername').textContent = '@' + currentUser.username;
        }

        function loadInitialData() {
            // Load mock users
            loadMockUsers();
            
            // Load mock chats
            loadMockChats();
            
            // Update statistics
            updateStatistics();
        }

        function loadMockUsers() {
            // Create mock users for demo
            const mockUsers = [
                {
                    id: 'user_1',
                    username: 'john_doe',
                    display_name: 'John Doe',
                    role: 'user',
                    online: true
                },
                {
                    id: 'user_2',
                    username: 'jane_smith',
                    display_name: 'Jane Smith',
                    role: 'user',
                    online: true
                },
                {
                    id: 'user_3',
                    username: 'alex_wong',
                    display_name: 'Alex Wong',
                    role: 'user',
                    online: false
                },
                {
                    id: 'user_4',
                    username: 'sarah_lee',
                    display_name: 'Sarah Lee',
                    role: 'user',
                    online: true
                }
            ];
            
            users = mockUsers;
            
            // Mark some as online
            onlineUsers.add('user_1');
            onlineUsers.add('user_2');
            onlineUsers.add('user_4');
            
            // Render contacts list
            renderContactsList();
        }

        function loadMockChats() {
            // Create mock messages for demo
            const mockMessages = [
                {
                    id: 'msg_1',
                    sender_id: 'user_1',
                    receiver_id: currentUser.id,
                    message: 'Hello! How are you today?',
                    timestamp: new Date(Date.now() - 3600000).toISOString(),
                    read: true
                },
                {
                    id: 'msg_2',
                    sender_id: currentUser.id,
                    receiver_id: 'user_1',
                    message: 'I\'m good, thanks! How about you?',
                    timestamp: new Date(Date.now() - 1800000).toISOString(),
                    read: true
                },
                {
                    id: 'msg_3',
                    sender_id: 'user_2',
                    receiver_id: currentUser.id,
                    message: 'Did you finish the project?',
                    timestamp: new Date(Date.now() - 7200000).toISOString(),
                    read: false
                },
                {
                    id: 'msg_4',
                    sender_id: 'user_4',
                    receiver_id: currentUser.id,
                    message: 'Let\'s meet tomorrow at 3 PM',
                    timestamp: new Date(Date.now() - 86400000).toISOString(),
                    read: true
                }
            ];
            
            // Group messages by user
            mockMessages.forEach(msg => {
                const contactId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
                if (!messages[contactId]) {
                    messages[contactId] = [];
                }
                messages[contactId].push(msg);
            });
            
            // Render chats list
            renderChatsList();
        }

        function renderContactsList() {
            const container = document.getElementById('contactsList');
            if (!container) return;
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px 20px; color: #666;">
                        <i class="fas fa-user-plus" style="font-size: 40px; margin-bottom: 15px; color: #ddd;"></i>
                        <p>No contacts available</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            users.forEach(user => {
                if (user.id === currentUser.id) return;
                
                const isOnline = onlineUsers.has(user.id);
                const firstLetter = user.display_name.charAt(0).toUpperCase();
                
                const div = document.createElement('div');
                div.className = 'chat-item';
                div.onclick = () => startChat(user);
                
                div.innerHTML = `
                    <div class="chat-avatar">${firstLetter}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 16px;">${user.display_name}</div>
                        <div style="font-size: 14px; color: #666;">@${user.username}</div>
                    </div>
                    ${isOnline ? '<div style="width: 10px; height: 10px; background: #4CAF50; border-radius: 50%;"></div>' : ''}
                `;
                
                container.appendChild(div);
            });
        }

        function renderChatsList() {
            const container = document.getElementById('chatsList');
            if (!container) return;
            
            // Get unique contacts from messages
            const contacts = {};
            
            Object.keys(messages).forEach(contactId => {
                const contactMessages = messages[contactId];
                if (contactMessages.length > 0) {
                    const lastMessage = contactMessages[contactMessages.length - 1];
                    const contact = users.find(u => u.id === contactId);
                    
                    if (contact) {
                        contacts[contactId] = {
                            contact: contact,
                            lastMessage: lastMessage,
                            unreadCount: contactMessages.filter(m => 
                                m.sender_id === contactId && !m.read
                            ).length
                        };
                    }
                }
            });
            
            if (Object.keys(contacts).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px 20px; color: #666;">
                        <i class="fas fa-comments" style="font-size: 40px; margin-bottom: 15px; color: #ddd;"></i>
                        <p>No conversations yet</p>
                        <p style="font-size: 14px; margin-top: 5px;">Start chatting with contacts</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            Object.values(contacts).forEach(({ contact, lastMessage, unreadCount }) => {
                const isOnline = onlineUsers.has(contact.id);
                const firstLetter = contact.display_name.charAt(0).toUpperCase();
                const time = formatTime(lastMessage.timestamp);
                const isFromMe = lastMessage.sender_id === currentUser.id;
                const preview = lastMessage.message.length > 30 
                    ? lastMessage.message.substring(0, 30) + '...' 
                    : lastMessage.message;
                
                const div = document.createElement('div');
                div.className = 'chat-item';
                div.onclick = () => startChat(contact);
                
                div.innerHTML = `
                    <div class="chat-avatar">${firstLetter}</div>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between;">
                            <div style="font-weight: bold; font-size: 16px;">${contact.display_name}</div>
                            <div style="font-size: 12px; color: #999;">${time}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 14px; color: #666;">
                                ${isFromMe ? 'You: ' : ''}${preview}
                            </div>
                            ${unreadCount > 0 ? `
                                <div style="background: #6a11cb; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                    ${unreadCount}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ${isOnline ? '<div style="width: 8px; height: 8px; background: #4CAF50; border-radius: 50%;"></div>' : ''}
                `;
                
                container.appendChild(div);
            });
        }

        function filterChats(searchTerm) {
            const chatItems = document.querySelectorAll('.chat-item');
            const term = searchTerm.toLowerCase();
            
            chatItems.forEach(item => {
                const name = item.querySelector('div:nth-child(2) > div:first-child').textContent.toLowerCase();
                item.style.display = name.includes(term) ? 'flex' : 'none';
            });
        }

        function startChat(user) {
            activeChat = user;
            
            // Update chat header
            const firstLetter = user.display_name.charAt(0).toUpperCase();
            document.getElementById('chatAvatar').textContent = firstLetter;
            document.getElementById('chatUserName').textContent = user.display_name;
            document.getElementById('chatUserStatus').textContent = 
                onlineUsers.has(user.id) ? 'Online' : 'Offline';
            document.getElementById('chatUserStatus').style.color = 
                onlineUsers.has(user.id) ? '#4CAF50' : '#999';
            
            // Enable message input
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            
            // Load messages
            loadChatMessages(user.id);
            
            // Switch to chat page
            showPage('chatPage');
            
            // Focus input
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 100);
        }

        function loadChatMessages(contactId) {
            const container = document.getElementById('messagesArea');
            if (!container) return;
            
            const chatMessages = messages[contactId] || [];
            
            if (chatMessages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px 20px; color: #999;">
                        <i class="fas fa-comment-dots" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>Start a conversation</p>
                        <p style="font-size: 14px; margin-top: 5px;">Send your first message below</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            // Sort messages by timestamp
            chatMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // Group messages by date
            let currentDate = '';
            
            chatMessages.forEach(msg => {
                const msgDate = formatDate(msg.timestamp);
                if (msgDate !== currentDate) {
                    const dateDiv = document.createElement('div');
                    dateDiv.style.textAlign = 'center';
                    dateDiv.style.margin = '20px 0';
                    dateDiv.style.fontSize = '12px';
                    dateDiv.style.color = '#999';
                    dateDiv.textContent = msgDate;
                    container.appendChild(dateDiv);
                    currentDate = msgDate;
                }
                
                addMessageToChat(msg);
            });
            
            // Scroll to bottom
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function addMessageToChat(message) {
            const container = document.getElementById('messagesArea');
            if (!container) return;
            
            // Remove placeholder if exists
            const placeholder = container.querySelector('div[style*="text-align: center"]');
            if (placeholder && container.children.length > 1) {
                placeholder.remove();
            }
            
            const isSent = message.sender_id === currentUser.id;
            const time = formatTime(message.timestamp);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            
            messageDiv.innerHTML = `
                <div>${escapeHtml(message.message)}</div>
                <div style="font-size: 11px; text-align: right; margin-top: 5px; opacity: 0.8;">
                    ${time}
                </div>
            `;
            
            container.appendChild(messageDiv);
            
            // Scroll to bottom
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 50);
        }

        async function sendMessage() {
            if (!isOnline) {
                showToast('No internet connection');
                return;
            }
            
            if (!activeChat) {
                showToast('No chat selected');
                return;
            }
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            
            try {
                // Create new message
                const newMessage = {
                    id: 'msg_' + Date.now(),
                    sender_id: currentUser.id,
                    receiver_id: activeChat.id,
                    message: message,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                // Add to messages
                if (!messages[activeChat.id]) {
                    messages[activeChat.id] = [];
                }
                messages[activeChat.id].push(newMessage);
                
                // Add to UI
                addMessageToChat(newMessage);
                
                // Clear input
                input.value = '';
                input.style.height = 'auto';
                
                // Play notification sound
                playNotification();
                
                // Update chats list
                renderChatsList();
                
                // Show sent confirmation
                showToast('Message sent');
                
                // Simulate response (for demo)
                if (Math.random() > 0.3) { // 70% chance of reply
                    setTimeout(() => {
                        simulateReply();
                    }, 1000 + Math.random() * 3000);
                }
                
            } catch (error) {
                console.error('Failed to send message:', error);
                showToast('Failed to send message');
            } finally {
                btn.disabled = false;
                input.focus();
            }
        }

        function simulateReply() {
            if (!activeChat || !isOnline) return;
            
            const replies = [
                "That's interesting!",
                "I agree with you.",
                "What do you think about this?",
                "Let me check and get back to you.",
                "Thanks for sharing!",
                "Can you explain more about that?",
                "I'll look into it.",
                "Sounds good to me!",
                "When would be a good time?",
                "Let's discuss this further."
            ];
            
            const randomReply = replies[Math.floor(Math.random() * replies.length)];
            
            const replyMessage = {
                id: 'msg_' + Date.now(),
                sender_id: activeChat.id,
                receiver_id: currentUser.id,
                message: randomReply,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            if (!messages[activeChat.id]) {
                messages[activeChat.id] = [];
            }
            messages[activeChat.id].push(replyMessage);
            
            // Add to UI if on chat page
            if (document.getElementById('chatPage').classList.contains('active')) {
                addMessageToChat(replyMessage);
                playNotification();
                showToast('New message received');
            } else {
                // Update badge on chats page
                renderChatsList();
                playNotification();
                showToast(`New message from ${activeChat.display_name}`);
            }
        }

        // Navigation Functions
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (pageId === 'chatsPage') {
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                renderChatsList();
            } else if (pageId === 'contactsPage') {
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                renderContactsList();
            } else if (pageId === 'profilePage') {
                document.querySelectorAll('.nav-item')[2].classList.add('active');
            }
        }

        function goBack() {
            activeChat = null;
            showPage('chatsPage');
            
            // Clear message input
            const input = document.getElementById('messageInput');
            input.value = '';
            input.style.height = 'auto';
            input.disabled = true;
            
            // Disable send button
            document.getElementById('sendBtn').disabled = true;
        }

        // Utility Functions
        function formatTime(timestamp) {
            try {
                const date = new Date(timestamp);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch {
                return '--:--';
            }
        }

        function formatDate(timestamp) {
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return 'Yesterday';
                if (diffDays < 7) return date.toLocaleDateString([], { weekday: 'long' });
                
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            } catch {
                return '';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateStatistics() {
            const chatCount = Object.keys(messages).length;
            const contactCount = users.length - 1; // Exclude current user
            const onlineCount = onlineUsers.size;
            
            // Update stats if elements exist
            const stats = document.getElementById('stats');
            if (stats) {
                stats.innerHTML = `
                    <div style="display: flex; justify-content: space-around; padding: 20px; background: white; margin: 20px; border-radius: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #6a11cb;">${chatCount}</div>
                            <div style="font-size: 12px; color: #666;">Chats</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #6a11cb;">${contactCount}</div>
                            <div style="font-size: 12px; color: #666;">Contacts</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #6a11cb;">${onlineCount}</div>
                            <div style="font-size: 12px; color: #666;">Online</div>
                        </div>
                    </div>
                `;
            }
        }

        function checkOnlineStatus() {
            isOnline = navigator.onLine;
            updateStatusBar(isOnline);
        }

        function updateStatusBar(online) {
            const statusBar = document.getElementById('statusBar');
            if (!statusBar) return;
            
            if (online) {
                statusBar.textContent = 'Connected';
                statusBar.className = 'status-bar';
                setTimeout(() => {
                    statusBar.style.display = 'none';
                }, 3000);
            } else {
                statusBar.textContent = 'Offline - Check your connection';
                statusBar.className = 'status-bar offline';
                statusBar.style.display = 'block';
            }
        }

        function startPolling() {
            // Check for updates every 10 seconds
            setInterval(() => {
                if (isOnline) {
                    // Simulate random online status changes
                    if (Math.random() > 0.7) {
                        const randomUser = users[Math.floor(Math.random() * users.length)];
                        if (randomUser && randomUser.id !== currentUser.id) {
                            if (onlineUsers.has(randomUser.id)) {
                                onlineUsers.delete(randomUser.id);
                            } else {
                                onlineUsers.add(randomUser.id);
                            }
                            
                            // Update UI if needed
                            if (activeChat && activeChat.id === randomUser.id) {
                                const statusEl = document.getElementById('chatUserStatus');
                                if (statusEl) {
                                    statusEl.textContent = onlineUsers.has(randomUser.id) ? 'Online' : 'Offline';
                                    statusEl.style.color = onlineUsers.has(randomUser.id) ? '#4CAF50' : '#999';
                                }
                            }
                            
                            renderContactsList();
                            renderChatsList();
                        }
                    }
                }
            }, 10000);
        }

        // UI Feedback Functions
        function showAlert(element, message) {
            if (!element) return;
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function playNotification() {
            try {
                const audio = document.getElementById('notificationSound');
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log('Audio play failed:', e));
                }
            } catch (error) {
                console.error('Notification sound error:', error);
            }
        }

        // Theme Functions
        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('dark-theme');
            
            const isDark = body.classList.contains('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            // Update theme icon
            const themeIcon = document.querySelector('.fa-moon');
            if (themeIcon) {
                themeIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            }
            
            showToast(isDark ? 'Dark mode enabled' : 'Light mode enabled');
        }

        // Check saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                const themeIcon = document.querySelector('.fa-moon');
                if (themeIcon) {
                    themeIcon.className = 'fas fa-sun';
                }
            }
        }

        // Initialize theme
        loadTheme();

        // Logout Function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear user session
                localStorage.removeItem('quickchat_user');
                currentUser = null;
                activeChat = null;
                users = [];
                messages = {};
                onlineUsers.clear();
                
                // Show auth screen
                showAuthScreen();
                showToast('Logged out successfully');
            }
        }

        // For WebIntoApp compatibility
        document.addEventListener('deviceready', function() {
            console.log('Device is ready');
            // Cordova specific code can go here
        }, false);

        // Handle Android back button
        document.addEventListener('backbutton', function(e) {
            if (document.getElementById('chatPage').classList.contains('active')) {
                e.preventDefault();
                goBack();
            }
        }, false);

        console.log('QuickChat initialized successfully');
    </script>
</body>
</html>