<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ff9900">
    <meta name="description" content="Kachin Visions Empire - Secure Video Platform">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="apple-touch-startup-image" href="icon-512.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="shortcut icon" href="icon-192.png">
    
    <title>K VE - Kachin Visions Empire</title>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- CryptoJS for Encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CSS ကုဒ်များသည် မူလကုဒ်နှင့် တူညီပါသည် */
        /* မူလ CSS code များ အကုန်လုံး ထည့်သွင်းထားပါသည် */
        /* အောက်တွင်ဖော်ပြထားသော CSS များကိုသာ ထည့်သွင်းပါ */
        
        /* PWA အထူးစတိုင်များ */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
            }
            
            .pwa-header {
                height: calc(40px + env(safe-area-inset-top));
                padding-top: env(safe-area-inset-top);
            }
        }
        
        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 20, 40, 0.95);
            border: 1px solid rgba(255, 153, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            z-index: 5000;
            display: none;
            flex-direction: column;
            gap: 10px;
            backdrop-filter: blur(10px);
            max-width: 350px;
            width: 90%;
            animation: slideUp 0.3s ease;
        }
        
        .install-prompt-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .install-prompt-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #ff9900, #ff6600);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .install-prompt-text {
            flex: 1;
        }
        
        .install-prompt-title {
            font-size: 12px;
            font-weight: bold;
            color: #ff9900;
            margin-bottom: 3px;
        }
        
        .install-prompt-desc {
            font-size: 10px;
            color: #8a93a7;
        }
        
        .install-prompt-buttons {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }
        
        .install-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: none;
            background: #ff9900;
            color: white;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .install-btn.secondary {
            background: rgba(255, 153, 0, 0.2);
            color: #ff9900;
            border: 1px solid rgba(255, 153, 0, 0.3);
        }
        
        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 62, 62, 0.9);
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 11px;
            z-index: 4000;
            display: none;
            backdrop-filter: blur(5px);
        }
        
        /* App Update */
        .app-update {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 204, 136, 0.9);
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 11px;
            z-index: 4000;
            display: none;
            backdrop-filter: blur(5px);
        }
        
        .app-update button {
            background: white;
            color: #00cc88;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-size: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash"></i> You are currently offline
    </div>
    
    <!-- App Update Notification -->
    <div class="app-update" id="appUpdate">
        <i class="fas fa-sync-alt"></i> New version available
        <button id="updateBtn">Update Now</button>
    </div>
    
    <!-- Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <div class="install-prompt-content">
            <div class="install-prompt-icon">
                <i class="fas fa-video"></i>
            </div>
            <div class="install-prompt-text">
                <div class="install-prompt-title">Install K VE App</div>
                <div class="install-prompt-desc">Install for better experience and offline access</div>
            </div>
        </div>
        <div class="install-prompt-buttons">
            <button class="install-btn" id="installBtn">
                <i class="fas fa-download"></i> Install
            </button>
            <button class="install-btn secondary" id="cancelInstall">
                Later
            </button>
        </div>
    </div>

    <!-- Password Status Indicator -->
    <div class="password-indicator locked" id="passwordIndicator">
        <i class="fas fa-lock"></i> <span>Locked</span>
    </div>

    <!-- Device Info Display -->
    <div class="device-info-display" id="deviceInfoDisplay" style="display: none;">
        <i class="fas fa-mobile-alt"></i> <span id="deviceIdShort">Device</span>
    </div>

    <!-- Storage Info -->
    <div class="storage-info" id="storageInfo" style="display: none;">
        <i class="fas fa-hdd"></i> <span id="storageText">0 MB used</span>
    </div>

    <!-- Storage Location Display -->
    <div class="storage-location" id="storageLocation" style="display: none;">
        <i class="fas fa-folder"></i> <span id="locationPath">Select storage location</span>
    </div>

    <!-- Stories Menu -->
    <div class="stories-menu-container">
        <div class="stories-toggle-btn" id="storiesToggle">
            <i class="fas fa-film"></i>
        </div>
        <div class="stories-menu" id="storiesMenu">
            <div class="story-list" id="storyList"></div>
        </div>
    </div>

    <!-- Storage Selection -->
    <div class="storage-selection" id="storageSelection">
        <div class="storage-option" data-storage="default">
            <i class="fas fa-database"></i> Default App Storage
        </div>
        <div class="storage-option" data-storage="local">
            <i class="fas fa-mobile-alt"></i> Local Device Storage
        </div>
        <div class="storage-option" data-storage="sd">
            <i class="fas fa-sd-card"></i> SD Card (if available)
        </div>
        <div class="storage-option" data-storage="custom">
            <i class="fas fa-folder-open"></i> Select Custom Location
        </div>
    </div>

    <!-- Preloading Progress -->
    <div class="preload-progress-container" id="preloadProgress">
        <div class="preload-progress-header">
            <span>Preloading Videos</span>
            <button class="action-btn" id="closePreloadProgress" style="width: 20px; height: 20px; background: transparent; color: #ff9900;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="preload-progress-bar">
            <div class="preload-progress-fill" id="preloadProgressFill" style="width: 0%;"></div>
        </div>
        <div class="preload-progress-text" id="preloadProgressText">Starting...</div>
        <div class="preload-progress-list" id="preloadProgressList"></div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText" style="font-size: 12px;">Loading...</div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-wifi"></i> Online
    </div>

    <!-- Main Screen -->
    <div id="screen1" class="screen active">
        <div class="container">
            <!-- Back Button -->
            <button class="back-btn" id="backButton" style="display: none;">
                <i class="fas fa-arrow-left"></i> Back
            </button>

            <!-- Logo -->
            <div class="logo-container">
                <div class="logo">K VE</div>
                <div class="logo-sub">Kachin Visions Empire - Secure Video Platform</div>
            </div>

            <!-- Password Section -->
            <div class="password-section" id="passwordSection">
                <div class="password-section-title">
                    <i class="fas fa-lock"></i> Device-Locked Access
                </div>
                <div class="password-input-group">
                    <input type="password" class="password-input" id="passwordInput" 
                           placeholder="Enter your access password" autocomplete="off">
                    <button class="password-toggle-btn" id="passwordToggle">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <button class="unlock-btn" id="unlockBtn">
                    <i class="fas fa-unlock"></i> Unlock Videos
                </button>
                <div class="password-status" id="passwordStatus">
                    Each password works on one device only
                </div>
                <div class="device-info" id="deviceInfo">
                    <i class="fas fa-fingerprint"></i> Device ID: Loading...
                </div>
            </div>

            <!-- Video Section -->
            <div class="video-section">
                <div class="video-player-container">
                    <div class="video-player">
                        <!-- Buffering Indicator -->
                        <div class="buffering-indicator" id="bufferingIndicator">
                            <i class="fas fa-spinner fa-spin"></i> Buffering...
                        </div>
                        
                        <!-- Quality Selector -->
                        <div class="quality-selector" id="qualitySelector">
                            <button class="quality-btn" data-quality="auto">Auto</button>
                            <button class="quality-btn" data-quality="360p">360p</button>
                            <button class="quality-btn" data-quality="480p">480p</button>
                        </div>
                        
                        <button class="fullscreen-btn" id="fullscreenBtn" style="display: none;">
                            <i class="fas fa-expand"></i>
                        </button>
                        <div class="default-image" id="defaultImage">
                            <img src="https://res.cloudinary.com/zaumaran/image/upload/v1764932924/Kachin_Vision_Empire_For_Logo_zpkdbg.png" 
                                 alt="K VE" id="appImage" style="display: none;">
                            <div style="text-align: center; color: #ff9900; padding: 20px;">
                                <i class="fas fa-play-circle" style="font-size: 40px; margin-bottom: 10px;"></i>
                                <div style="font-size: 12px;">Enter password to unlock videos</div>
                            </div>
                        </div>
                        <video id="videoPlayer" controls playsinline 
                               controlsList="nodownload noremoteplayback" preload="metadata"
                               style="display: none;"></video>
                    </div>
                </div>

                <div class="video-list-container">
                    <div class="video-list-title">
                        <i class="fas fa-film"></i> Video Library
                    </div>
                    <div class="video-list scrollable" id="videoList"></div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <button class="nav-btn" id="contactBtn">
                    <i class="fas fa-link"></i> Contact Links
                </button>
                <button class="nav-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="nav-btn" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <button class="nav-btn" id="preloadBtn">
                    <i class="fas fa-download"></i> Preload
                </button>
                <button class="nav-btn" id="optimizeBtn">
                    <i class="fas fa-tools"></i> Optimize
                </button>
                <button class="nav-btn" id="storageBtn">
                    <i class="fas fa-hdd"></i> Storage
                </button>
                <button class="nav-btn" id="installAppBtn" style="display: none;">
                    <i class="fas fa-download"></i> Install App
                </button>
            </div>
        </div>
    </div>

    <!-- Contact Links Screen -->
    <div id="screen2" class="screen">
        <div class="container">
            <button class="back-btn" id="backToMain">
                <i class="fas fa-arrow-left"></i> Back
            </button>

            <div class="logo-container">
                <div class="logo">Contact Links</div>
                <div class="logo-sub">Available Links</div>
            </div>

            <div class="video-list-container">
                <div class="video-list-title">
                    <i class="fas fa-link"></i> Available Links
                </div>
                <div class="video-list scrollable" id="contactList"></div>
            </div>
        </div>
    </div>

    <!-- Video Password Modal -->
    <div class="modal" id="videoPasswordModal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-lock"></i> Video Password Required
            </div>
            <div style="margin-bottom: 15px; font-size: 11px; text-align: center;">
                This video requires a password to access.
            </div>
            <div class="password-input-group" style="margin-bottom: 15px;">
                <input type="password" class="password-input" id="videoPassword" 
                       placeholder="Enter video password">
                <button class="password-toggle-btn" id="videoPasswordToggle">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div id="videoPasswordStatus" style="font-size: 10px; text-align: center; margin: 10px 0; color: #ff3e3e; min-height: 14px;"></div>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="submitVideoPassword">
                    <i class="fas fa-unlock"></i> Unlock
                </button>
                <button class="modal-btn secondary" id="cancelVideoPassword">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- No Internet Modal -->
    <div class="modal" id="noInternetModal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-wifi-slash"></i> No Internet Connection
            </div>
            <div style="margin-bottom: 15px; font-size: 11px; text-align: center;">
                Internet connection is required to use this application.
                Please check your connection and try again.
            </div>
            <button class="modal-btn primary" id="retryConnectionBtn">
                <i class="fas fa-redo"></i> Retry
            </button>
        </div>
    </div>

    <!-- Password Reset Confirmation Modal -->
    <div class="modal" id="passwordResetModal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-exclamation-triangle"></i> Password Reset Required
            </div>
            <div style="margin-bottom: 15px; font-size: 11px; text-align: center;">
                This password has been reset by admin or is being used on another device.
                Please enter a new password to continue.
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="confirmPasswordReset">
                    <i class="fas fa-key"></i> Enter New Password
                </button>
            </div>
        </div>
    </div>

    <!-- Storage Selection Modal -->
    <div class="modal" id="storageModal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-hdd"></i> Select Storage Location
            </div>
            <div style="margin-bottom: 15px; font-size: 11px; text-align: center;">
                Choose where to save preloaded videos:
            </div>
            <div class="modal-buttons" style="flex-direction: column;">
                <button class="modal-btn secondary" id="selectDefaultStorage">
                    <i class="fas fa-database"></i> Default App Storage
                </button>
                <button class="modal-btn secondary" id="selectLocalStorage">
                    <i class="fas fa-mobile-alt"></i> Local Device Storage
                </button>
                <button class="modal-btn secondary" id="selectSDCard" style="display: none;">
                    <i class="fas fa-sd-card"></i> SD Card Storage
                </button>
                <button class="modal-btn secondary" id="selectCustomStorage">
                    <i class="fas fa-folder-open"></i> Choose Custom Folder
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            APP_ID: 'kve_video_platform_v5.0',
            ENCRYPTION_KEY: 'KVE_Secure_Device_Locked_Password_System_2024',
            DEVICE_ID_KEY: 'kve_secure_device_id',
            PASSWORD_STORAGE_KEY: 'kve_device_password_data',
            VIDEO_CACHE_KEY: 'kve_video_cache',
            STORAGE_LOCATION_KEY: 'kve_storage_location',
            CACHE_EXPIRY_DAYS: 3,
            CUSTOM_IMAGE_URL: 'https://res.cloudinary.com/zaumaran/image/upload/v1764932924/Kachin_Vision_Empire_For_Logo_zpkdbg.png',
            APP_VERSION: '1.0.0'
        };

        const firebaseConfig = {
            apiKey: "AIzaSyCJGR8dXeawpg6RNpF1iUC7TD65RWm-oxE",
            authDomain: "sun-day-video-production-298c8.firebaseapp.com",
            projectId: "sun-day-video-production-298c8",
            storageBucket: "sun-day-video-production-298c8.firebasestorage.app",
            messagingSenderId: "927333523323",
            appId: "1:927333523323:web:16375e95732c5acb4767de",
            measurementId: "G-ZY2Y2Y749H"
        };

        // ==================== PWA VARIABLES ====================
        let deferredPrompt = null;
        let isAppInstalled = false;
        let serviceWorkerRegistration = null;

        // ==================== APP STATE ====================
        let videos = [];
        let stories = [];
        let contactLinks = [];
        let passwords = [];
        let unlockedVideos = new Set();
        let currentStory = null;
        let isOnline = true;
        let currentVideoToUnlock = null;
        let deviceId = null;
        let devicePasswordData = null;
        let isPasswordVisible = false;
        let isVideoPasswordVisible = false;
        let passwordSectionHoverTimer = null;
        let passwordSectionExpanded = false;
        
        // Video optimization state
        let networkQuality = 'good';
        let currentQuality = 'auto';
        let videoBufferSize = 0;
        let isBuffering = false;
        let bufferingTimeout = null;
        let lastPlayTime = 0;
        
        // Preloading state
        let isPreloading = false;
        let preloadedVideos = new Set();
        let preloadQueue = [];
        let preloadProgress = {};
        let cachedVideos = {};
        
        // Storage state
        let storageLocation = 'default';
        let storagePath = '';
        let storageFolder = 'KVE_Videos';
        let isStorageInitialized = false;

        // Sorting state
        let currentSortMode = 'name_asc'; // Default: Sort by name A-Z

        // Scroll and touch state
        let isScrolling = false;
        let scrollTimeout = null;
        let touchStartTime = 0;
        let touchStartY = 0;
        let touchStartX = 0;
        let isTouchMove = false;
        const SCROLL_THRESHOLD = 10; // pixels
        const TAP_THRESHOLD = 200; // milliseconds

        // ==================== DOM ELEMENTS ====================
        const screens = document.querySelectorAll('.screen');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const connectionStatus = document.getElementById('connectionStatus');
        const toast = document.getElementById('toast');
        const passwordIndicator = document.getElementById('passwordIndicator');
        const deviceInfoDisplay = document.getElementById('deviceInfoDisplay');
        const deviceIdShort = document.getElementById('deviceIdShort');
        const deviceInfo = document.getElementById('deviceInfo');
        const storageInfo = document.getElementById('storageInfo');
        const storageText = document.getElementById('storageText');
        const storageLocationEl = document.getElementById('storageLocation');
        const locationPath = document.getElementById('locationPath');
        const storageSelection = document.getElementById('storageSelection');
        
        // PWA Elements
        const offlineIndicator = document.getElementById('offlineIndicator');
        const appUpdate = document.getElementById('appUpdate');
        const updateBtn = document.getElementById('updateBtn');
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const cancelInstall = document.getElementById('cancelInstall');
        const installAppBtn = document.getElementById('installAppBtn');
        
        // Stories menu
        const storiesToggle = document.getElementById('storiesToggle');
        const storiesMenu = document.getElementById('storiesMenu');
        const storyList = document.getElementById('storyList');
        
        // Password section
        const passwordSection = document.getElementById('passwordSection');
        const passwordInput = document.getElementById('passwordInput');
        const passwordToggle = document.getElementById('passwordToggle');
        const unlockBtn = document.getElementById('unlockBtn');
        const passwordStatus = document.getElementById('passwordStatus');
        
        // Video elements
        const videoPlayer = document.getElementById('videoPlayer');
        const defaultImage = document.getElementById('defaultImage');
        const appImage = document.getElementById('appImage');
        const videoList = document.getElementById('videoList');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const bufferingIndicator = document.getElementById('bufferingIndicator');
        const qualitySelector = document.getElementById('qualitySelector');
        const qualityButtons = document.querySelectorAll('.quality-btn');
        
        // Preloading elements
        const preloadProgressEl = document.getElementById('preloadProgress');
        const preloadProgressFill = document.getElementById('preloadProgressFill');
        const preloadProgressText = document.getElementById('preloadProgressText');
        const preloadProgressList = document.getElementById('preloadProgressList');
        const closePreloadProgress = document.getElementById('closePreloadProgress');
        const preloadBtn = document.getElementById('preloadBtn');
        
        // Navigation
        const contactBtn = document.getElementById('contactBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const optimizeBtn = document.getElementById('optimizeBtn');
        const storageBtn = document.getElementById('storageBtn');
        const backButton = document.getElementById('backButton');
        const backToMain = document.getElementById('backToMain');
        
        // Modals
        const videoPasswordModal = document.getElementById('videoPasswordModal');
        const videoPassword = document.getElementById('videoPassword');
        const videoPasswordToggle = document.getElementById('videoPasswordToggle');
        const submitVideoPassword = document.getElementById('submitVideoPassword');
        const cancelVideoPassword = document.getElementById('cancelVideoPassword');
        const videoPasswordStatus = document.getElementById('videoPasswordStatus');
        const noInternetModal = document.getElementById('noInternetModal');
        const retryConnectionBtn = document.getElementById('retryConnectionBtn');
        const passwordResetModal = document.getElementById('passwordResetModal');
        const confirmPasswordReset = document.getElementById('confirmPasswordReset');
        const storageModal = document.getElementById('storageModal');
        
        // Storage buttons
        const selectDefaultStorage = document.getElementById('selectDefaultStorage');
        const selectLocalStorage = document.getElementById('selectLocalStorage');
        const selectSDCard = document.getElementById('selectSDCard');
        const selectCustomStorage = document.getElementById('selectCustomStorage');
        
        // Lists
        const contactList = document.getElementById('contactList');

        // ==================== PWA FUNCTIONS ====================
        function initPWA() {
            // Check if app is already installed
            checkIfAppInstalled();
            
            // Register service worker
            registerServiceWorker();
            
            // Handle install prompt
            setupInstallPrompt();
            
            // Handle app updates
            setupAppUpdates();
            
            // Handle offline/online events
            setupNetworkHandlers();
        }

        function checkIfAppInstalled() {
            // Check display mode
            if (window.matchMedia('(display-mode: standalone)').matches) {
                isAppInstalled = true;
                console.log('App is installed and running in standalone mode');
            }
            
            // Check for iOS standalone mode
            if (window.navigator.standalone === true) {
                isAppInstalled = true;
                console.log('App is installed on iOS');
            }
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        serviceWorkerRegistration = registration;
                        console.log('Service Worker registered successfully:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('New service worker found:', newWorker);
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New update available
                                    showAppUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
                    
                // Listen for controller change
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('Service Worker controller changed');
                    window.location.reload();
                });
            }
        }

        function setupInstallPrompt() {
            // Handle beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install button in nav
                installAppBtn.style.display = 'flex';
                
                // Show install prompt after 5 seconds
                setTimeout(() => {
                    if (!isAppInstalled && !localStorage.getItem('installPromptDismissed')) {
                        showInstallPrompt();
                    }
                }, 5000);
                
                console.log('Install prompt available');
            });
            
            // Handle app installed event
            window.addEventListener('appinstalled', () => {
                isAppInstalled = true;
                installPrompt.style.display = 'none';
                installAppBtn.style.display = 'none';
                showToast('App installed successfully!', 'success');
                console.log('App was installed');
            });
            
            // Install button click
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('User accepted install');
                    } else {
                        console.log('User dismissed install');
                    }
                    
                    deferredPrompt = null;
                    installPrompt.style.display = 'none';
                    localStorage.setItem('installPromptDismissed', 'true');
                }
            });
            
            installAppBtn.addEventListener('click', () => {
                if (!isAppInstalled) {
                    showInstallPrompt();
                } else {
                    showToast('App is already installed', 'info');
                }
            });
            
            // Cancel install
            cancelInstall.addEventListener('click', () => {
                installPrompt.style.display = 'none';
                localStorage.setItem('installPromptDismissed', 'true');
            });
        }

        function showInstallPrompt() {
            if (!isAppInstalled && deferredPrompt && !localStorage.getItem('installPromptDismissed')) {
                installPrompt.style.display = 'flex';
            }
        }

        function setupAppUpdates() {
            updateBtn.addEventListener('click', () => {
                if (serviceWorkerRegistration && serviceWorkerRegistration.waiting) {
                    serviceWorkerRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    appUpdate.style.display = 'none';
                }
            });
        }

        function showAppUpdateNotification() {
            appUpdate.style.display = 'block';
            showToast('New update available!', 'info');
        }

        function setupNetworkHandlers() {
            // Online/offline events
            window.addEventListener('online', () => {
                isOnline = true;
                offlineIndicator.style.display = 'none';
                showToast('Back online', 'success');
                // Sync data if needed
                if (videos.length === 0) {
                    refreshData();
                }
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                offlineIndicator.style.display = 'block';
                showToast('You are offline', 'error');
            });
            
            // Initial check
            if (!navigator.onLine) {
                isOnline = false;
                offlineIndicator.style.display = 'block';
            }
        }

        // ==================== SCROLL AND TOUCH HANDLING ====================
        function setupScrollAndTouchHandling() {
            if (!videoList) return;
            
            videoList.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                touchStartY = e.touches[0].clientY;
                touchStartX = e.touches[0].clientX;
                isTouchMove = false;
                
                this.classList.add('scrolling');
                isScrolling = true;
                
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                
                scrollTimeout = setTimeout(function() {
                    videoList.classList.remove('scrolling');
                    isScrolling = false;
                }, 100);
            }, { passive: true });
            
            videoList.addEventListener('touchmove', function(e) {
                const currentY = e.touches[0].clientY;
                const currentX = e.touches[0].clientX;
                
                const deltaY = Math.abs(currentY - touchStartY);
                const deltaX = Math.abs(currentX - touchStartX);
                
                if (deltaY > SCROLL_THRESHOLD || deltaX > SCROLL_THRESHOLD) {
                    isTouchMove = true;
                    isScrolling = true;
                    this.classList.add('scrolling');
                    
                    if (scrollTimeout) {
                        clearTimeout(scrollTimeout);
                    }
                    
                    scrollTimeout = setTimeout(function() {
                        videoList.classList.remove('scrolling');
                        isScrolling = false;
                    }, 150);
                }
            }, { passive: true });
            
            videoList.addEventListener('touchend', function(e) {
                const touchEndTime = Date.now();
                const touchDuration = touchEndTime - touchStartTime;
                
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                
                scrollTimeout = setTimeout(function() {
                    videoList.classList.remove('scrolling');
                    isScrolling = false;
                }, 100);
                
                if (isTouchMove || isScrolling) {
                    e.preventDefault();
                    return;
                }
                
                if (touchDuration > TAP_THRESHOLD) {
                    return;
                }
                
                const target = e.target;
                const videoItem = target.closest('.video-item');
                
                if (videoItem && !videoItem.classList.contains('scrolling')) {
                    const playButton = target.closest('.action-btn.play');
                    
                    if (playButton) {
                        e.preventDefault();
                        e.stopPropagation();
                        handlePlayButtonClick(videoItem, playButton);
                    } else {
                        e.preventDefault();
                        e.stopPropagation();
                        handleVideoItemClick(videoItem);
                    }
                }
            }, { passive: false });
            
            videoList.addEventListener('click', function(e) {
                if (isScrolling) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                
                const target = e.target;
                const videoItem = target.closest('.video-item');
                
                if (videoItem) {
                    const playButton = target.closest('.action-btn.play');
                    
                    if (playButton) {
                        e.preventDefault();
                        e.stopPropagation();
                        handlePlayButtonClick(videoItem, playButton);
                    } else if (!target.closest('.video-actions')) {
                        e.preventDefault();
                        e.stopPropagation();
                        handleVideoItemClick(videoItem);
                    }
                }
            });
            
            videoList.addEventListener('scroll', function() {
                isScrolling = true;
                this.classList.add('scrolling');
                
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                
                scrollTimeout = setTimeout(function() {
                    videoList.classList.remove('scrolling');
                    isScrolling = false;
                }, 150);
            });
        }

        function handlePlayButtonClick(videoItem, playButton) {
            if (isScrolling) return;
            
            const videoId = playButton.getAttribute('data-id');
            const video = videos.find(v => v.id === videoId);
            
            if (!video) return;
            
            const isFree = video.passwordType === 'free';
            const isUnlocked = isFree || unlockedVideos.has(video.id) || 
                             (video.storyName && unlockedVideos.has(video.storyName));
            
            if (!isUnlocked) {
                if (video.passwordType === 'password') {
                    currentVideoToUnlock = video;
                    showVideoPasswordModal();
                } else {
                    showToast('Password required', 'error');
                }
            } else {
                playVideo(video);
            }
        }

        function handleVideoItemClick(videoItem) {
            if (isScrolling) return;
            
            const playButton = videoItem.querySelector('.action-btn.play');
            if (playButton) {
                handlePlayButtonClick(videoItem, playButton);
            }
        }

        // ==================== SORTING FUNCTIONS ====================
        function sortVideosByNameAsc(a, b) {
            return a.name.localeCompare(b.name);
        }

        function sortVideosByNameDesc(a, b) {
            return b.name.localeCompare(a.name);
        }

        function sortVideosByStoryAsc(a, b) {
            if (a.storyName && b.storyName) {
                return a.storyName.localeCompare(b.storyName);
            }
            return a.name.localeCompare(b.name);
        }

        function sortVideosByStoryDesc(a, b) {
            if (a.storyName && b.storyName) {
                return b.storyName.localeCompare(a.storyName);
            }
            return b.name.localeCompare(a.name);
        }

        function extractStoryNumber(storyName) {
            if (!storyName) return 0;
            const match = storyName.match(/\d+/);
            return match ? parseInt(match[0]) : 0;
        }

        function sortVideosByStoryNumberAsc(a, b) {
            const numA = extractStoryNumber(a.storyName);
            const numB = extractStoryNumber(b.storyName);
            return numA - numB;
        }

        function sortVideosByStoryNumberDesc(a, b) {
            const numA = extractStoryNumber(a.storyName);
            const numB = extractStoryNumber(b.storyName);
            return numB - numA;
        }

        function applySorting(videosArray) {
            const sortedVideos = [...videosArray];
            
            switch(currentSortMode) {
                case 'name_asc':
                    sortedVideos.sort(sortVideosByNameAsc);
                    break;
                case 'name_desc':
                    sortedVideos.sort(sortVideosByNameDesc);
                    break;
                case 'story_asc':
                    sortedVideos.sort(sortVideosByStoryAsc);
                    break;
                case 'story_desc':
                    sortedVideos.sort(sortVideosByStoryDesc);
                    break;
                case 'story_number_asc':
                    sortedVideos.sort(sortVideosByStoryNumberAsc);
                    break;
                case 'story_number_desc':
                    sortedVideos.sort(sortVideosByStoryNumberDesc);
                    break;
                default:
                    sortedVideos.sort(sortVideosByNameAsc);
            }
            
            return sortedVideos;
        }

        function addSortingUI() {
            const videoListTitle = document.querySelector('.video-list-title');
            
            const sortContainer = document.createElement('div');
            sortContainer.className = 'sort-container';
            sortContainer.style.position = 'relative';
            sortContainer.style.display = 'inline-block';
            sortContainer.style.marginLeft = '10px';
            
            const sortButton = document.createElement('button');
            sortButton.className = 'sort-button';
            sortButton.innerHTML = '<i class="fas fa-sort"></i> Sort';
            sortButton.style.background = 'rgba(255, 153, 0, 0.2)';
            sortButton.style.color = '#ff9900';
            sortButton.style.border = '1px solid rgba(255, 153, 0, 0.3)';
            sortButton.style.padding = '4px 8px';
            sortButton.style.borderRadius = '4px';
            sortButton.style.fontSize = '10px';
            sortButton.style.cursor = 'pointer';
            sortButton.style.display = 'flex';
            sortButton.style.alignItems = 'center';
            sortButton.style.gap = '5px';
            
            const sortDropdown = document.createElement('div');
            sortDropdown.className = 'sort-dropdown';
            sortDropdown.style.display = 'none';
            sortDropdown.style.position = 'absolute';
            sortDropdown.style.top = '100%';
            sortDropdown.style.left = '0';
            sortDropdown.style.background = 'rgba(15, 20, 40, 0.95)';
            sortDropdown.style.border = '1px solid rgba(255, 153, 0, 0.3)';
            sortDropdown.style.borderRadius = '6px';
            sortDropdown.style.padding = '8px';
            sortDropdown.style.zIndex = '1000';
            sortDropdown.style.minWidth = '180px';
            sortDropdown.style.backdropFilter = 'blur(10px)';
            sortDropdown.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
            
            const sortOptions = [
                { id: 'name_asc', label: 'Sort by Name (A-Z)', icon: 'fa-sort-alpha-down' },
                { id: 'name_desc', label: 'Sort by Name (Z-A)', icon: 'fa-sort-alpha-down-alt' },
                { id: 'story_asc', label: 'Sort by Story (A-Z)', icon: 'fa-book' },
                { id: 'story_desc', label: 'Sort by Story (Z-A)', icon: 'fa-book' },
                { id: 'story_number_asc', label: 'Sort by Story (1-100)', icon: 'fa-sort-numeric-down' },
                { id: 'story_number_desc', label: 'Sort by Story (100-1)', icon: 'fa-sort-numeric-down-alt' }
            ];
            
            sortOptions.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'sort-option';
                optionElement.dataset.sort = option.id;
                optionElement.innerHTML = `
                    <i class="fas ${option.icon}"></i>
                    <span>${option.label}</span>
                `;
                optionElement.style.padding = '6px 8px';
                optionElement.style.borderRadius = '4px';
                optionElement.style.cursor = 'pointer';
                optionElement.style.display = 'flex';
                optionElement.style.alignItems = 'center';
                optionElement.style.gap = '8px';
                optionElement.style.fontSize = '11px';
                optionElement.style.transition = 'all 0.2s ease';
                
                if (option.id === currentSortMode) {
                    optionElement.style.background = 'rgba(255, 153, 0, 0.2)';
                    optionElement.style.color = '#ff9900';
                } else {
                    optionElement.style.background = 'transparent';
                    optionElement.style.color = '#f0f8ff';
                }
                
                optionElement.addEventListener('mouseenter', () => {
                    if (option.id !== currentSortMode) {
                        optionElement.style.background = 'rgba(255, 153, 0, 0.1)';
                    }
                });
                
                optionElement.addEventListener('mouseleave', () => {
                    if (option.id !== currentSortMode) {
                        optionElement.style.background = 'transparent';
                    }
                });
                
                optionElement.addEventListener('click', () => {
                    currentSortMode = option.id;
                    renderVideoList();
                    sortDropdown.style.display = 'none';
                    sortButton.innerHTML = `<i class="fas ${option.icon}"></i> ${option.label.split(' ')[0]}`;
                });
                
                optionElement.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    currentSortMode = option.id;
                    renderVideoList();
                    sortDropdown.style.display = 'none';
                    sortButton.innerHTML = `<i class="fas ${option.icon}"></i> ${option.label.split(' ')[0]}`;
                });
                
                sortDropdown.appendChild(optionElement);
            });
            
            sortButton.addEventListener('click', (e) => {
                e.stopPropagation();
                sortDropdown.style.display = sortDropdown.style.display === 'none' ? 'block' : 'none';
            });
            
            sortButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                sortDropdown.style.display = sortDropdown.style.display === 'none' ? 'block' : 'none';
            });
            
            document.addEventListener('click', (e) => {
                if (!sortContainer.contains(e.target)) {
                    sortDropdown.style.display = 'none';
                }
            });
            
            document.addEventListener('touchstart', (e) => {
                if (!sortContainer.contains(e.target)) {
                    sortDropdown.style.display = 'none';
                }
            });
            
            sortContainer.appendChild(sortButton);
            sortContainer.appendChild(sortDropdown);
            videoListTitle.appendChild(sortContainer);
        }

        // ==================== INITIALIZATION ====================
        async function initApp() {
            showLoading('Initializing Secure Video Platform...');
            
            try {
                // Initialize PWA
                initPWA();
                
                // Check internet connection first
                if (!navigator.onLine) {
                    hideLoading();
                    noInternetModal.style.display = 'flex';
                    return;
                }
                
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                
                // Generate or get secure device ID
                deviceId = getSecureDeviceId();
                updateDeviceInfoDisplay();
                
                // Load custom image
                loadCustomImage();
                
                // Setup storage system
                await setupStorageSystem();
                
                // Load cached videos
                loadCachedVideos();
                
                // Setup event listeners
                setupEventListeners();
                
                // Setup video optimization
                optimizeVideoPlayback();
                
                // Check connection
                updateConnectionStatus();
                
                // Monitor network quality
                monitorNetworkQuality();
                
                // Load all data
                await Promise.all([
                    loadVideos(),
                    loadPasswords(),
                    loadContactLinks()
                ]);
                
                // Check for existing device password
                checkDevicePassword();
                
                // Render UI
                renderStoryList();
                renderVideoList();
                renderContactList();
                
                // Setup password section hover behavior
                setupPasswordSectionHover();
                
                // Add sorting UI
                addSortingUI();
                
                // Setup scroll and touch handling
                setupScrollAndTouchHandling();
                
                // Start auto-preloading
                startAutoPreloading();
                
                // Hide loading
                setTimeout(() => {
                    hideLoading();
                    showToast('Secure Video Platform Ready', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                hideLoading();
                showToast('Initialization failed. Please check your connection.', 'error');
            }
        }

        // ==================== STORAGE SYSTEM ====================
        async function setupStorageSystem() {
            const savedLocation = localStorage.getItem(CONFIG.STORAGE_LOCATION_KEY);
            if (savedLocation) {
                storageLocation = savedLocation;
            }
            
            await setupStoragePath();
            updateStorageLocationDisplay();
        }

        async function setupStoragePath() {
            try {
                switch(storageLocation) {
                    case 'default':
                        storagePath = '';
                        locationPath.textContent = 'Default App Storage';
                        break;
                        
                    case 'local':
                        if (typeof window.requestFileSystem === 'undefined' && 
                            typeof window.webkitRequestFileSystem === 'undefined') {
                            storageLocation = 'default';
                            storagePath = '';
                            localStorage.setItem(CONFIG.STORAGE_LOCATION_KEY, 'default');
                            showToast('Local storage not available, using default', 'info');
                        } else {
                            try {
                                const requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
                                storagePath = 'local://KVE_Videos/';
                                locationPath.textContent = 'Local Device Storage';
                            } catch (error) {
                                console.error('Local storage error:', error);
                                storageLocation = 'default';
                                storagePath = '';
                                localStorage.setItem(CONFIG.STORAGE_LOCATION_KEY, 'default');
                            }
                        }
                        break;
                        
                    case 'sd':
                        if (typeof window.requestFileSystem === 'undefined' && 
                            typeof window.webkitRequestFileSystem === 'undefined') {
                            storageLocation = 'default';
                            storagePath = '';
                            localStorage.setItem(CONFIG.STORAGE_LOCATION_KEY, 'default');
                            showToast('SD card storage not available', 'info');
                        } else {
                            try {
                                storagePath = 'external://KVE_Videos/';
                                locationPath.textContent = 'SD Card Storage';
                            } catch (error) {
                                console.error('SD card error:', error);
                                storageLocation = 'local';
                                await setupStoragePath();
                            }
                        }
                        break;
                        
                    case 'custom':
                        const customPath = localStorage.getItem('kve_custom_storage_path');
                        if (customPath) {
                            storagePath = customPath;
                            locationPath.textContent = `Custom: ${customPath}`;
                        } else {
                            storageLocation = 'default';
                            storagePath = '';
                            localStorage.setItem(CONFIG.STORAGE_LOCATION_KEY, 'default');
                        }
                        break;
                }
                
                isStorageInitialized = true;
                
            } catch (error) {
                console.error('Storage setup error:', error);
                storageLocation = 'default';
                storagePath = '';
                localStorage.setItem(CONFIG.STORAGE_LOCATION_KEY, 'default');
                locationPath.textContent = 'Default App Storage';
                isStorageInitialized = true;
            }
        }

        function updateStorageLocationDisplay() {
            if (isStorageInitialized) {
                storageLocationEl.style.display = 'flex';
                
                let displayPath = '';
                switch(storageLocation) {
                    case 'default': displayPath = 'Default App Storage'; break;
                    case 'local': displayPath = 'Local Device Storage'; break;
                    case 'sd': displayPath = 'SD Card Storage'; break;
                    case 'custom': 
                        const customPath = localStorage.getItem('kve_custom_storage_path') || 'Custom Folder';
                        displayPath = `Custom: ${customPath}`;
                        break;
                }
                
                locationPath.textContent = displayPath;
            }
        }

        function showStorageSelection() {
            storageSelection.classList.toggle('active');
        }

        async function selectStorage(type) {
            storageLocation = type;
            localStorage.setItem(CONFIG.STORAGE_LOCATION_KEY, type);
            
            await setupStoragePath();
            updateStorageLocationDisplay();
            storageSelection.classList.remove('active');
            
            showToast(`Storage location set to ${type}`, 'success');
        }

        async function selectCustomStorageLocation() {
            try {
                if (window.showOpenFilePicker) {
                    const handle = await window.showDirectoryPicker();
                    const path = handle.name;
                    
                    localStorage.setItem('kve_custom_storage_path', path);
                    await selectStorage('custom');
                    
                } else {
                    const path = prompt('Enter custom storage path:', 'KVE_Videos');
                    if (path) {
                        localStorage.setItem('kve_custom_storage_path', path);
                        await selectStorage('custom');
                    }
                }
            } catch (error) {
                console.error('Custom storage selection error:', error);
                showToast('Cannot access custom storage location', 'error');
            }
        }

        // ==================== PRELOADING SYSTEM ====================
        function startAutoPreloading() {
            if (!navigator.onLine || videos.length === 0) return;
            
            setTimeout(() => {
                startPreloading();
            }, 3000);
        }

        function startPreloading() {
            if (isPreloading) return;
            
            isPreloading = true;
            preloadProgressEl.style.display = 'block';
            preloadQueue = [...videos];
            preloadProgress = {};
            
            videos.forEach(video => {
                preloadProgress[video.id] = {
                    name: video.name,
                    progress: 0,
                    isCached: preloadedVideos.has(video.id)
                };
            });
            
            updatePreloadProgressDisplay();
            showToast('Started preloading videos', 'info');
            
            preloadBatch(0, 3);
        }

        function preloadBatch(startIndex, batchSize) {
            const endIndex = Math.min(startIndex + batchSize, preloadQueue.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const video = preloadQueue[i];
                if (!preloadedVideos.has(video.id)) {
                    preloadVideo(video);
                }
            }
            
            if (endIndex < preloadQueue.length) {
                setTimeout(() => {
                    preloadBatch(endIndex, batchSize);
                }, 2000);
            }
        }

        async function preloadVideo(video) {
            if (preloadedVideos.has(video.id)) return;
            
            try {
                const preloadVideo = document.createElement('video');
                preloadVideo.preload = 'auto';
                preloadVideo.crossOrigin = 'anonymous';
                
                let loaded = 0;
                let total = 0;
                
                preloadVideo.addEventListener('progress', () => {
                    if (preloadVideo.buffered.length > 0) {
                        loaded = preloadVideo.buffered.end(0);
                        total = preloadVideo.duration || 1;
                        
                        const progress = Math.min((loaded / total) * 100, 99);
                        preloadProgress[video.id].progress = progress;
                        updatePreloadProgressDisplay();
                    }
                });
                
                preloadVideo.addEventListener('canplaythrough', () => {
                    preloadProgress[video.id].progress = 100;
                    preloadedVideos.add(video.id);
                    cacheVideo(video, preloadVideo);
                    updatePreloadProgressDisplay();
                    updateStorageInfo();
                    
                    if (isPreloadingComplete()) {
                        finishPreloading();
                    }
                });
                
                preloadVideo.addEventListener('error', () => {
                    preloadProgress[video.id].progress = -1;
                    updatePreloadProgressDisplay();
                });
                
                preloadVideo.src = video.url;
                preloadVideo.load();
                
            } catch (error) {
                console.error('Preloading error:', error);
                preloadProgress[video.id].progress = -1;
                updatePreloadProgressDisplay();
            }
        }

        function cacheVideo(video, videoElement) {
            const cacheKey = `video_cache_${video.id}`;
            const cacheData = {
                id: video.id,
                name: video.name,
                url: video.url,
                timestamp: Date.now(),
                duration: videoElement.duration || 0
            };
            
            try {
                localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                cachedVideos[video.id] = cacheData;
                updateStorageInfo();
            } catch (error) {
                console.error('Cache error:', error);
                cleanupOldCache();
            }
        }

        function loadCachedVideos() {
            const now = Date.now();
            const expiryTime = CONFIG.CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('video_cache_')) {
                    try {
                        const cacheData = JSON.parse(localStorage.getItem(key));
                        
                        if (now - cacheData.timestamp > expiryTime) {
                            localStorage.removeItem(key);
                            continue;
                        }
                        
                        cachedVideos[cacheData.id] = cacheData;
                        preloadedVideos.add(cacheData.id);
                    } catch (error) {
                        console.error('Cache load error:', error);
                        localStorage.removeItem(key);
                    }
                }
            }
            
            updateStorageInfo();
        }

        function cleanupOldCache() {
            const now = Date.now();
            const expiryTime = CONFIG.CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
            let freedSpace = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('video_cache_')) {
                    try {
                        const cacheData = JSON.parse(localStorage.getItem(key));
                        if (now - cacheData.timestamp > expiryTime) {
                            localStorage.removeItem(key);
                            freedSpace++;
                        }
                    } catch (error) {
                        localStorage.removeItem(key);
                    }
                }
            }
            
            if (freedSpace > 0) {
                showToast(`Cleaned up ${freedSpace} expired caches`, 'info');
            }
            
            updateStorageInfo();
        }

        function isPreloadingComplete() {
            return videos.every(video => 
                preloadedVideos.has(video.id) || preloadProgress[video.id]?.progress === -1
            );
        }

        function finishPreloading() {
            isPreloading = false;
            setTimeout(() => {
                preloadProgressEl.style.display = 'none';
                showToast('All videos preloaded and cached', 'success');
            }, 2000);
        }

        function updatePreloadProgressDisplay() {
            const totalVideos = videos.length;
            const cachedVideosCount = Object.values(preloadProgress).filter(p => p.isCached).length;
            const completedVideos = Object.values(preloadProgress).filter(p => p.progress >= 100).length;
            const totalProgress = ((cachedVideosCount + completedVideos) / (totalVideos * 2)) * 100;
            
            preloadProgressFill.style.width = `${totalProgress}%`;
            preloadProgressText.textContent = `${completedVideos}/${totalVideos} videos preloaded`;
            
            preloadProgressList.innerHTML = '';
            videos.forEach(video => {
                const progress = preloadProgress[video.id] || { progress: 0, isCached: false };
                const item = document.createElement('div');
                item.className = 'preload-item';
                
                let statusIcon = '⏳';
                let statusText = '';
                
                if (progress.progress === -1) {
                    statusIcon = '❌';
                    statusText = 'Failed';
                } else if (progress.progress >= 100) {
                    statusIcon = '✅';
                    statusText = 'Ready';
                } else if (progress.isCached) {
                    statusIcon = '💾';
                    statusText = 'Cached';
                }
                
                item.innerHTML = `
                    <div class="preload-item-name">${video.name}</div>
                    <div class="preload-item-progress">
                        <div class="preload-item-progress-fill" style="width: ${Math.max(0, progress.progress)}%;"></div>
                    </div>
                    <div class="preload-item-percent">
                        ${progress.progress >= 0 ? `${Math.round(progress.progress)}%` : statusText} ${statusIcon}
                    </div>
                `;
                
                preloadProgressList.appendChild(item);
            });
        }

        function updateStorageInfo() {
            const totalVideos = videos.length;
            const cachedCount = preloadedVideos.size;
            const cachePercentage = totalVideos > 0 ? Math.round((cachedCount / totalVideos) * 100) : 0;
            
            storageText.textContent = `${cachedCount}/${totalVideos} (${cachePercentage}%)`;
            storageInfo.style.display = cachedCount > 0 ? 'flex' : 'none';
        }

        // ==================== SECURE DEVICE ID SYSTEM ====================
        function getSecureDeviceId() {
            let storedId = localStorage.getItem(CONFIG.DEVICE_ID_KEY);
            
            if (!storedId) {
                const timestamp = Date.now();
                const randomPart = Math.random().toString(36).substr(2, 12);
                const userAgentHash = CryptoJS.SHA256(navigator.userAgent).toString().substr(0, 8);
                const screenHash = CryptoJS.SHA256(`${screen.width}x${screen.height}`).toString().substr(0, 6);
                
                storedId = `kve_dev_${timestamp}_${randomPart}_${userAgentHash}_${screenHash}`;
                localStorage.setItem(CONFIG.DEVICE_ID_KEY, storedId);
                
                clearDevicePassword();
                showToast('New device detected', 'info');
            }
            
            return storedId;
        }

        function updateDeviceInfoDisplay() {
            if (deviceId) {
                const shortId = deviceId.substr(0, 12) + '...';
                deviceIdShort.textContent = shortId;
                deviceInfoDisplay.style.display = 'flex';
                deviceInfo.innerHTML = `<i class="fas fa-fingerprint"></i> Device ID: ${shortId}`;
            }
        }

        // ==================== DEVICE-LOCKED PASSWORD SYSTEM ====================
        function checkDevicePassword() {
            const stored = localStorage.getItem(CONFIG.PASSWORD_STORAGE_KEY);
            
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    
                    if (data.deviceId === deviceId) {
                        devicePasswordData = data;
                        checkPasswordValidity(data.password);
                    } else {
                        clearDevicePassword();
                        showToast('This password is locked to another device', 'error');
                    }
                } catch (e) {
                    clearDevicePassword();
                }
            }
        }

        function checkPasswordValidity(password) {
            if (!passwords.length) return;
            
            const matchingPassword = passwords.find(p => p.password === password);
            
            if (matchingPassword) {
                checkPasswordUsageOnServer(password, matchingPassword);
            } else {
                clearDevicePassword();
                passwordResetModal.style.display = 'flex';
            }
        }

        async function checkPasswordUsageOnServer(password, passwordData) {
            try {
                const db = firebase.firestore();
                const usageRef = db.collection('passwordUsage').where('password', '==', password);
                const snapshot = await usageRef.get();
                
                if (!snapshot.empty) {
                    const usageDoc = snapshot.docs[0];
                    const usageData = usageDoc.data();
                    
                    if (usageData.deviceId === deviceId) {
                        autoUnlockWithDevicePassword(password, passwordData);
                    } else {
                        clearDevicePassword();
                        passwordResetModal.style.display = 'flex';
                        showToast('Password is already in use on another device', 'error');
                    }
                } else {
                    await recordPasswordUsage(password);
                    autoUnlockWithDevicePassword(password, passwordData);
                }
                
            } catch (error) {
                console.error('Error checking password usage:', error);
                autoUnlockWithDevicePassword(password, passwordData);
            }
        }

        async function recordPasswordUsage(password) {
            try {
                const db = firebase.firestore();
                await db.collection('passwordUsage').doc(password).set({
                    password: password,
                    deviceId: deviceId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUsed: Date.now()
                });
            } catch (error) {
                console.error('Error recording password usage:', error);
            }
        }

        function autoUnlockWithDevicePassword(password, passwordData) {
            if (passwordData.storyName) {
                unlockedVideos.add(passwordData.storyName);
                updatePasswordIndicator(true, passwordData.storyName);
            } else {
                videos.forEach(video => {
                    if (video.passwordType === 'password') {
                        unlockedVideos.add(video.id);
                    }
                });
                updatePasswordIndicator(true, 'All Videos');
            }
            
            renderVideoList();
            logoutBtn.style.display = 'flex';
            showToast('Auto-logged in with device password', 'success');
        }

        function clearDevicePassword() {
            devicePasswordData = null;
            unlockedVideos.clear();
            localStorage.removeItem(CONFIG.PASSWORD_STORAGE_KEY);
            updatePasswordIndicator(false);
            renderVideoList();
            logoutBtn.style.display = 'none';
            passwordInput.value = '';
        }

        async function logout() {
            if (devicePasswordData) {
                try {
                    const db = firebase.firestore();
                    await db.collection('passwordUsage').doc(devicePasswordData.password).delete();
                } catch (error) {
                    console.error('Error removing usage record:', error);
                }
            }
            
            clearDevicePassword();
            showToast('Logged out successfully', 'success');
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            setupTouchEvents();
            
            storiesToggle.addEventListener('click', toggleStoriesMenu);
            storiesToggle.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                toggleStoriesMenu(e);
            });
            document.addEventListener('click', closeStoriesMenuOnClickOutside);
            document.addEventListener('touchstart', closeStoriesMenuOnClickOutside);
            
            passwordToggle.addEventListener('click', togglePasswordVisibility);
            passwordToggle.addEventListener('touchend', (e) => {
                e.preventDefault();
                togglePasswordVisibility();
            });
            
            videoPasswordToggle.addEventListener('click', toggleVideoPasswordVisibility);
            videoPasswordToggle.addEventListener('touchend', (e) => {
                e.preventDefault();
                toggleVideoPasswordVisibility();
            });
            
            unlockBtn.addEventListener('click', unlockVideos);
            unlockBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                unlockVideos();
            });
            
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') unlockVideos();
            });
            
            passwordInput.addEventListener('touchstart', (e) => {
                e.stopPropagation();
            });
            
            storageBtn.addEventListener('click', () => {
                storageModal.style.display = 'flex';
            });
            
            storageBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                storageModal.style.display = 'flex';
            });
            
            selectDefaultStorage.addEventListener('click', () => {
                selectStorage('default');
                storageModal.style.display = 'none';
            });
            
            selectLocalStorage.addEventListener('click', () => {
                selectStorage('local');
                storageModal.style.display = 'none';
            });
            
            selectSDCard.addEventListener('click', () => {
                selectStorage('sd');
                storageModal.style.display = 'none';
            });
            
            selectCustomStorage.addEventListener('click', async () => {
                storageModal.style.display = 'none';
                await selectCustomStorageLocation();
            });
            
            contactBtn.addEventListener('click', () => showScreen(2));
            contactBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                showScreen(2);
            });
            
            refreshBtn.addEventListener('click', refreshData);
            refreshBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                refreshData();
            });
            
            logoutBtn.addEventListener('click', logout);
            logoutBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                logout();
            });
            
            preloadBtn.addEventListener('click', startPreloading);
            preloadBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                startPreloading();
            });
            
            closePreloadProgress.addEventListener('click', () => {
                preloadProgressEl.style.display = 'none';
            });
            
            closePreloadProgress.addEventListener('touchend', (e) => {
                e.preventDefault();
                preloadProgressEl.style.display = 'none';
            });
            
            optimizeBtn.addEventListener('click', () => {
                optimizeVideoPlayback();
                showToast('Video playback optimized', 'success');
            });
            optimizeBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                optimizeVideoPlayback();
                showToast('Video playback optimized', 'success');
            });
            
            backButton.addEventListener('click', handleBackButton);
            backButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleBackButton();
            });
            
            backToMain.addEventListener('click', () => showScreen(1));
            backToMain.addEventListener('touchend', (e) => {
                e.preventDefault();
                showScreen(1);
            });
            
            fullscreenBtn.addEventListener('click', toggleFullScreen);
            fullscreenBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                toggleFullScreen();
            });
            
            submitVideoPassword.addEventListener('click', unlockCurrentVideo);
            submitVideoPassword.addEventListener('touchend', (e) => {
                e.preventDefault();
                unlockCurrentVideo();
            });
            
            cancelVideoPassword.addEventListener('click', closeVideoPasswordModal);
            cancelVideoPassword.addEventListener('touchend', (e) => {
                e.preventDefault();
                closeVideoPasswordModal();
            });
            
            videoPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') unlockCurrentVideo();
            });
            
            videoPasswordModal.addEventListener('touchmove', (e) => {
                e.stopPropagation();
            });
            
            videoPasswordModal.addEventListener('click', (e) => {
                if (e.target === videoPasswordModal) {
                    closeVideoPasswordModal();
                }
            });
            
            videoPasswordModal.addEventListener('touchstart', (e) => {
                if (e.target === videoPasswordModal) {
                    closeVideoPasswordModal();
                }
            });
            
            passwordResetModal.addEventListener('click', (e) => {
                if (e.target === passwordResetModal) {
                    passwordResetModal.style.display = 'none';
                }
            });
            
            passwordResetModal.addEventListener('touchstart', (e) => {
                if (e.target === passwordResetModal) {
                    passwordResetModal.style.display = 'none';
                }
            });
            
            storageModal.addEventListener('click', (e) => {
                if (e.target === storageModal) {
                    storageModal.style.display = 'none';
                }
            });
            
            storageModal.addEventListener('touchstart', (e) => {
                if (e.target === storageModal) {
                    storageModal.style.display = 'none';
                }
            });
            
            retryConnectionBtn.addEventListener('click', () => {
                noInternetModal.style.display = 'none';
                initApp();
            });
            
            retryConnectionBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                noInternetModal.style.display = 'none';
                initApp();
            });
            
            confirmPasswordReset.addEventListener('click', () => {
                passwordResetModal.style.display = 'none';
                passwordInput.focus();
            });
            
            confirmPasswordReset.addEventListener('touchend', (e) => {
                e.preventDefault();
                passwordResetModal.style.display = 'none';
                passwordInput.focus();
            });
            
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            
            videoPlayer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });
            
            document.addEventListener('fullscreenchange', handleFullScreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullScreenChange);
            document.addEventListener('mozfullscreenchange', handleFullScreenChange);
            document.addEventListener('MSFullscreenChange', handleFullScreenChange);
            
            let startY = 0;
            document.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
            }, { passive: true });
            
            document.addEventListener('touchmove', (e) => {
                const currentY = e.touches[0].clientY;
                if (window.scrollY === 0 && currentY > startY) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('visibilitychange', function() {
                if (document.hidden && !videoPlayer.paused) {
                    videoPlayer.pause();
                }
            });
            
            window.addEventListener('resize', function() {
                setTimeout(() => {
                    if (document.activeElement && document.activeElement.scrollIntoViewIfNeeded) {
                        document.activeElement.scrollIntoViewIfNeeded();
                    }
                }, 100);
            });
        }

        function setupTouchEvents() {
            document.querySelectorAll('button, .video-item, .story-item, .nav-btn, .action-btn').forEach(element => {
                element.addEventListener('touchstart', function() {
                    this.style.opacity = '0.8';
                });
                
                element.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                });
                
                element.addEventListener('touchcancel', function() {
                    this.style.opacity = '1';
                });
            });
        }

        function togglePasswordVisibility() {
            isPasswordVisible = !isPasswordVisible;
            passwordInput.type = isPasswordVisible ? 'text' : 'password';
            passwordToggle.innerHTML = isPasswordVisible ? 
                '<i class="fas fa-eye-slash"></i>' : 
                '<i class="fas fa-eye"></i>';
        }

        function toggleVideoPasswordVisibility() {
            isVideoPasswordVisible = !isVideoPasswordVisible;
            videoPassword.type = isVideoPasswordVisible ? 'text' : 'password';
            videoPasswordToggle.innerHTML = isVideoPasswordVisible ? 
                '<i class="fas fa-eye-slash"></i>' : 
                '<i class="fas fa-eye"></i>';
        }

        // ==================== STORIES MENU ====================
        function toggleStoriesMenu(e) {
            if (e) {
                e.stopPropagation();
                e.preventDefault();
            }
            storiesMenu.classList.toggle('active');
        }

        function closeStoriesMenuOnClickOutside(e) {
            if (!storiesToggle.contains(e.target) && !storiesMenu.contains(e.target)) {
                storiesMenu.classList.remove('active');
            }
        }

        // ==================== DATA LOADING ====================
        async function loadVideos() {
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('videos').get();
                videos = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const storySet = new Set();
                videos.forEach(video => {
                    if (video.storyName) {
                        storySet.add(video.storyName);
                    }
                });
                stories = Array.from(storySet).sort();
                
                console.log(`${videos.length} videos loaded`);
            } catch (error) {
                console.error('Error loading videos:', error);
                throw error;
            }
        }

        async function loadPasswords() {
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('passwords').get();
                passwords = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading passwords:', error);
                throw error;
            }
        }

        async function loadContactLinks() {
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('contactLinks').get();
                contactLinks = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading contact links:', error);
                throw error;
            }
        }

        async function refreshData() {
            showLoading('Refreshing data...');
            
            try {
                await Promise.all([
                    loadVideos(),
                    loadPasswords(),
                    loadContactLinks()
                ]);
                
                if (devicePasswordData) {
                    checkPasswordValidity(devicePasswordData.password);
                }
                
                renderStoryList();
                renderVideoList();
                renderContactList();
                
                hideLoading();
                showToast('Data refreshed successfully', 'success');
            } catch (error) {
                hideLoading();
                showToast('Refresh failed', 'error');
            }
        }

        // ==================== PASSWORD UNLOCK SYSTEM ====================
        async function unlockVideos() {
            const password = passwordInput.value.trim();
            
            if (!password) {
                showToast('Enter password', 'error');
                passwordStatus.textContent = '✗ Please enter password';
                passwordStatus.style.color = '#ff3e3e';
                return;
            }
            
            const matchingPassword = passwords.find(p => p.password === password);
            
            if (matchingPassword) {
                const isAvailable = await checkPasswordAvailability(password);
                
                if (!isAvailable) {
                    showToast('Password already in use on another device', 'error');
                    passwordStatus.textContent = '✗ Password locked to another device';
                    passwordStatus.style.color = '#ff3e3e';
                    return;
                }
                
                devicePasswordData = {
                    password: password,
                    deviceId: deviceId,
                    storyName: matchingPassword.storyName,
                    timestamp: Date.now()
                };
                
                localStorage.setItem(CONFIG.PASSWORD_STORAGE_KEY, JSON.stringify(devicePasswordData));
                await recordPasswordUsage(password);
                
                if (matchingPassword.storyName) {
                    unlockedVideos.add(matchingPassword.storyName);
                    showToast(`Unlocked: ${matchingPassword.storyName}`, 'success');
                    updatePasswordIndicator(true, matchingPassword.storyName);
                } else {
                    videos.forEach(video => {
                        if (video.passwordType === 'password') {
                            unlockedVideos.add(video.id);
                        }
                    });
                    showToast('All videos unlocked', 'success');
                    updatePasswordIndicator(true, 'All Videos');
                }
                
                renderVideoList();
                passwordInput.value = '';
                passwordStatus.textContent = '✓ Access granted - Password locked to this device';
                passwordStatus.style.color = '#00ff00';
                logoutBtn.style.display = 'flex';
                
            } else {
                showToast('Invalid password', 'error');
                passwordStatus.textContent = '✗ Invalid password';
                passwordStatus.style.color = '#ff3e3e';
            }
        }

        async function checkPasswordAvailability(password) {
            try {
                const db = firebase.firestore();
                const usageRef = db.collection('passwordUsage').doc(password);
                const doc = await usageRef.get();
                
                if (doc.exists) {
                    const data = doc.data();
                    return !data.deviceId || data.deviceId === deviceId;
                }
                
                return true;
                
            } catch (error) {
                console.error('Error checking password availability:', error);
                return true;
            }
        }

        async function unlockCurrentVideo() {
            const password = videoPassword.value.trim();
            
            if (!password) {
                videoPasswordStatus.textContent = 'Enter password';
                videoPasswordStatus.style.color = '#ff3e3e';
                return;
            }
            
            if (!currentVideoToUnlock) {
                closeVideoPasswordModal();
                return;
            }
            
            const matchingPassword = passwords.find(p => 
                p.password === password && 
                (p.storyName === currentVideoToUnlock.storyName || !p.storyName)
            );
            
            if (matchingPassword) {
                const isAvailable = await checkPasswordAvailability(password);
                
                if (!isAvailable) {
                    videoPasswordStatus.textContent = 'Password locked to another device';
                    videoPasswordStatus.style.color = '#ff3e3e';
                    videoPassword.value = '';
                    videoPassword.focus();
                    return;
                }
                
                devicePasswordData = {
                    password: password,
                    deviceId: deviceId,
                    storyName: matchingPassword.storyName,
                    timestamp: Date.now()
                };
                
                localStorage.setItem(CONFIG.PASSWORD_STORAGE_KEY, JSON.stringify(devicePasswordData));
                await recordPasswordUsage(password);
                
                unlockedVideos.add(currentVideoToUnlock.id);
                closeVideoPasswordModal();
                playVideo(currentVideoToUnlock);
                renderVideoList();
                showToast('Video unlocked', 'success');
                
                updatePasswordIndicator(true, currentVideoToUnlock.storyName || currentVideoToUnlock.name);
                logoutBtn.style.display = 'flex';
                
            } else {
                videoPasswordStatus.textContent = 'Invalid password for this video';
                videoPasswordStatus.style.color = '#ff3e3e';
                videoPassword.value = '';
                videoPassword.focus();
            }
        }

        function updatePasswordIndicator(isUnlocked, name = '') {
            if (isUnlocked) {
                passwordIndicator.className = 'password-indicator';
                passwordIndicator.innerHTML = `<i class="fas fa-unlock"></i> <span>${name || 'Unlocked'}</span>`;
            } else {
                passwordIndicator.className = 'password-indicator locked';
                passwordIndicator.innerHTML = `<i class="fas fa-lock"></i> <span>Locked</span>`;
            }
        }

        // ==================== RENDER FUNCTIONS ====================
        function renderStoryList() {
            storyList.innerHTML = '';
            
            const allItem = document.createElement('div');
            allItem.className = `story-item ${!currentStory ? 'active' : ''}`;
            allItem.textContent = 'All Stories';
            allItem.addEventListener('click', () => {
                currentStory = null;
                renderVideoList();
                storiesMenu.classList.remove('active');
            });
            allItem.addEventListener('touchend', (e) => {
                e.preventDefault();
                currentStory = null;
                renderVideoList();
                storiesMenu.classList.remove('active');
            });
            storyList.appendChild(allItem);
            
            stories.forEach(story => {
                const storyItem = document.createElement('div');
                storyItem.className = `story-item ${currentStory === story ? 'active' : ''}`;
                storyItem.textContent = story;
                storyItem.addEventListener('click', () => {
                    currentStory = story;
                    renderVideoList();
                    storiesMenu.classList.remove('active');
                });
                storyItem.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    currentStory = story;
                    renderVideoList();
                    storiesMenu.classList.remove('active');
                });
                storyList.appendChild(storyItem);
            });
        }

        function renderVideoList() {
            videoList.innerHTML = '';
            
            if (videos.length === 0) {
                videoList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #8a93a7;">
                        <i class="fas fa-film" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>No videos available</div>
                    </div>
                `;
                return;
            }
            
            let videosToShow = videos;
            
            if (currentStory) {
                videosToShow = videos.filter(v => v.storyName === currentStory);
                backButton.style.display = 'flex';
            } else {
                backButton.style.display = 'none';
            }
            
            videosToShow = applySorting(videosToShow);
            
            videosToShow.forEach(video => {
                const isFree = video.passwordType === 'free';
                const isUnlocked = isFree || unlockedVideos.has(video.id) || 
                                 (video.storyName && unlockedVideos.has(video.storyName));
                const isCached = preloadedVideos.has(video.id);
                
                const videoItem = document.createElement('div');
                videoItem.className = `video-item ${!isUnlocked ? 'locked' : 'unlocked'} ${isFree ? 'free' : ''}`;
                
                let cacheIndicator = '';
                if (isCached) {
                    cacheIndicator = '<i class="fas fa-hdd" style="color: #00ff00; margin-left: 5px; font-size: 10px;"></i>';
                }
                
                videoItem.innerHTML = `
                    <div class="video-info">
                        <div class="video-name">${video.name}${cacheIndicator}</div>
                        <div class="video-meta">
                            ${video.type || 'Video'} ${video.storyName ? `• ${video.storyName}` : ''}
                        </div>
                    </div>
                    <div class="video-actions">
                        ${isFree ? '<span class="free-badge">FREE</span>' : ''}
                        <button class="action-btn play" data-action="play" data-id="${video.id}">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                `;
                
                videoList.appendChild(videoItem);
            });
        }

        function renderContactList() {
            contactList.innerHTML = '';
            
            if (contactLinks.length === 0) {
                contactList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #8a93a7;">
                        <i class="fas fa-link" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>No contact links available</div>
                    </div>
                `;
                return;
            }
            
            contactLinks.forEach(link => {
                const linkItem = document.createElement('div');
                linkItem.className = 'video-item';
                
                let icon = 'fa-link';
                let color = '#ff9900';
                
                switch(link.type) {
                    case 'facebook': icon = 'fa-facebook'; color = '#1877F2'; break;
                    case 'telegram': icon = 'fa-telegram'; color = '#0088cc'; break;
                    case 'viber': icon = 'fa-viber'; color = '#7360F2'; break;
                }
                
                linkItem.innerHTML = `
                    <div class="video-info">
                        <div class="video-name">${link.name}</div>
                        <div class="video-meta">${link.type.charAt(0).toUpperCase() + link.type.slice(1)}</div>
                    </div>
                    <a href="${link.url}" target="_blank" class="action-btn play" 
                       style="text-decoration: none; background: ${color};">
                        <i class="fab ${icon}"></i>
                    </a>
                `;
                
                contactList.appendChild(linkItem);
            });
        }

        // ==================== VIDEO FUNCTIONS ====================
        function playVideo(video) {
            try {
                showLoading('Loading video...');
                
                if (!navigator.onLine && !preloadedVideos.has(video.id)) {
                    hideLoading();
                    noInternetModal.style.display = 'flex';
                    return;
                }
                
                videoPlayer.pause();
                videoPlayer.currentTime = 0;
                
                defaultImage.style.display = 'none';
                videoPlayer.style.display = 'block';
                fullscreenBtn.style.display = 'block';
                
                if (preloadedVideos.has(video.id)) {
                    videoPlayer.src = video.url;
                    showToast('Playing from cache', 'info');
                } else {
                    videoPlayer.src = video.url;
                }
                
                videoPlayer.setAttribute('controlsList', 'nodownload noremoteplayback');
                videoPlayer.setAttribute('disablepictureinpicture', 'true');
                
                videoPlayer.load();
                adjustVideoQualityForNetwork();
                
                videoPlayer.oncanplay = () => {
                    hideLoading();
                    
                    setTimeout(() => {
                        videoPlayer.play().catch(e => {
                            console.log('Auto-play prevented:', e);
                            videoPlayer.controls = true;
                        });
                    }, 300);
                    
                    document.querySelectorAll('.video-item').forEach(item => {
                        item.classList.remove('playing');
                    });
                    
                    const currentItem = Array.from(document.querySelectorAll('.video-item')).find(item => {
                        const nameDiv = item.querySelector('.video-name');
                        return nameDiv && nameDiv.textContent.includes(video.name);
                    });
                    
                    if (currentItem) {
                        currentItem.classList.add('playing');
                    }
                };
                
                videoPlayer.onerror = () => {
                    hideLoading();
                    showToast('Error loading video', 'error');
                    defaultImage.style.display = 'flex';
                    videoPlayer.style.display = 'none';
                    fullscreenBtn.style.display = 'none';
                };
                
                lastPlayTime = Date.now();
                
            } catch (error) {
                hideLoading();
                showToast('Error playing video', 'error');
                console.error('Play video error:', error);
            }
        }

        function adjustVideoQualityForNetwork() {
            if (networkQuality === 'slow-2g' || networkQuality === '2g') {
                videoPlayer.preload = 'none';
                videoPlayer.playbackRate = 0.8;
            } else if (networkQuality === '3g') {
                videoPlayer.preload = 'metadata';
                videoPlayer.playbackRate = 1.0;
            } else {
                videoPlayer.preload = 'auto';
                videoPlayer.playbackRate = 1.0;
            }
        }

        // ==================== MODAL FUNCTIONS ====================
        function showVideoPasswordModal() {
            videoPasswordModal.style.display = 'flex';
            videoPassword.value = '';
            videoPasswordStatus.textContent = '';
            videoPassword.focus();
            
            setTimeout(() => {
                if (videoPassword.scrollIntoViewIfNeeded) {
                    videoPassword.scrollIntoViewIfNeeded();
                }
            }, 100);
        }

        function closeVideoPasswordModal() {
            videoPasswordModal.style.display = 'none';
            videoPassword.value = '';
            videoPasswordStatus.textContent = '';
            currentVideoToUnlock = null;
        }

        // ==================== SCREEN NAVIGATION ====================
        function showScreen(screenNumber) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(`screen${screenNumber}`).classList.add('active');
            
            if (!videoPlayer.paused) {
                videoPlayer.pause();
            }
            
            videoPasswordModal.style.display = 'none';
            noInternetModal.style.display = 'none';
            storageModal.style.display = 'none';
            
            fullscreenBtn.style.display = 'none';
            collapsePasswordSection();
            window.scrollTo(0, 0);
            
            if (document.activeElement && document.activeElement.blur) {
                document.activeElement.blur();
            }
        }

        function handleBackButton() {
            if (currentStory) {
                currentStory = null;
                renderVideoList();
            }
        }

        // ==================== FULL SCREEN FUNCTIONS ====================
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                if (videoPlayer.requestFullscreen) {
                    videoPlayer.requestFullscreen();
                } else if (videoPlayer.webkitRequestFullscreen) {
                    videoPlayer.webkitRequestFullscreen();
                } else if (videoPlayer.mozRequestFullScreen) {
                    videoPlayer.mozRequestFullScreen();
                } else if (videoPlayer.msRequestFullscreen) {
                    videoPlayer.msRequestFullscreen();
                }
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
        }

        function handleFullScreenChange() {
            if (!document.fullscreenElement && !document.webkitIsFullScreen && !document.mozFullScreen && !document.msFullscreenElement) {
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
        }

        // ==================== NETWORK FUNCTIONS ====================
        function updateConnectionStatus() {
            isOnline = navigator.onLine;
            
            if (isOnline) {
                connectionStatus.className = 'connection-status';
                connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> Online';
                offlineIndicator.style.display = 'none';
            } else {
                connectionStatus.className = 'connection-status offline';
                connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline';
                offlineIndicator.style.display = 'block';
            }
        }

        // ==================== UI FEEDBACK FUNCTIONS ====================
        function showToast(message, type = 'info') {
            const icon = type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        'fa-info-circle';
            
            const color = type === 'success' ? '#00ff00' :
                         type === 'error' ? '#ff3e3e' : '#ff9900';
            
            toast.innerHTML = `<i class="fas ${icon}" style="color: ${color};"></i> ${message}`;
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function showLoading(text = 'Loading...') {
            loadingText.textContent = text;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function loadCustomImage() {
            appImage.onload = function() {
                appImage.style.display = 'block';
                defaultImage.querySelector('div').style.display = 'none';
            };
            appImage.onerror = function() {
                appImage.style.display = 'none';
                defaultImage.querySelector('div').style.display = 'block';
            };
            appImage.src = CONFIG.CUSTOM_IMAGE_URL;
        }

        // ==================== MEMORY MANAGEMENT ====================
        function clearVideoCache() {
            if (videoPlayer.src) {
                videoPlayer.src = '';
                videoPlayer.load();
            }
            
            if (videoPlayer.src && videoPlayer.src.startsWith('blob:')) {
                URL.revokeObjectURL(videoPlayer.src);
            }
        }

        // ==================== CLEANUP OLD CACHE ====================
        function cleanupExpiredCache() {
            const now = Date.now();
            const expiryTime = CONFIG.CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('video_cache_')) {
                    try {
                        const cacheData = JSON.parse(localStorage.getItem(key));
                        if (now - cacheData.timestamp > expiryTime) {
                            localStorage.removeItem(key);
                            preloadedVideos.delete(cacheData.id);
                            delete cachedVideos[cacheData.id];
                        }
                    } catch (error) {
                        localStorage.removeItem(key);
                    }
                }
            }
            
            updateStorageInfo();
        }

        // ==================== INITIALIZE APP ====================
        document.addEventListener('DOMContentLoaded', () => {
            document.body.style.overflow = 'auto';
            document.body.style.height = '100%';
            
            if (navigator.userAgent.toLowerCase().indexOf('android') > -1) {
                document.body.classList.add('android-optimized');
                
                document.querySelectorAll('.video-item, .story-item').forEach(el => {
                    el.style.transition = 'transform 0.1s ease';
                });
                
                document.body.style.overflowScrolling = 'touch';
                document.body.style.webkitOverflowScrolling = 'touch';
                
                try {
                    if (typeof window.requestFileSystem !== 'undefined' || 
                        typeof window.webkitRequestFileSystem !== 'undefined') {
                        selectSDCard.style.display = 'flex';
                    }
                } catch (error) {
                    console.log('SD card not available');
                }
            }
            
            cleanupExpiredCache();
            initApp();
            
            document.body.style.overscrollBehavior = 'none';
            
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    if (document.activeElement && document.activeElement.blur) {
                        document.activeElement.blur();
                    }
                }, 100);
            });
            
            window.addEventListener('beforeunload', function() {
                clearVideoCache();
            });
            
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    clearVideoCache();
                }
            });
        });

        document.addEventListener('backbutton', function(e) {
            e.preventDefault();
            if (currentStory) {
                currentStory = null;
                renderVideoList();
            } else if (videoPasswordModal.style.display === 'flex') {
                closeVideoPasswordModal();
            } else if (noInternetModal.style.display === 'flex') {
                noInternetModal.style.display = 'none';
            } else if (passwordResetModal.style.display === 'flex') {
                passwordResetModal.style.display = 'none';
            } else if (storageModal.style.display === 'flex') {
                storageModal.style.display = 'none';
            } else if (preloadProgressEl.style.display === 'block') {
                preloadProgressEl.style.display = 'none';
            } else {
                if (document.getElementById('screen2').classList.contains('active')) {
                    showScreen(1);
                }
            }
        }, false);
        
        // PWA: Add to home screen prompt
        function setupPasswordSectionHover() {
            passwordSection.addEventListener('mouseenter', () => {
                clearTimeout(passwordSectionHoverTimer);
                expandPasswordSection();
            });

            passwordSection.addEventListener('mouseleave', () => {
                passwordSectionHoverTimer = setTimeout(() => {
                    collapsePasswordSection();
                }, 6000);
            });

            passwordSection.addEventListener('touchstart', (e) => {
                e.preventDefault();
                clearTimeout(passwordSectionHoverTimer);
                expandPasswordSection();
            });

            passwordSection.addEventListener('touchend', (e) => {
                e.preventDefault();
            });

            document.addEventListener('touchstart', (e) => {
                if (!passwordSection.contains(e.target)) {
                    collapsePasswordSection();
                }
            });
        }

        function expandPasswordSection() {
            passwordSectionExpanded = true;
            passwordSection.classList.add('expanded');
            setTimeout(() => {
                passwordInput.focus();
            }, 300);
        }

        function collapsePasswordSection() {
            passwordSectionExpanded = false;
            passwordSection.classList.remove('expanded');
        }

        // Network quality monitoring
        function monitorNetworkQuality() {
            if ('connection' in navigator) {
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                
                if (connection) {
                    networkQuality = connection.effectiveType || 'unknown';
                    console.log('Network quality:', networkQuality);
                    
                    adjustForNetworkQuality();
                    
                    connection.addEventListener('change', function() {
                        networkQuality = connection.effectiveType;
                        console.log('Network changed to:', networkQuality);
                        adjustForNetworkQuality();
                        showToast(`Network: ${networkQuality}`, 'info');
                    });
                }
            }
        }

        function adjustForNetworkQuality() {
            switch(networkQuality) {
                case 'slow-2g':
                case '2g':
                    videoPlayer.preload = 'none';
                    setVideoQuality('360p');
                    break;
                case '3g':
                    videoPlayer.preload = 'metadata';
                    setVideoQuality('480p');
                    break;
                case '4g':
                default:
                    videoPlayer.preload = 'auto';
                    setVideoQuality('auto');
                    break;
            }
        }

        function setVideoQuality(quality) {
            currentQuality = quality;
            
            qualityButtons.forEach(btn => {
                if (btn.getAttribute('data-quality') === quality) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            switch(quality) {
                case '360p':
                    videoPlayer.playbackRate = 1.0;
                    videoPlayer.defaultPlaybackRate = 1.0;
                    break;
                case '480p':
                    videoPlayer.playbackRate = 1.0;
                    videoPlayer.defaultPlaybackRate = 1.0;
                    break;
                case 'auto':
                    if (networkQuality === 'slow-2g' || networkQuality === '2g') {
                        videoPlayer.playbackRate = 0.8;
                    } else {
                        videoPlayer.playbackRate = 1.0;
                    }
                    break;
            }
            
            showToast(`Quality set to ${quality}`, 'info');
        }
    </script>
</body>
</html>